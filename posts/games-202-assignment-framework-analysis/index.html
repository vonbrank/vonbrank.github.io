<!DOCTYPE html><html class="transition bg-[var(--page-bg)] md:text-[16px] text-[14px]" data-astro-cid-sckkx6r4 data-overlayscrollbars-initialize lang=zh-CN style=--bannerOffset:15vh;--banner-height-home:65vh;--banner-height:35vh;--configHue:250;--page-width:75rem><head><title>GAMES 202 作业代码框架剖析 - VonBrank</title><meta charset=UTF-8><meta content="GAMES 202 作业代码框架剖析 - VonBrank" name=description><meta content="Von Brank" name=author><meta content=VonBrank property=og:site_name><meta content=https://blog.vonbrank.com/posts/games-202-assignment-framework-analysis/ property=og:url><meta content="GAMES 202 作业代码框架剖析 - VonBrank" property=og:title><meta content="GAMES 202 作业代码框架剖析 - VonBrank" property=og:description><meta content=article property=og:type><meta content=summary_large_image name=twitter:card><meta content=https://blog.vonbrank.com/posts/games-202-assignment-framework-analysis/ property=twitter:url><meta content="GAMES 202 作业代码框架剖析 - VonBrank" name=twitter:title><meta content="GAMES 202 作业代码框架剖析 - VonBrank" name=twitter:description><meta content="width=device-width" name=viewport><meta content="Astro v5.1.6" name=generator><link href=https://vonbrank-images.oss-cn-hangzhou.aliyuncs.com/20230826-Blog-Image/system/vonbrank-profile.jpg rel=icon><script>!function(){switch(localStorage.getItem("theme")||"auto"){case"light":document.documentElement.classList.remove("dark");break;case"dark":document.documentElement.classList.add("dark");break;case"auto":window.matchMedia("(prefers-color-scheme: dark)").matches?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark")}const e=localStorage.getItem("hue")||250;document.documentElement.style.setProperty("--hue",e);let t=Math.floor(.3*window.innerHeight);t-=t%4,document.documentElement.style.setProperty("--banner-height-extend",`${t}px`)}()</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"GAMES 202 作业代码框架剖析","description":"GAMES 202 作业代码框架剖析","keywords":["教程","计算机图形学"],"author":{"@type":"Person","name":"Von Brank","url":"https://blog.vonbrank.com/"},"datePublished":"2023-08-23","inLanguage":"zh-CN"}</script><link href=https://blog.vonbrank.com/rss.xml rel=alternate title="Von Brank" type=application/rss+xml><link href=/_astro/Layout.BGTS0f8r.css rel=stylesheet><link href=/_astro/Layout.DSulWsr7.css rel=stylesheet><link href=/_astro/_page_.CXI33z7T.css rel=stylesheet><link href=/_astro/about.CrjVxwwl.css rel=stylesheet><link href=/_astro/_page_.DpIcdzgv.css rel=stylesheet><style>input.svelte-1gu5h8y:focus{outline:0}#display-setting.svelte-1s19bex input[type=range]:where(.svelte-1s19bex){-webkit-appearance:none;height:1.5rem;background-image:var(--color-selection-bar);transition:background-image .15s ease-in-out}#display-setting.svelte-1s19bex input[type=range]:where(.svelte-1s19bex)::-webkit-slider-thumb{-webkit-appearance:none;height:1rem;width:.5rem;border-radius:.125rem;background:#ffffffb3;box-shadow:none}#display-setting.svelte-1s19bex input[type=range]:where(.svelte-1s19bex)::-webkit-slider-thumb:hover{background:#fffc}#display-setting.svelte-1s19bex input[type=range]:where(.svelte-1s19bex)::-webkit-slider-thumb:active{background:#fff9}#display-setting.svelte-1s19bex input[type=range]:where(.svelte-1s19bex)::-moz-range-thumb{-webkit-appearance:none;height:1rem;width:.5rem;border-radius:.125rem;border-width:0;background:#ffffffb3;box-shadow:none}#display-setting.svelte-1s19bex input[type=range]:where(.svelte-1s19bex)::-moz-range-thumb:hover{background:#fffc}#display-setting.svelte-1s19bex input[type=range]:where(.svelte-1s19bex)::-moz-range-thumb:active{background:#fff9}#display-setting.svelte-1s19bex input[type=range]:where(.svelte-1s19bex)::-ms-thumb{-webkit-appearance:none;height:1rem;width:.5rem;border-radius:.125rem;background:#ffffffb3;box-shadow:none}#display-setting.svelte-1s19bex input[type=range]:where(.svelte-1s19bex)::-ms-thumb:hover{background:#fffc}#display-setting.svelte-1s19bex input[type=range]:where(.svelte-1s19bex)::-ms-thumb:active{background:#fff9}</style><script type=module src=/_astro/page.DG34Aup6.js></script></head><body class="transition enable-banner min-h-screen" data-astro-cid-sckkx6r4 data-overlayscrollbars-initialize style=--bannerOffset:15vh;--banner-height-home:65vh;--banner-height:35vh;--configHue:250;--page-width:75rem><div id=config-carrier data-hue=250></div><div class="transition-all duration-700 max-w-[var(--page-width)] md:px-4 mx-auto pointer-events-none px-0 relative z-50" id=top-row><div class="transition-all pointer-events-auto sticky top-0" id=navbar-wrapper><div class="onload-animation z-50" id=navbar><div class="transition absolute -top-8 bg-[var(--card-bg)] h-8 left-0 right-0"></div><div class="flex items-center justify-between !overflow-visible !rounded-t-none card-base h-[4.5rem] max-w-[var(--page-width)] mx-auto px-4"><a href=/ class="rounded-lg btn-plain scale-animation active:scale-95 font-bold px-5 h-[3.25rem]"><div class="flex items-center flex-row text-[var(--primary)] text-md"><svg data-icon=material-symbols:home-outline-rounded height=1em width=1em class="text-[1.75rem] mb-1 mr-2"><symbol id=ai:material-symbols:home-outline-rounded viewBox="0 0 24 24"><path d="M6 19h3v-5q0-.425.288-.712T10 13h4q.425 0 .713.288T15 14v5h3v-9l-6-4.5L6 10zm-2 0v-9q0-.475.213-.9t.587-.7l6-4.5q.525-.4 1.2-.4t1.2.4l6 4.5q.375.275.588.7T20 10v9q0 .825-.588 1.413T18 21h-4q-.425 0-.712-.288T13 20v-5h-2v5q0 .425-.288.713T10 21H6q-.825 0-1.412-.587T4 19m8-6.75" fill=currentColor /></symbol><use href=#ai:material-symbols:home-outline-rounded></use></svg> VonBrank</div></a><div class="hidden md:flex"><a href=/ class="rounded-lg btn-plain scale-animation active:scale-95 font-bold px-5 h-11" aria-label=主页><div class="flex items-center">主页</div></a><a href=/archive/ class="rounded-lg btn-plain scale-animation active:scale-95 font-bold px-5 h-11" aria-label=归档><div class="flex items-center">归档</div></a><a href=/about/ class="rounded-lg btn-plain scale-animation active:scale-95 font-bold px-5 h-11" aria-label=关于><div class="flex items-center">关于</div></a><a href=https://github.com/vonbrank class="rounded-lg btn-plain scale-animation active:scale-95 font-bold px-5 h-11" aria-label=GitHub target=_blank><div class="flex items-center">GitHub <svg data-icon=fa6-solid:arrow-up-right-from-square height=1em width=1em class="transition -translate-y-[1px] dark:text-white/[0.2] ml-1 text-[0.875rem] text-black/[0.2]" viewBox="0 0 512 512"><use href=#ai:fa6-solid:arrow-up-right-from-square></use></svg></div></a></div><div class=flex><style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(self.Astro||(self.Astro={})).only=async t=>{await(await t())()},window.dispatchEvent(new Event("astro:only")),(()=>{var t=Object.defineProperty,e=(e,r,n)=>((e,r,n)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n)(e,"symbol"!=typeof r?r+"":r,n);{let t={0:t=>s(t),1:t=>n(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(n(t)),5:t=>new Set(n(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t),11:t=>1/0*t},r=e=>{let[r,n]=e;return r in t?t[r](n):void 0},n=t=>t.map(r),s=t=>"object"!=typeof t||null===t?t:Object.fromEntries(Object.entries(t).map((([t,e])=>[t,r(e)])));class i extends HTMLElement{constructor(){super(...arguments),e(this,"Component"),e(this,"hydrator"),e(this,"hydrate",(async()=>{var t;if(!this.hydrator||!this.isConnected)return;let e=null==(t=this.parentElement)?void 0:t.closest("astro-island[ssr]");if(e)return void e.addEventListener("astro:hydrate",this.hydrate,{once:!0});let r,n=this.querySelectorAll("astro-slot"),i={},o=this.querySelectorAll("template[data-astro-template]");for(let t of o){let e=t.closest(this.tagName);null!=e&&e.isSameNode(this)&&(i[t.getAttribute("data-astro-template")||"default"]=t.innerHTML,t.remove())}for(let t of n){let e=t.closest(this.tagName);null!=e&&e.isSameNode(this)&&(i[t.getAttribute("name")||"default"]=t.innerHTML)}try{r=this.hasAttribute("props")?s(JSON.parse(this.getAttribute("props"))):{}}catch(t){let e=this.getAttribute("component-url")||"<unknown>",r=this.getAttribute("component-export");throw r&&(e+=` (export ${r})`),console.error(`[hydrate] Error parsing props for component ${e}`,this.getAttribute("props"),t),t}await this.hydrator(this)(this.Component,r,i,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))})),e(this,"unmount",(()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))}))}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(this.hasAttribute("await-children")&&"interactive"!==document.readyState&&"complete"!==document.readyState){let t=()=>{document.removeEventListener("DOMContentLoaded",t),e.disconnect(),this.childrenConnectedCallback()},e=new MutationObserver((()=>{var e;(null==(e=this.lastChild)?void 0:e.nodeType)===Node.COMMENT_NODE&&"astro:end"===this.lastChild.nodeValue&&(this.lastChild.remove(),t())}));e.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",t)}else this.childrenConnectedCallback()}async childrenConnectedCallback(){let t=this.getAttribute("before-hydration-url");t&&await import(t),this.start()}async start(){let t=JSON.parse(this.getAttribute("opts")),e=this.getAttribute("client");if(void 0!==Astro[e])try{await Astro[e]((async()=>{let t=this.getAttribute("renderer-url"),[e,{default:r}]=await Promise.all([import(this.getAttribute("component-url")),t?import(t):()=>()=>{}]),n=this.getAttribute("component-export")||"default";if(n.includes(".")){this.Component=e;for(let t of n.split("."))this.Component=this.Component[t]}else this.Component=e[n];return this.hydrator=r,this.hydrate}),t,this)}catch(t){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,t)}else window.addEventListener(`astro:${e}`,(()=>this.start()),{once:!0})}attributeChangedCallback(){this.hydrate()}}e(i,"observedAttributes",["props"]),customElements.get("astro-island")||customElements.define("astro-island",i)}})()</script><astro-island client=only component-export=default component-url=/_astro/Search.Bq1ZYY5V.js opts={&quot;name&quot;:&quot;Search&quot;,&quot;value&quot;:&quot;svelte&quot;} props={} renderer-url=/_astro/client.svelte.CHuJF3Sl.js ssr uid=ZQltPq></astro-island><button class="rounded-lg btn-plain scale-animation h-11 active:scale-90 w-11" aria-label="Display Settings" id=display-settings-switch><svg data-icon=material-symbols:palette-outline height=1em width=1em class=text-[1.25rem]><symbol id=ai:material-symbols:palette-outline viewBox="0 0 24 24"><path d="M12 22q-2.05 0-3.875-.788t-3.187-2.15t-2.15-3.187T2 12q0-2.075.813-3.9t2.2-3.175T8.25 2.788T12.2 2q2 0 3.775.688t3.113 1.9t2.125 2.875T22 11.05q0 2.875-1.75 4.413T16 17h-1.85q-.225 0-.312.125t-.088.275q0 .3.375.863t.375 1.287q0 1.25-.687 1.85T12 22m-5.5-9q.65 0 1.075-.425T8 11.5t-.425-1.075T6.5 10t-1.075.425T5 11.5t.425 1.075T6.5 13m3-4q.65 0 1.075-.425T11 7.5t-.425-1.075T9.5 6t-1.075.425T8 7.5t.425 1.075T9.5 9m5 0q.65 0 1.075-.425T16 7.5t-.425-1.075T14.5 6t-1.075.425T13 7.5t.425 1.075T14.5 9m3 4q.65 0 1.075-.425T19 11.5t-.425-1.075T17.5 10t-1.075.425T16 11.5t.425 1.075T17.5 13M12 20q.225 0 .363-.125t.137-.325q0-.35-.375-.825T11.75 17.3q0-1.05.725-1.675T14.25 15H16q1.65 0 2.825-.962T20 11.05q0-3.025-2.312-5.038T12.2 4Q8.8 4 6.4 6.325T4 12q0 3.325 2.338 5.663T12 20" fill=currentColor /></symbol><use href=#ai:material-symbols:palette-outline></use></svg></button><script>(self.Astro||(self.Astro={})).load=async a=>{await(await a())()},window.dispatchEvent(new Event("astro:load"))</script><astro-island client=load component-export=default component-url=/_astro/LightDarkSwitch.Boq4IYiz.js opts={&quot;name&quot;:&quot;LightDarkSwitch&quot;,&quot;value&quot;:true} props={} renderer-url=/_astro/client.svelte.CHuJF3Sl.js ssr uid=dR4r1 await-children><!--[--><div class="relative z-50" role=menu tabindex=-1><button class="rounded-lg btn-plain scale-animation h-11 active:scale-90 w-11 relative" aria-label="Light/Dark Mode" id=scheme-switch role=menuitem><div class="absolute opacity-0"><!--[!--><!--]--></div><div class="absolute opacity-0"><!--[!--><!--]--></div><div class=absolute><!--[!--><!--]--></div></button><div class="transition absolute hidden lg:block -right-2 float-panel-closed pt-5 top-11" id=light-dark-panel><div class="card-base float-panel p-2"><button class="transition flex items-center rounded-lg !justify-start active:scale-95 btn-plain font-medium h-9 px-3 scale-animation w-full whitespace-nowrap mb-0.5"><!--[!--><!--]-->亮色</button> <button class="transition flex items-center rounded-lg !justify-start active:scale-95 btn-plain font-medium h-9 px-3 scale-animation w-full whitespace-nowrap mb-0.5"><!--[!--><!--]-->暗色</button> <button class="transition flex items-center rounded-lg !justify-start active:scale-95 btn-plain font-medium h-9 px-3 scale-animation w-full whitespace-nowrap current-theme-btn"><!--[!--><!--]-->跟随系统</button></div></div></div><!--]--><!--astro:end--></astro-island><button class="rounded-lg btn-plain scale-animation h-11 active:scale-90 w-11 md:!hidden" aria-label=Menu id=nav-menu-switch name="Nav Menu"><svg data-icon=material-symbols:menu-rounded height=1em width=1em class=text-[1.25rem]><symbol id=ai:material-symbols:menu-rounded viewBox="0 0 24 24"><path d="M4 18q-.425 0-.712-.288T3 17t.288-.712T4 16h16q.425 0 .713.288T21 17t-.288.713T20 18zm0-5q-.425 0-.712-.288T3 12t.288-.712T4 11h16q.425 0 .713.288T21 12t-.288.713T20 13zm0-5q-.425 0-.712-.288T3 7t.288-.712T4 6h16q.425 0 .713.288T21 7t-.288.713T20 8z" fill=currentColor /></symbol><use href=#ai:material-symbols:menu-rounded></use></svg></button></div><div class="transition-all absolute right-4 fixed float-panel float-panel-closed px-2 py-2" id=nav-menu-panel><a href=/ class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">主页</div><svg data-icon=material-symbols:chevron-right-rounded height=1em width=1em class="transition text-[var(--primary)] text-[1.25rem]"><symbol id=ai:material-symbols:chevron-right-rounded viewBox="0 0 24 24"><path d="M12.6 12L8.7 8.1q-.275-.275-.275-.7t.275-.7t.7-.275t.7.275l4.6 4.6q.15.15.213.325t.062.375t-.062.375t-.213.325l-4.6 4.6q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7z" fill=currentColor /></symbol><use href=#ai:material-symbols:chevron-right-rounded></use></svg> </a><a href=/archive/ class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">归档</div><svg data-icon=material-symbols:chevron-right-rounded height=1em width=1em class="transition text-[var(--primary)] text-[1.25rem]" viewBox="0 0 24 24"><use href=#ai:material-symbols:chevron-right-rounded></use></svg> </a><a href=/about/ class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2"><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">关于</div><svg data-icon=material-symbols:chevron-right-rounded height=1em width=1em class="transition text-[var(--primary)] text-[1.25rem]" viewBox="0 0 24 24"><use href=#ai:material-symbols:chevron-right-rounded></use></svg> </a><a href=https://github.com/vonbrank class="transition flex items-center rounded-lg active:bg-[var(--btn-plain-bg-active)] gap-8 group hover:bg-[var(--btn-plain-bg-hover)] justify-between pl-3 pr-1 py-2" target=_blank><div class="transition font-bold dark:text-white/75 text-black/75 group-active:text-[var(--primary)] group-hover:text-[var(--primary)]">GitHub</div><svg data-icon=fa6-solid:arrow-up-right-from-square height=1em width=1em class="transition -translate-x-1 dark:text-white/25 text-[0.75rem] text-black/25" viewBox="0 0 512 512"><use href=#ai:fa6-solid:arrow-up-right-from-square></use></svg></a></div><astro-island client=only component-export=default component-url=/_astro/DisplaySettings.CZJ1UOdP.js opts={&quot;name&quot;:&quot;DisplaySettings&quot;,&quot;value&quot;:&quot;svelte&quot;} props={} renderer-url=/_astro/client.svelte.CHuJF3Sl.js ssr uid=Z1vqlbT></astro-island></div></div><script type=module>function c(){"dark"===localStorage.theme?(document.documentElement.classList.remove("dark"),localStorage.theme="light"):(document.documentElement.classList.add("dark"),localStorage.theme="dark")}function i(){let e=document.getElementById("scheme-switch");e&&e.addEventListener("click",(function(){c()}));let t=document.getElementById("display-settings-switch");t&&t.addEventListener("click",(function(){let e=document.getElementById("display-setting");e&&e.classList.toggle("float-panel-closed")}));let n=document.getElementById("nav-menu-switch");n&&n.addEventListener("click",(function(){let e=document.getElementById("nav-menu-panel");e&&e.classList.toggle("float-panel-closed")}))}i()</script><script>!async function(){const i=await import("/pagefind/pagefind.js");await i.options({excerptLength:20}),i.init(),window.pagefind=i,i.search("")}()</script></div></div><div class="transition w-full absolute duration-700 overflow-hidden z-10" id=banner-wrapper style=top:-30vh><div class="transition overflow-hidden duration-700 h-full object-cover opacity-0 relative scale-105" id=banner><div class="transition absolute pointer-events-none bg-opacity-50 dark:bg-black/10 inset-0"></div><img alt="Banner image of the blog" src=https://vonbrank-images.oss-cn-hangzhou.aliyuncs.com/20230826-Blog-Image/system/hero-img.jpg class="h-full w-full object-cover" style=object-position:center></div></div><div class="z-30 absolute pointer-events-none w-full" style="top:calc(35vh - 3.5rem)"><div class="mx-auto relative max-w-[var(--page-width)] pointer-events-auto"><div class="transition w-full duration-700 gap-4 grid grid-cols-[17.5rem_auto] grid-rows-[auto_1fr_auto] left-0 lg:grid-rows-[auto] md:px-4 mx-auto px-0 right-0" id=main-grid><a href class="flex items-center justify-center absolute -top-[3.25rem] bg-black/60 group h-9 hover:bg-black/70 onload-animation px-3 right-4 rounded-full transition-all" aria-label="Visit image source" target=_blank rel=noopener id=banner-credit><svg data-icon=material-symbols:copyright-outline-rounded height=1em width=1em class="text-white/75 mr-1 text-[1.25rem]"><symbol id=ai:material-symbols:copyright-outline-rounded viewBox="0 0 24 24"><path d="M12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12t-2.325-5.675T12 4T6.325 6.325T4 12t2.325 5.675T12 20m-2-4h4q.425 0 .713-.288T15 15v-1q0-.425-.288-.712T14 13t-.712.288T13 14h-2v-4h2q0 .425.288.713T14 11t.713-.288T15 10V9q0-.425-.288-.712T14 8h-4q-.425 0-.712.288T9 9v6q0 .425.288.713T10 16" fill=currentColor /></symbol><use href=#ai:material-symbols:copyright-outline-rounded></use></svg><div class="text-white/75 text-xs">NVIDIA RTX wallpaper</div><svg data-icon=fa6-solid:arrow-up-right-from-square height=1em width=1em class="transition absolute opacity-0 right-4 text-[0.75rem] text-[oklch(0.75_0.14_var(--hue))]"><symbol id=ai:fa6-solid:arrow-up-right-from-square viewBox="0 0 512 512"><path d="M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32h82.7L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3V192c0 17.7 14.3 32 32 32s32-14.3 32-32V32c0-17.7-14.3-32-32-32zM80 32C35.8 32 0 67.8 0 112v320c0 44.2 35.8 80 80 80h320c44.2 0 80-35.8 80-80V320c0-17.7-14.3-32-32-32s-32 14.3-32 32v112c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16V112c0-8.8 7.2-16 16-16h112c17.7 0 32-14.3 32-32s-14.3-32-32-32z" fill=currentColor /></symbol><use href=#ai:fa6-solid:arrow-up-right-from-square></use></svg></a><div class="onload-animation col-span-2 lg:col-span-1 lg:max-w-[17.5rem] lg:row-end-2 lg:row-start-1 mb-4 row-end-3 row-start-2 w-full" id=sidebar><div class="flex w-full flex-col gap-4 mb-4"><div class="card-base p-3"><a href=/about/ class="overflow-hidden relative rounded-xl active:scale-95 block group lg:max-w-none lg:mt-0 lg:mx-0 max-w-[12rem] mb-3 mt-1 mx-auto" aria-label="Go to About Page"><div class="transition flex items-center justify-center absolute group-active:bg-black/50 group-hover:bg-black/30 h-full pointer-events-none w-full z-50"><svg data-icon=fa6-regular:address-card height=1em width=1.13em class="transition opacity-0 group-hover:opacity-100 group-hover:scale-100 scale-90 text-5xl text-white"><symbol id=ai:fa6-regular:address-card viewBox="0 0 576 512"><path d="M512 80c8.8 0 16 7.2 16 16v320c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V96c0-8.8 7.2-16 16-16zM64 32C28.7 32 0 60.7 0 96v320c0 35.3 28.7 64 64 64h448c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64zm144 224a64 64 0 1 0 0-128a64 64 0 1 0 0 128m-32 32c-44.2 0-80 35.8-80 80c0 8.8 7.2 16 16 16h192c8.8 0 16-7.2 16-16c0-44.2-35.8-80-80-80zm200-144c-13.3 0-24 10.7-24 24s10.7 24 24 24h80c13.3 0 24-10.7 24-24s-10.7-24-24-24zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24h80c13.3 0 24-10.7 24-24s-10.7-24-24-24z" fill=currentColor /></symbol><use href=#ai:fa6-regular:address-card></use></svg></div><div class="overflow-hidden relative h-full lg:mt-0 lg:w-full mx-auto"><div class="transition absolute pointer-events-none bg-opacity-50 dark:bg-black/10 inset-0"></div><img alt="Profile Image of the Author" src=https://vonbrank-images.oss-cn-hangzhou.aliyuncs.com/20230826-Blog-Image/system/vonbrank-profile.jpg class="h-full w-full object-cover" style=object-position:center></div></a><div class=px-2><div class="transition font-bold dark:text-neutral-50 mb-1 text-center text-xl">Von Brank</div><div class="transition mb-2 bg-[var(--primary)] h-1 mx-auto rounded-full w-5"></div><div class="transition text-center mb-2.5 text-neutral-400">Video game developer, B.Eng., likes coding, video editing, designing, gaming, and more.</div><div class="flex justify-center gap-2 mb-1"><a href=https://twitter.com/Von_Brank class="rounded-lg btn-regular active:scale-90 h-10 w-10" aria-label=Twitter target=_blank rel=me><svg data-icon=fa6-brands:twitter height=1em width=1em class=text-[1.5rem]><symbol id=ai:fa6-brands:twitter viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645c0 138.72-105.583 298.558-298.558 298.558c-59.452 0-114.68-17.219-161.137-47.106c8.447.974 16.568 1.299 25.34 1.299c49.055 0 94.213-16.568 130.274-44.832c-46.132-.975-84.792-31.188-98.112-72.772c6.498.974 12.995 1.624 19.818 1.624c9.421 0 18.843-1.3 27.614-3.573c-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319c-28.264-18.843-46.781-51.005-46.781-87.391c0-19.492 5.197-37.36 14.294-52.954c51.655 63.675 129.3 105.258 216.365 109.807c-1.624-7.797-2.599-15.918-2.599-24.04c0-57.828 46.782-104.934 104.934-104.934c30.213 0 57.502 12.67 76.67 33.137c23.715-4.548 46.456-13.32 66.599-25.34c-7.798 24.366-24.366 44.833-46.132 57.827c21.117-2.273 41.584-8.122 60.426-16.243c-14.292 20.791-32.161 39.308-52.628 54.253" fill=currentColor /></symbol><use href=#ai:fa6-brands:twitter></use></svg> </a><a href=https://steamcommunity.com/id/vonbrank class="rounded-lg btn-regular active:scale-90 h-10 w-10" aria-label=Steam target=_blank rel=me><svg data-icon=fa6-brands:steam height=1em width=0.97em class=text-[1.5rem]><symbol id=ai:fa6-brands:steam viewBox="0 0 496 512"><path d="M496 256c0 137-111.2 248-248.4 248c-113.8 0-209.6-76.3-239-180.4l95.2 39.3c6.4 32.1 34.9 56.4 68.9 56.4c39.2 0 71.9-32.4 70.2-73.5l84.5-60.2c52.1 1.3 95.8-40.9 95.8-93.5c0-51.6-42-93.5-93.7-93.5s-93.7 42-93.7 93.5v1.2L176.6 279c-15.5-.9-30.7 3.4-43.5 12.1L0 236.1C10.2 108.4 117.1 8 247.6 8C384.8 8 496 119 496 256M155.7 384.3l-30.5-12.6a52.8 52.8 0 0 0 27.2 25.8c26.9 11.2 57.8-1.6 69-28.4c5.4-13 5.5-27.3.1-40.3S206 305.6 193 300.2c-12.9-5.4-26.7-5.2-38.9-.6l31.5 13c19.8 8.2 29.2 30.9 20.9 50.7c-8.3 19.9-31 29.2-50.8 21m173.8-129.9c-34.4 0-62.4-28-62.4-62.3s28-62.3 62.4-62.3s62.4 28 62.4 62.3s-27.9 62.3-62.4 62.3m.1-15.6c25.9 0 46.9-21 46.9-46.8c0-25.9-21-46.8-46.9-46.8s-46.9 21-46.9 46.8c.1 25.8 21.1 46.8 46.9 46.8" fill=currentColor /></symbol><use href=#ai:fa6-brands:steam></use></svg> </a><a href=mailto:vonbrank@outlook.com class="rounded-lg btn-regular active:scale-90 h-10 w-10" aria-label=Email target=_blank rel=me><svg data-icon=material-symbols:mail height=1em width=1em class=text-[1.5rem]><symbol id=ai:material-symbols:mail viewBox="0 0 24 24"><path d="M4 20q-.825 0-1.412-.587T2 18V6q0-.825.588-1.412T4 4h16q.825 0 1.413.588T22 6v12q0 .825-.587 1.413T20 20zm8-7l8-5V6l-8 5l-8-5v2z" fill=currentColor /></symbol><use href=#ai:material-symbols:mail></use></svg> </a><a href=https://github.com/vonbrank class="rounded-lg btn-regular active:scale-90 h-10 w-10" aria-label=GitHub target=_blank rel=me><svg data-icon=fa6-brands:github height=1em width=0.97em class=text-[1.5rem]><symbol id=ai:fa6-brands:github viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6c-3.3.3-5.6-1.3-5.6-3.6c0-2 2.3-3.6 5.2-3.6c3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9c2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9c.3 2 2.9 3.3 5.9 2.6c2.9-.7 4.9-2.6 4.6-4.6c-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2c12.8 2.3 17.3-5.6 17.3-12.1c0-6.2-.3-40.4-.3-61.4c0 0-70 15-84.7-29.8c0 0-11.4-29.1-27.8-36.6c0 0-22.9-15.7 1.6-15.4c0 0 24.9 2 38.6 25.8c21.9 38.6 58.6 27.5 72.9 20.9c2.3-16 8.8-27.1 16-33.7c-55.9-6.2-112.3-14.3-112.3-110.5c0-27.5 7.6-41.3 23.6-58.9c-2.6-6.5-11.1-33.3 2.6-67.9c20.9-6.5 69 27 69 27c20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27c13.7 34.7 5.2 61.4 2.6 67.9c16 17.7 25.8 31.5 25.8 58.9c0 96.5-58.9 104.2-114.8 110.5c9.2 7.9 17 22.9 17 46.4c0 33.7-.3 75.4-.3 83.6c0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252C496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2c1.6 1.6 3.9 2.3 5.2 1c1.3-1 1-3.3-.7-5.2c-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9c1.6 1 3.6.7 4.3-.7c.7-1.3-.3-2.9-2.3-3.9c-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2c2.3 2.3 5.2 2.6 6.5 1c1.3-1.3.7-4.3-1.3-6.2c-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2c-1.4-2.3-4-3.3-5.6-2" fill=currentColor /></symbol><use href=#ai:fa6-brands:github></use></svg></a></div></div></div></div><div class="flex w-full flex-col gap-4 top-4 top-4 duration-700 sticky transition-all" id=sidebar-sticky><widget-layout class="onload-animation card-base pb-4" data-astro-cid-ucso7hve=true data-id=categories data-is-collapsed=true style=animation-delay:150ms;--collapsedHeight:7.5rem><div class="transition font-bold before:absolute before:bg-[var(--primary)] before:rounded-md before:h-4 before:left-[-16px] before:top-[5.5px] before:w-1 dark:text-neutral-100 mb-2 ml-8 mt-4 relative text-lg text-neutral-900" style=--collapsedHeight:7.5rem data-astro-cid-ucso7hve>分类</div><div class="overflow-hidden collapse-wrapper collapsed px-4" id=categories style=--collapsedHeight:7.5rem data-astro-cid-ucso7hve><a href=/archive/category/C-C++/ aria-label="View all posts in the C-C++ category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">C-C++</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">5</div></div></button> </a><a href=/archive/category/Guides/ aria-label="View all posts in the Guides category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">Guides</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">1</div></div></button> </a><a href=/archive/category/HTML-CSS/ aria-label="View all posts in the HTML-CSS category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">HTML-CSS</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">2</div></div></button> </a><a href=/archive/category/Java-Kotlin/ aria-label="View all posts in the Java-Kotlin category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">Java-Kotlin</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">5</div></div></button> </a><a href=/archive/category/Javascript-Typescript/ aria-label="View all posts in the Javascript-Typescript category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">Javascript-Typescript</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">2</div></div></button> </a><a href=/archive/category/Python/ aria-label="View all posts in the Python category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">Python</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">1</div></div></button> </a><a href=/archive/category/教程/ aria-label="View all posts in the 教程 category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">教程</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">5</div></div></button> </a><a href=/archive/category/日常/ aria-label="View all posts in the 日常 category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">日常</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">4</div></div></button> </a><a href=/archive/category/深度学习/ aria-label="View all posts in the 深度学习 category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">深度学习</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">2</div></div></button> </a><a href=/archive/category/游戏开发/ aria-label="View all posts in the 游戏开发 category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">游戏开发</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">1</div></div></button> </a><a href="/archive/category/编程竞赛 (Competitive Programming)/" aria-label="View all posts in the 编程竞赛 (Competitive Programming) category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">编程竞赛 (Competitive Programming)</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">16</div></div></button> </a><a href=/archive/category/计算机图形学/ aria-label="View all posts in the 计算机图形学 category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">计算机图形学</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">1</div></div></button> </a><a href=/archive/category/题解/ aria-label="View all posts in the 题解 category"><button class="rounded-lg w-full active:bg-[var(--btn-plain-bg-active)] bg-none dark:hover:text-[var(--primary)] dark:text-neutral-300 h-10 hover:bg-[var(--btn-plain-bg-hover)] hover:pl-3 hover:text-[var(--primary)] pl-2 text-neutral-700 transition-all"><div class="flex items-center justify-between mr-2 relative"><div class="overflow-hidden overflow-ellipsis text-left whitespace-nowrap">题解</div><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)] dark:text-[var(--deep-text)] h-7 min-w-[2rem] px-2 text-[var(--btn-content)] text-sm">6</div></div></button></a></div><div class="-mb-2 expand-btn px-4" style=--collapsedHeight:7.5rem data-astro-cid-ucso7hve><button class="rounded-lg w-full btn-plain h-9" data-astro-cid-ucso7hve style=--collapsedHeight:7.5rem><div class="flex items-center justify-center -translate-x-2 gap-2 text-[var(--primary)]" style=--collapsedHeight:7.5rem data-astro-cid-ucso7hve><svg data-icon=material-symbols:more-horiz height=1em width=1em class=text-[1.75rem] data-astro-cid-ucso7hve=true><symbol id=ai:material-symbols:more-horiz viewBox="0 0 24 24"><path d="M6 14q-.825 0-1.412-.587T4 12t.588-1.412T6 10t1.413.588T8 12t-.587 1.413T6 14m6 0q-.825 0-1.412-.587T10 12t.588-1.412T12 10t1.413.588T14 12t-.587 1.413T12 14m6 0q-.825 0-1.412-.587T16 12t.588-1.412T18 10t1.413.588T20 12t-.587 1.413T18 14" fill=currentColor /></symbol><use href=#ai:material-symbols:more-horiz></use></svg> 更多</div></button></div></widget-layout><script type=module>class d extends HTMLElement{constructor(){if(super(),"true"!==this.dataset.isCollapsed)return;const e=this.dataset.id,t=this.querySelector(".expand-btn"),s=this.querySelector(`#${e}`);t.addEventListener("click",(()=>{s.classList.remove("collapsed"),t.classList.add("hidden")}))}}customElements.define("widget-layout",d)</script><widget-layout class="onload-animation card-base pb-4" data-astro-cid-ucso7hve=true data-id=tags data-is-collapsed=true style=animation-delay:.2s;--collapsedHeight:7.5rem><div class="transition font-bold before:absolute before:bg-[var(--primary)] before:rounded-md before:h-4 before:left-[-16px] before:top-[5.5px] before:w-1 dark:text-neutral-100 mb-2 ml-8 mt-4 relative text-lg text-neutral-900" style=--collapsedHeight:7.5rem data-astro-cid-ucso7hve>标签</div><div class="overflow-hidden collapse-wrapper collapsed px-4" id=tags style=--collapsedHeight:7.5rem data-astro-cid-ucso7hve><div class="flex flex-wrap gap-2"><a href=/archive/tag/Blogging/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Blogging tag">Blogging </a><a href=/archive/tag/C-C++/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the C-C++ tag">C-C++ </a><a href=/archive/tag/Codeforces/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Codeforces tag">Codeforces </a><a href=/archive/tag/CS231n/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the CS231n tag">CS231n </a><a href=/archive/tag/Customization/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Customization tag">Customization </a><a href=/archive/tag/Fuwari/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Fuwari tag">Fuwari </a><a href=/archive/tag/HTML-CSS/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the HTML-CSS tag">HTML-CSS </a><a href=/archive/tag/Java-Kotlin/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Java-Kotlin tag">Java-Kotlin </a><a href=/archive/tag/Javascript-Typescript/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Javascript-Typescript tag">Javascript-Typescript </a><a href=/archive/tag/Linux/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Linux tag">Linux </a><a href=/archive/tag/MaxOS/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the MaxOS tag">MaxOS </a><a href=/archive/tag/OI考古/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the OI考古 tag">OI考古 </a><a href=/archive/tag/Python/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Python tag">Python </a><a href="/archive/tag/Visual Studio Code/" class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Visual Studio Code tag">Visual Studio Code </a><a href=/archive/tag/Web开发/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Web开发 tag">Web开发 </a><a href=/archive/tag/Windows/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the Windows tag">Windows </a><a href=/archive/tag/动态规划/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 动态规划 tag">动态规划 </a><a href=/archive/tag/图论/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 图论 tag">图论 </a><a href=/archive/tag/基础算法/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 基础算法 tag">基础算法 </a><a href=/archive/tag/操作系统/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 操作系统 tag">操作系统 </a><a href=/archive/tag/教程/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 教程 tag">教程 </a><a href=/archive/tag/数据结构/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 数据结构 tag">数据结构 </a><a href=/archive/tag/数论基础/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 数论基础 tag">数论基础 </a><a href=/archive/tag/日常/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 日常 tag">日常 </a><a href=/archive/tag/洛谷Luogu/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 洛谷Luogu tag">洛谷Luogu </a><a href=/archive/tag/深度学习/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 深度学习 tag">深度学习 </a><a href=/archive/tag/游戏开发/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 游戏开发 tag">游戏开发 </a><a href=/archive/tag/私人领域/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 私人领域 tag">私人领域 </a><a href=/archive/tag/计算机图形学/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 计算机图形学 tag">计算机图形学 </a><a href=/archive/tag/课程笔记/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 课程笔记 tag">课程笔记 </a><a href=/archive/tag/题解/ class="rounded-lg text-sm btn-regular h-8 px-3" aria-label="View all posts with the 题解 tag">题解</a></div></div><div class="-mb-2 expand-btn px-4" style=--collapsedHeight:7.5rem data-astro-cid-ucso7hve><button class="rounded-lg w-full btn-plain h-9" data-astro-cid-ucso7hve style=--collapsedHeight:7.5rem><div class="flex items-center justify-center -translate-x-2 gap-2 text-[var(--primary)]" style=--collapsedHeight:7.5rem data-astro-cid-ucso7hve><svg data-icon=material-symbols:more-horiz height=1em width=1em class=text-[1.75rem] viewBox="0 0 24 24" data-astro-cid-ucso7hve=true><use href=#ai:material-symbols:more-horiz></use></svg> 更多</div></button></div></widget-layout></div></div><main class="overflow-hidden col-span-2 lg:col-span-1 transition-swup-fade" id=swup-container><div class=onload-animation id=content-wrapper><div class="flex relative w-full mb-4 overflow-hidden rounded-[var(--radius-large)]"><div class="card-base pb-4 md:px-9 pt-6 px-6 relative w-full z-10" id=post-container><div class="transition flex dark:text-white/30 flex-row gap-5 mb-3 onload-animation text-black/30"><div class="flex items-center flex-row"><div class="transition flex items-center justify-center bg-black/5 dark:bg-white/10 dark:text-white/50 h-6 mr-2 rounded-md text-black/50 w-6"><svg data-icon=material-symbols:notes-rounded height=1em width=1em><symbol id=ai:material-symbols:notes-rounded viewBox="0 0 24 24"><path d="M4 18q-.425 0-.712-.288T3 17t.288-.712T4 16h10q.425 0 .713.288T15 17t-.288.713T14 18zm0-5q-.425 0-.712-.288T3 12t.288-.712T4 11h16q.425 0 .713.288T21 12t-.288.713T20 13zm0-5q-.425 0-.712-.288T3 7t.288-.712T4 6h16q.425 0 .713.288T21 7t-.288.713T20 8z" fill=currentColor /></symbol><use href=#ai:material-symbols:notes-rounded></use></svg></div><div class=text-sm>11184 字</div></div><div class="flex items-center flex-row"><div class="transition flex items-center justify-center bg-black/5 dark:bg-white/10 dark:text-white/50 h-6 mr-2 rounded-md text-black/50 w-6"><svg data-icon=material-symbols:schedule-outline-rounded height=1em width=1em><symbol id=ai:material-symbols:schedule-outline-rounded viewBox="0 0 24 24"><path d="M13 11.6V8q0-.425-.288-.712T12 7t-.712.288T11 8v3.975q0 .2.075.388t.225.337l3.3 3.3q.275.275.7.275T16 16t.275-.7t-.275-.7zM12 22q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.325 0 5.663-2.337T20 12t-2.337-5.663T12 4T6.337 6.338T4 12t2.338 5.663T12 20" fill=currentColor /></symbol><use href=#ai:material-symbols:schedule-outline-rounded></use></svg></div><div class=text-sm>56 分钟</div></div></div><div class="onload-animation relative"><div class="transition font-bold before:absolute before:bg-[var(--primary)] before:rounded-md before:h-5 before:left-[-1.125rem] before:top-[0.75rem] block dark:text-white/90 mb-3 md:before:w-1 md:text-[2.25rem]/[2.75rem] text-3xl text-black/90 w-full" data-pagefind-body data-pagefind-meta=title data-pagefind-weight=10>GAMES 202 作业代码框架剖析</div></div><div class=onload-animation><div class="flex items-center dark:text-neutral-400 flex-wrap gap-4 gap-x-4 gap-y-2 mb-5 text-neutral-500"><div class="flex items-center"><div class=meta-icon><svg data-icon=material-symbols:calendar-today-outline-rounded height=1em width=1em class=text-xl><symbol id=ai:material-symbols:calendar-today-outline-rounded viewBox="0 0 24 24"><path d="M5 22q-.825 0-1.412-.587T3 20V6q0-.825.588-1.412T5 4h1V3q0-.425.288-.712T7 2t.713.288T8 3v1h8V3q0-.425.288-.712T17 2t.713.288T18 3v1h1q.825 0 1.413.588T21 6v14q0 .825-.587 1.413T19 22zm0-2h14V10H5zM5 8h14V6H5zm0 0V6z" fill=currentColor /></symbol><use href=#ai:material-symbols:calendar-today-outline-rounded></use></svg></div><span class="text-50 text-sm font-medium">2023-08-23</span></div><div class="flex items-center"><div class=meta-icon><svg data-icon=material-symbols:book-2-outline-rounded height=1em width=1em class=text-xl><symbol id=ai:material-symbols:book-2-outline-rounded viewBox="0 0 24 24"><path d="M6 15.325q.35-.175.725-.25T7.5 15H8V4h-.5q-.625 0-1.062.438T6 5.5zM10 15h8V4h-8zm-4 .325V4zM7.5 22q-1.45 0-2.475-1.025T4 18.5v-13q0-1.45 1.025-2.475T7.5 2H18q.825 0 1.413.587T20 4v12.525q0 .2-.162.363t-.588.362q-.35.175-.55.5t-.2.75t.2.763t.55.487t.55.413t.2.562v.25q0 .425-.288.725T19 22zm0-2h9.325q-.15-.35-.237-.712T16.5 18.5q0-.4.075-.775t.25-.725H7.5q-.65 0-1.075.438T6 18.5q0 .65.425 1.075T7.5 20" fill=currentColor /></symbol><use href=#ai:material-symbols:book-2-outline-rounded></use></svg></div><div class="flex items-center flex-row flex-nowrap"><a href=/archive/category/计算机图形学/ class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts in the 计算机图形学 category">计算机图形学</a></div></div><div class="flex items-center"><div class=meta-icon><svg data-icon=material-symbols:tag-rounded height=1em width=1em class=text-xl><symbol id=ai:material-symbols:tag-rounded viewBox="0 0 24 24"><path d="m9 16l-.825 3.275q-.075.325-.325.525t-.6.2q-.475 0-.775-.375T6.3 18.8L7 16H4.275q-.5 0-.8-.387T3.3 14.75q.075-.35.35-.55t.625-.2H7.5l1-4H5.775q-.5 0-.8-.387T4.8 8.75q.075-.35.35-.55t.625-.2H9l.825-3.275Q9.9 4.4 10.15 4.2t.6-.2q.475 0 .775.375t.175.825L11 8h4l.825-3.275q.075-.325.325-.525t.6-.2q.475 0 .775.375t.175.825L17 8h2.725q.5 0 .8.387t.175.863q-.075.35-.35.55t-.625.2H16.5l-1 4h2.725q.5 0 .8.388t.175.862q-.075.35-.35.55t-.625.2H15l-.825 3.275q-.075.325-.325.525t-.6.2q-.475 0-.775-.375T12.3 18.8L13 16zm.5-2h4l1-4h-4z" fill=currentColor /></symbol><use href=#ai:material-symbols:tag-rounded></use></svg></div><div class="flex items-center flex-row flex-nowrap"><div class="hidden mx-1.5 text-[var(--meta-divider)] text-sm">/</div><a href=/archive/tag/教程/ class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts with the 教程 tag">教程</a><div class="mx-1.5 text-[var(--meta-divider)] text-sm">/</div><a href=/archive/tag/计算机图形学/ class="transition text-sm text-50 dark:hover:text-[var(--primary)] font-medium hover:text-[var(--primary)] link-lg whitespace-nowrap" aria-label="View all posts with the 计算机图形学 tag">计算机图形学</a></div></div></div></div><div class="overflow-hidden relative rounded-xl onload-animation banner-container mb-8" id=post-cover><div class="transition absolute pointer-events-none bg-opacity-50 dark:bg-black/10 inset-0"></div><img alt src=https://cdn2.unrealengine.com/Unreal+Engine%2Fblog%2Fporsche-nvidia-and-epic-games-reveal-the-speed-of-light-for-porsche-911-speedster-concept%2FSpeed_of_Light_Hero_1_1920-1920x873-0006adad2a4df33615d426901e38ae89a7a5d25a.jpg class="h-full w-full object-cover" style=object-position:center></div><div class="onload-animation mb-6 !max-w-none custom-md dark:prose-invert markdown-content prose prose-base" data-pagefind-body><p>《GAMES202：高质量实时渲染》是由闫令琪老师开设的计算机图形学进阶课程。相比 GAMES 101，GAMES 202 不仅作业内容的难度更高，其代码框架也更难以理解。由于对代码框架、尤其是 WebGL API 的理解直接影响到完成作业的思路，并且 GAMES 202 代码框架也是使用 WebGL 封装简易图形渲染引擎的一次很好的实践，因此本文将对 GAMES 202 使用了 WebGL 的部分作业代码框架进行剖析，尝试解释代码框架中每一个文件、每一行代码做了什么，从而为更好更深入地理解和完成作业内容打下坚实基础。</p><section><h2 id=webgl-使用方法回顾>WebGL 使用方法回顾<a href=#webgl-使用方法回顾 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h2><p>WebGL 是 OpenGL 的一个子集，是一套光栅化 API。浏览器在底层实现了 OpenGL 标准接口并在以 JavaScript 封装的方式提供给开发者使用，开发者首先通过 <code>canvas</code> 元素获取 WebGL 上下文对象，通过操作该对象上的 WebGL 接口并输出到画布上，从而实现各类渲染功能。</p><p>要在 WebGL 中实现渲染物体，比如渲染一个三角形，需要向着色器提供以下几类数据：</p><ul><li><code>Attributes</code> 和 <code>Buffer</code>：Buffer 通常是一个类似数组的东西，里面按顺序存储了物体的顶点、法线、纹理坐标、颜色等信息。将一组 Buffer 提供给着色器，通过 <code>Attributes</code> 来告诉着色器如何理解这些数据（如多少个数表示第一个顶点，一次渲染中这一组数据在着色器中对应的变量名称是什么等）</li><li><code>Uniforms</code>：可以认为是渲染一帧过程中，着色器程序每次运行过程中都不变的常量，如摄像机的参数、光源的位置等</li><li><code>Textures</code>：纹理数据在渲染过程中的数据不必多说，WebGL 提供 <code>Textures</code> 数据类型及其相关方法专门用于传递纹理数据，当然，这也只是一种数据类型而已，开发者也可以向其中存储任意类型的数据，并以自己理解的方式进行读取和使用，前提是使用 <code>Textures</code> 数据类型提供的数据操作方法</li></ul><p>WebGL 在运行过程中，首先将顶点数据输入顶点着色器（Vertex Shader），以由 <code>Attributes</code> 和 <code>Buffer</code> 提供的顶点数据为单位将顶点坐标变换到裁剪空间，接着根据顶点进行光栅化和插值，以插值得到的每一个结果作为片元着色器（Fragment Shader）的输入，运行该着色器以获得一个像素的值。该过程中渲染所需的其他参数，如变换规则、摄像机的位置、光源位置等，需通过 <code>Uniforms</code> 和 <code>Textures</code> 得到。</p><p><img alt=顶点着色器运行过程 src=https://webglfundamentals.org/webgl/lessons/resources/vertex-shader-anim.gif></p><p>更多关于 WebGL 使用方法的内容，请参考 <a href=https://webglfundamentals.org/ >WebGL Fundamentals</a></p></section><section><h2 id=将官方代码框架引入现代前端开发流的说明>将官方代码框架引入现代前端开发流的说明<a href=#将官方代码框架引入现代前端开发流的说明 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h2><p>GAMES202 课程作业大都基于 WebGL 实现。得益于 WebGL 简单易用的特点，这免去了我们手动配置 OpenGL 的麻烦。</p><p>然而原代码框架使用传统 Web 前端技术与原生 JavaScript 进行编写，缺乏代码提示与静态检查，使得完成作业、调试 bug 较为困难。</p><p>因此笔者针对 GAMES202 官方作业代码框架进行了简单修改，将原代码框架迁移至 TypeScript，使用 Vite 进行打包，并引入 ES Module 模块化，同时实现类型声明与静态检查，期望能提升开发体验。项目链接：<a href=https://github.com/vonbrank/GAMES202-Assignment-Framework-with-TypeScript-Support>GAMES202 Assignment Framework with TypeScript Support</a></p><p>本文针对代码框架的剖析都将基于迁移到 TypeScript 的版本进行。</p></section><section><h2 id=作业-0-代码框架详解>作业 0 代码框架详解<a href=#作业-0-代码框架详解 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h2><section><h3 id=games-202-作业代码框架体系结构>GAMES 202 作业代码框架体系结构<a href=#games-202-作业代码框架体系结构 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h3><p>作业 0 的代码框架目录结构如下：</p><pre class="astro-code github-dark" data-language=txt style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span>+</span></span>
<span class=line><span>|   .gitignore</span></span>
<span class=line><span>|   index.html</span></span>
<span class=line><span>|   package.json</span></span>
<span class=line><span>|   tsconfig.json</span></span>
<span class=line><span>|   vite.config.ts</span></span>
<span class=line><span>|   yarn.lock</span></span>
<span class=line><span>|</span></span>
<span class=line><span>+---public</span></span>
<span class=line><span>|   |   vite.svg</span></span>
<span class=line><span>|   |</span></span>
<span class=line><span>|   \---assets</span></span>
<span class=line><span>|       \---mary</span></span>
<span class=line><span>|               Marry.mtl</span></span>
<span class=line><span>|               Marry.obj</span></span>
<span class=line><span>|               MC003_Kozakura_Mari.png</span></span>
<span class=line><span>|</span></span>
<span class=line><span>\---src</span></span>
<span class=line><span>    |   engine.ts</span></span>
<span class=line><span>    |   main.ts</span></span>
<span class=line><span>    |   style.css</span></span>
<span class=line><span>    |   typescript.svg</span></span>
<span class=line><span>    |   vite-env.d.ts</span></span>
<span class=line><span>    |</span></span>
<span class=line><span>    +---lights</span></span>
<span class=line><span>    |       Light.ts</span></span>
<span class=line><span>    |       PointLight.ts</span></span>
<span class=line><span>    |</span></span>
<span class=line><span>    +---loads</span></span>
<span class=line><span>    |       loadOBJ.ts</span></span>
<span class=line><span>    |       loadShader.ts</span></span>
<span class=line><span>    |</span></span>
<span class=line><span>    +---materials</span></span>
<span class=line><span>    |       Material.ts</span></span>
<span class=line><span>    |</span></span>
<span class=line><span>    +---objects</span></span>
<span class=line><span>    |       Mesh.ts</span></span>
<span class=line><span>    |</span></span>
<span class=line><span>    +---renderers</span></span>
<span class=line><span>    |       MeshRender.ts</span></span>
<span class=line><span>    |       WebGLRenderer.ts</span></span>
<span class=line><span>    |</span></span>
<span class=line><span>    +---shaders</span></span>
<span class=line><span>    |   |   Shader.ts</span></span>
<span class=line><span>    |   |</span></span>
<span class=line><span>    |   +---InternalShader</span></span>
<span class=line><span>    |   |       FragmentShader.glsl</span></span>
<span class=line><span>    |   |       index.ts</span></span>
<span class=line><span>    |   |       LightCubeFragmentShader.glsl</span></span>
<span class=line><span>    |   |       LightCubeVertexShader.glsl</span></span>
<span class=line><span>    |   |       VertexShader.glsl</span></span>
<span class=line><span>    |   |</span></span>
<span class=line><span>    |   +---lightShader</span></span>
<span class=line><span>    |   |       fragment.glsl</span></span>
<span class=line><span>    |   |       vertex.glsl</span></span>
<span class=line><span>    |   |</span></span>
<span class=line><span>    |   \---phongShader</span></span>
<span class=line><span>    |           fragment.glsl</span></span>
<span class=line><span>    |           vertex.glsl</span></span>
<span class=line><span>    |</span></span>
<span class=line><span>    \---textures</span></span>
<span class=line><span>            Texture.ts</span></span></code></pre><ul><li><code>index.html</code>：描述网页的布局文件，这里只需要一个充满屏幕的 <code>canvas</code> 元素即可，用来获取 WebGL 的上下文</li><li><code>public</code> 文件夹：存放各类公共资源，如网页 logo，要渲染的模型等，在 JavaScript 中引入本地静态资源时使用的相对路径可以被认为是以此为根目录的相对路径。<ul><li><code>assets</code>：这里一般存放要渲染的模型资产，如要在 JavaScript 中访问 <code>marry</code> 文件夹，使用 <code>assets/marry</code> 进行访问即可</li></ul></li><li><code>src</code>：这是存放各类代码的地方，包括 TypeScript 文件和 GLSL 文件<ul><li><code>main.ts</code>：程序的入口，从这里调用来自 <code>engine.ts</code> 的 <code>GAMES202Main</code> 来初始化 WebGL 配置、加载并渲染模型等</li><li><code>engine.ts</code>：定义了 <code>GAMES202Main</code> 函数和摄像机的初始位置，在该函数中，首先从 DOM 树中获取在 <code>index.html</code> 定义的 <code>canvas</code> 元素，创建一个用于操作 WebGL 的上下文；接着使用 <code>THREE.js</code> 创建摄像机对象用于生成可以在 Shader 中使用的各类摄像机参数；然后创建光源数据，和一个自定义的、使用 WebGL 接口封装的 Mesh Renderer，用以渲染从资产文件中加载出来的包含顶点、纹理坐标、法线数据的模型；最后进入消息循环，监听镜头移动并持续刷新渲染场景。</li><li><code>renders</code>：通过传入摄像机数据、光源位置，和定义了顶点、纹理坐标、法线等信息的 Mesh 来向 <code>engine.ts</code> 提供两种渲染功能<ul><li><code>WebGLRenderer.ts</code>：总的渲染器，通过保存若干光源、Mesh 和摄像机的信息，调用内置 Shader 的 MeshRender 实例的 <code>draw</code> 方法、传入摄像机、光源参数，以实现渲染整个场景中渲染所有 Mesh 和光源的功能</li><li><code>MeshRenderer.ts</code>：提供渲染一个 Mesh 的功能，通过保存一个模型的所有顶点、法线、材质、纹理坐标、缓冲等数据，在 <code>draw</code> 函数中根据传入的 Transform、摄像机参数等实现在场景中渲染单个 Mesh</li></ul></li><li><code>objects</code>：<ul><li><code>Mesh.ts</code>：直接存储一个 Mesh 的各类数据，包括所有顶点坐标、顶点对应的法线方向、顶点对应的纹理坐标、每个三角形对应三个顶点的索引</li></ul></li><li><code>materials</code>：定义了各种项目所需的 Material，在作业 0 中只有 Blinn-Phong 模型的 Material 及其 Shader<ul><li><code>Materials.ts</code>：保存了对赋予了该材质的表面进行渲染/着色的过程中所使用的着色器的源码，以及渲染管线中需要从外部传入的 <code>Uniforms</code> 数据的名称，将要输入顶点着色器的各类 <code>Attributes</code> 在顶点着色器中的变量名等</li></ul></li><li><code>shaders</code>：保存了项目所需的各类着色器的源码，以及从 WebGL 封装的着色器类<ul><li><code>Shader.ts</code>：通过传入顶点着色器与片元着色器的源码、该源码需要关注的 <code>Attributes</code> 与 <code>Uniforms</code> 名称列表，编译着色器，并整理出所有需要关注的 <code>Attributes</code> 的顶点着色器中的索引和 <code>Uniforms</code> 在整个渲染管线中的 <code>WebGLUniformLocation</code> 值，以便为 <code>Material</code> 提供编译着色器与快速设置 <code>Attributes</code> 和 <code>Uniforms</code> 值的服务</li></ul></li><li><code>textures</code>：<ul><li><code>Texture.ts</code>：向 <code>OBJ Loader</code> 和 <code>Material</code> 模块提供将 <code>HTMLImageElement</code> 转换为 <code>WebGLTexture</code> 的功能</li></ul></li><li><code>loads</code>：几种外部资源加载器<ul><li><code>loadOBJ.ts</code>：提供从本地加载模型资产的功能，通过传入 <code>WebGLRenderer</code> 和文件路径，借助 <code>THREE.js</code> 提供的 <code>MTLLoader</code> 来从本地加载模型资产、纹理等数据，自动为 <code>MeshRender</code> 创建 <code>Mesh</code>，<code>Material</code>，<code>Texture</code> 数据并添加到 <code>WebGLRenderer</code> 中</li><li><code>loadShader.ts</code>：允许用户从本地加载着色器源码，但因为我们使用 Vite 进行打包，可以在项目编译期直接以字符串形式在 JavaScript 代码中引入着色器源码，故 <code>loadShader</code> 功能可弃用</li></ul></li></ul></li></ul></section><section><h3 id=games-202-engine>GAMES 202 Engine<a href=#games-202-engine class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h3><p>这部分主要讲述程序入口处调用的第一个，也是唯一一个函数 <code>GAMES202Main</code> 与包含这个函数的 <code>engine.ts</code> 的功能。</p><section><h4 id=总体功能>总体功能<a href=#总体功能 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><p>先总体说一下 <code>GAMES202Main</code> 的功能：当浏览器打开本项目的页面时，Chrome 自动加载一同随 Web 应用打包的 JavaScript 文件，接着就会调用 <code>GAMES202Main</code> 函数，在调用前，由 <code>index.html</code> 定义的页面所对应的 DOM 树就已经生成。因此在 <code>GAMES202Main</code> 中可以直接获取到页面中定义的 <code>canvas</code> 元素，进而获取对应的 <code>WebGLRenderingContext</code> 以便操作该 <code>canvas</code> 的渲染。</p><p>获取完 <code>WebGLRenderingContext</code> 实例后就要准备渲染所需要的一系列参数了，<code>GAMES202Main</code> 首先准备的是摄像机的参数。我们知道，不论是光栅化还是光线追踪渲染，定义摄像机实际上就是在定义摄像机位置、屏幕长宽比、场视角（FOV）、屏幕到摄像机的距离等，这些数据将用于定义光栅化渲染中的 MVP 矩阵或光线追踪中发射光线的范围限制，总之这些数据最终会转换为 GLSL 中某些 <code>Uniforms</code> 参数。<code>GAMES202Main</code> 使用 <code>THREE.js</code> 的 <code>PerspectiveCamera</code> 来构造摄像机实例，<code>PerspectiveCamera</code> 可以仅通过 FOV、长宽比、最近最远距离来定义摄像机，进而计算 MVP 矩阵；此外程序还构造了一个同样由 <code>THREE.js</code> 提供的 <code>OrbitControls</code> 摄像机控制组件实例，可以通过修改该实例来控制摄像机的运动、朝向等，从而无需手动通过修改摄像机参数的方式来处理摄像机的运动。</p><p>除了摄像机，<code>GAMES202Main</code> 还会创建一个 <code>WebGLRenderer</code> 对象，如前文所述，该对象是自定义的，可以为其指定 <code>WebGLRenderingContext</code> 和由 <code>THREE.js</code> 创建的摄像机对象，并向其中添加 <code>MeshRender</code> 对象、光源对象等来实现渲染场景中的多个物体和光源。</p><p>接着程序创建好场景所需的一个光源、得到一个 <code>PointLight</code>，再从 <code>loadOBJ</code> 加载要渲染的模型、获得一个 <code>MeshRender</code>，并将它们都添加到 <code>WebGLRenderer</code> 的渲染列表中。</p><p>然后使用 <code>THREE.js</code> 提供的 <code>dat.gui</code> 库来快速向页面上添加一个基于 <code>HTML</code> 元素的 GUI。</p><p>最后，<code>GAMES202Main</code> 陷入循环，在每一轮循环首先通过 <code>cameraControls</code> 来更新摄像机参数，再使用 <code>WebGLRenderer</code> 来更新 <code>canvas</code> 元素中的渲染内容。</p></section><section><h4 id=enginets-代码注释><code>engine.ts</code> 代码注释<a href=#enginets-代码注释 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d>// 导入依赖项</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#79b8ff> *</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> THREE </span><span style=color:#f97583>from</span><span style=color:#9ecbff> 'three'</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { OrbitControls } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> 'three/examples/jsm/controls/OrbitControls'</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { PointLight } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> './lights/PointLight'</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#79b8ff> *</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> dat </span><span style=color:#f97583>from</span><span style=color:#9ecbff> 'dat.gui'</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { WebGLRenderer } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> './renderers/WebGLRenderer'</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { loadOBJ } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> './loads/loadOBJ'</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>// 定义摄像机的初始位置</span></span>
<span class=line><span style=color:#f97583>var</span><span style=color:#e1e4e8> cameraPosition </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> [</span><span style=color:#f97583>-</span><span style=color:#79b8ff>20</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>180</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>250</span><span style=color:#e1e4e8>];</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> function</span><span style=color:#b392f0> GAMES202Main</span><span style=color:#e1e4e8>() {</span></span>
<span class=line><span style=color:#6a737d>  // document 对象是 JavaScript 与前端网页中的 HTML 元素进行交互的接口</span></span>
<span class=line><span style=color:#6a737d>  // 这里是从 DOM 树中获取 id 为 glcanvas 的 HTMLCanvasElement 对象</span></span>
<span class=line><span style=color:#6a737d>  // querySelector 函数通过传入一个 CSS 选择器 '#glcanvas' 来从 DOM 树中筛选出</span></span>
<span class=line><span style=color:#6a737d>  // 第一个 id 为 glcanvas 的元素</span></span>
<span class=line><span style=color:#6a737d>  // &#x3C;HTMLCanvasElement> 泛型表明期望返回 HTMLCanvasElement | null 类型的对象</span></span>
<span class=line><span style=color:#f97583>  const</span><span style=color:#79b8ff> canvas</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> document.</span><span style=color:#b392f0>querySelector</span><span style=color:#e1e4e8>&#x3C;</span><span style=color:#b392f0>HTMLCanvasElement</span><span style=color:#e1e4e8>>(</span><span style=color:#9ecbff>'#glcanvas'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>  </span></span>
<span class=line><span style=color:#f97583>  if</span><span style=color:#e1e4e8>(canvas </span><span style=color:#f97583>===</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>    // 如果返回了 null，表明不存在 id 为 glcanvas 的 HTMLCanvasElement 元素</span></span>
<span class=line><span style=color:#e1e4e8>    console.</span><span style=color:#b392f0>log</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>"can not find #glcanvas"</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#f97583>    return</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>  }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 将 canvas 的长宽更新为浏览器视口的长和宽</span></span>
<span class=line><span style=color:#e1e4e8>  canvas.width </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> window.screen.width;</span></span>
<span class=line><span style=color:#e1e4e8>  canvas.height </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> window.screen.height;</span></span>
<span class=line><span style=color:#6a737d>  // 从 canvas 对象中获取 WebGLRenderingContext，便于后续控制画布渲染</span></span>
<span class=line><span style=color:#f97583>  const</span><span style=color:#79b8ff> gl</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> canvas.</span><span style=color:#b392f0>getContext</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'webgl'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#f97583>  if</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>!</span><span style=color:#e1e4e8>gl) {</span></span>
<span class=line><span style=color:#6a737d>     // 如果没有成功获取，说明浏览器可能不支持 WebGL</span></span>
<span class=line><span style=color:#b392f0>    alert</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'Unable to initialize WebGL. Your browser or machine may not support it.'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#f97583>    return</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>  }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 使用 THREE.js 创建了一个透视投影摄像机，FOV = 75，长宽比为 canvas 自己的长宽比</span></span>
<span class=line><span style=color:#6a737d>  // 远点和近点分别为 1000 和 0.1</span></span>
<span class=line><span style=color:#f97583>  const</span><span style=color:#79b8ff> camera</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#79b8ff> THREE</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>PerspectiveCamera</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>75</span><span style=color:#e1e4e8>, canvas.clientWidth </span><span style=color:#f97583>/</span><span style=color:#e1e4e8> canvas.clientHeight, </span><span style=color:#79b8ff>0.1</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1000</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#6a737d>  // 创建一个摄像机控制对象，并将其绑定到先前创建的摄像机上</span></span>
<span class=line><span style=color:#f97583>  const</span><span style=color:#79b8ff> cameraControls</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#b392f0> OrbitControls</span><span style=color:#e1e4e8>(camera, canvas);</span></span>
<span class=line><span style=color:#6a737d>  // 设置摄像机的控制参数：</span></span>
<span class=line><span style=color:#6a737d>  // 允许缩放、旋转、移动</span></span>
<span class=line><span style=color:#6a737d>  // 旋转、缩放、移动速度分别为 0.3, 1.0, 2.0</span></span>
<span class=line><span style=color:#e1e4e8>  cameraControls.enableZoom </span><span style=color:#f97583>=</span><span style=color:#79b8ff> true</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>  cameraControls.enableRotate </span><span style=color:#f97583>=</span><span style=color:#79b8ff> true</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>  cameraControls.enablePan </span><span style=color:#f97583>=</span><span style=color:#79b8ff> true</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>  cameraControls.rotateSpeed </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 0.3</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>  cameraControls.zoomSpeed </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 1.0</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>  cameraControls.keyPanSpeed </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 2.0</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 封装设置摄像机长宽比的功能</span></span>
<span class=line><span style=color:#f97583>  function</span><span style=color:#b392f0> setSize</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>width</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>height</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>    // 重新计算长宽比</span></span>
<span class=line><span style=color:#e1e4e8>    camera.aspect </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> width </span><span style=color:#f97583>/</span><span style=color:#e1e4e8> height;</span></span>
<span class=line><span style=color:#6a737d>    // 根据新的长宽比重新计算投影变换矩阵</span></span>
<span class=line><span style=color:#6a737d>    // 即 MVP 矩阵变换中的 P</span></span>
<span class=line><span style=color:#e1e4e8>    camera.</span><span style=color:#b392f0>updateProjectionMatrix</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#e1e4e8>  }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 用画布的长宽比更新摄像机的长宽比及其投影变换矩阵</span></span>
<span class=line><span style=color:#b392f0>  setSize</span><span style=color:#e1e4e8>(canvas.clientWidth, canvas.clientHeight);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 监听浏览器视口的 resize 事件，以便在用户缩放视口时摄像机参数仍实时正确更新</span></span>
<span class=line><span style=color:#e1e4e8>  window.</span><span style=color:#b392f0>addEventListener</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'resize'</span><span style=color:#e1e4e8>, () </span><span style=color:#f97583>=></span><span style=color:#b392f0> setSize</span><span style=color:#e1e4e8>(canvas.clientWidth, canvas.clientHeight));</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 初始化摄像机位置</span></span>
<span class=line><span style=color:#e1e4e8>  camera.position.</span><span style=color:#b392f0>set</span><span style=color:#e1e4e8>(cameraPosition[</span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>], cameraPosition[</span><span style=color:#79b8ff>1</span><span style=color:#e1e4e8>], cameraPosition[</span><span style=color:#79b8ff>2</span><span style=color:#e1e4e8>]);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 通过 camaeraControls 设置摄像机的朝向位置</span></span>
<span class=line><span style=color:#e1e4e8>  cameraControls.target.</span><span style=color:#b392f0>set</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 创建一个光源，并初始化其亮度、位置</span></span>
<span class=line><span style=color:#f97583>  const</span><span style=color:#79b8ff> pointLight</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#b392f0> PointLight</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>250</span><span style=color:#e1e4e8>, [</span><span style=color:#79b8ff>1</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1</span><span style=color:#e1e4e8>]);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 创建一个 WebGLRenderer 渲染器对象，并将 WebGL 渲染上下文和摄像机对象绑定到其上</span></span>
<span class=line><span style=color:#f97583>  const</span><span style=color:#79b8ff> renderer</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#b392f0> WebGLRenderer</span><span style=color:#e1e4e8>(gl, camera);</span></span>
<span class=line><span style=color:#6a737d>  // 向渲染器中添加光源</span></span>
<span class=line><span style=color:#e1e4e8>  renderer.</span><span style=color:#b392f0>addLight</span><span style=color:#e1e4e8>(pointLight);</span></span>
<span class=line><span style=color:#6a737d>  // 从本地的 assets/mary 目录中加载名为 Marry 的资源模型，并添加到渲染器对象中</span></span>
<span class=line><span style=color:#b392f0>  loadOBJ</span><span style=color:#e1e4e8>(renderer, </span><span style=color:#9ecbff>'assets/mary/'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'Marry'</span><span style=color:#e1e4e8>);</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 以下涉及 dat.GUI 的基本使用</span></span>
<span class=line><span style=color:#6a737d>  // 简单来说，这里先定义了需要使用 dat.GUI 控制的数据 guiParams</span></span>
<span class=line><span style=color:#6a737d>  // 使用 dat.GUI 创建一个 GUI 的实例后，使用 addFolder 来添加数据面板</span></span>
<span class=line><span style=color:#6a737d>  // 每个面板可以包含若干用来调整数据的 UI</span></span>
<span class=line><span style=color:#6a737d>  // 调用面板的 add 方法可以通过传入要操控的数据对象引用、操控的对象名称、</span></span>
<span class=line><span style=color:#6a737d>  // 和在面板中显示的对象名字，来实现将对象的某一字段绑定到面板中</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 定义需要使用 dat.GUI 控制的数据：模型的 translation 和 scale</span></span>
<span class=line><span style=color:#6a737d>  // 分别初始化为 (0, 0, 0) 和 (52, 52, 52)</span></span>
<span class=line><span style=color:#f97583>  var</span><span style=color:#e1e4e8> guiParams </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#e1e4e8>    modelTransX: </span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>    modelTransY: </span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>    modelTransZ: </span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>    modelScaleX: </span><span style=color:#79b8ff>52</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>    modelScaleY: </span><span style=color:#79b8ff>52</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>    modelScaleZ: </span><span style=color:#79b8ff>52</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>  }</span></span>
<span class=line><span style=color:#f97583>  function</span><span style=color:#b392f0> createGUI</span><span style=color:#e1e4e8>() {</span></span>
<span class=line><span style=color:#6a737d>    // 创建一个 dat.GUI 实例</span></span>
<span class=line><span style=color:#f97583>    const</span><span style=color:#79b8ff> gui</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#e1e4e8> dat.</span><span style=color:#b392f0>GUI</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#6a737d>    // 创建一个总的面板，名为 panelModel</span></span>
<span class=line><span style=color:#f97583>    const</span><span style=color:#79b8ff> panelModel</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> gui.</span><span style=color:#b392f0>addFolder</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'Model properties'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#6a737d>    // 在 panelModel 下创建两个子面板，分别名为 Translation 和 Scale</span></span>
<span class=line><span style=color:#f97583>    const</span><span style=color:#79b8ff> panelModelTrans</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> panelModel.</span><span style=color:#b392f0>addFolder</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'Translation'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#f97583>    const</span><span style=color:#79b8ff> panelModelScale</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> panelModel.</span><span style=color:#b392f0>addFolder</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'Scale'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#6a737d>    // 在 Translation 面板下添加一个参数输入框与控制杆，</span></span>
<span class=line><span style=color:#6a737d>    // 表示将这个控件的值与 guiParams 中名为 modelTransX 的字段绑定起来</span></span>
<span class=line><span style=color:#6a737d>    // 每次在 UI 中更新它的值，都将更新 guiParams 的值</span></span>
<span class=line><span style=color:#6a737d>    // 并在面板中将这个值的名称显示为 X</span></span>
<span class=line><span style=color:#e1e4e8>    panelModelTrans.</span><span style=color:#b392f0>add</span><span style=color:#e1e4e8>(guiParams, </span><span style=color:#9ecbff>'modelTransX'</span><span style=color:#e1e4e8>).</span><span style=color:#b392f0>name</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'X'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#6a737d>    // 其他 add 语句的含义与上述相同</span></span>
<span class=line><span style=color:#e1e4e8>    panelModelTrans.</span><span style=color:#b392f0>add</span><span style=color:#e1e4e8>(guiParams, </span><span style=color:#9ecbff>'modelTransY'</span><span style=color:#e1e4e8>).</span><span style=color:#b392f0>name</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'Y'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>    panelModelTrans.</span><span style=color:#b392f0>add</span><span style=color:#e1e4e8>(guiParams, </span><span style=color:#9ecbff>'modelTransZ'</span><span style=color:#e1e4e8>).</span><span style=color:#b392f0>name</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'Z'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>    panelModelScale.</span><span style=color:#b392f0>add</span><span style=color:#e1e4e8>(guiParams, </span><span style=color:#9ecbff>'modelScaleX'</span><span style=color:#e1e4e8>).</span><span style=color:#b392f0>name</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'X'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>    panelModelScale.</span><span style=color:#b392f0>add</span><span style=color:#e1e4e8>(guiParams, </span><span style=color:#9ecbff>'modelScaleY'</span><span style=color:#e1e4e8>).</span><span style=color:#b392f0>name</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'Y'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>    panelModelScale.</span><span style=color:#b392f0>add</span><span style=color:#e1e4e8>(guiParams, </span><span style=color:#9ecbff>'modelScaleZ'</span><span style=color:#e1e4e8>).</span><span style=color:#b392f0>name</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>'Z'</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#6a737d>    // 依次展开 panelModel，panelModelTrans 和 panelModelScale 面板</span></span>
<span class=line><span style=color:#e1e4e8>    panelModel.</span><span style=color:#b392f0>open</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#e1e4e8>    panelModelTrans.</span><span style=color:#b392f0>open</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#e1e4e8>    panelModelScale.</span><span style=color:#b392f0>open</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#e1e4e8>  }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // 创建 dat.GUI 实例并将 guiParams 绑定到 GUI 上</span></span>
<span class=line><span style=color:#b392f0>  createGUI</span><span style=color:#e1e4e8>();</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>  // requestAnimationFrame 是由浏览器提供的动画 API，可以认为传入的函数将在下一次浏览器更新动画时被执行</span></span>
<span class=line><span style=color:#6a737d>  // 传入的 mainLoop 是用于在每一帧进行渲染的主循环函数</span></span>
<span class=line><span style=color:#f97583>  function</span><span style=color:#b392f0> mainLoop</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>now</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>    // cameraControls 实际上提供了使用鼠标、滚轮更新其参数的功能</span></span>
<span class=line><span style=color:#6a737d>    // 因此每一帧其中的数据都可能更新</span></span>
<span class=line><span style=color:#6a737d>    // 需要调用 update 来更新 cameraControls 自身的某些参数</span></span>
<span class=line><span style=color:#6a737d>    // 和被其控制的摄像机的参数</span></span>
<span class=line><span style=color:#e1e4e8>    cameraControls.</span><span style=color:#b392f0>update</span><span style=color:#e1e4e8>();</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 使用新的（可能被用户通过 dat.GUI 更新的）guiParams 来对场景和模型进行重新渲染</span></span>
<span class=line><span style=color:#e1e4e8>    renderer.</span><span style=color:#b392f0>render</span><span style=color:#e1e4e8>(guiParams);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 在主循环结尾再次将自身传入 requestAnimationFrame 可以实现浏览器每帧动画更新时都重新渲染 canvas 的内容</span></span>
<span class=line><span style=color:#b392f0>    requestAnimationFrame</span><span style=color:#e1e4e8>(mainLoop);</span></span>
<span class=line><span style=color:#e1e4e8>  }</span></span>
<span class=line><span style=color:#6a737d>  // 在引擎各参数初始化完成后手动调用第一次 requestAnimationFrame 来进入主渲染循环</span></span>
<span class=line><span style=color:#b392f0>  requestAnimationFrame</span><span style=color:#e1e4e8>(mainLoop);</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span></code></pre></section></section><section><h3 id=renderer>Renderer<a href=#renderer class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h3><p>要想渲染一个场景，首先需要一个对象用来管理整个场景中的所有物体，如摄像机、可渲染的 Mesh、灯光等。在本例中，除了场景本身的表示，我们还需要一种方式来表示场景中可以被渲染的每一个 Mesh。</p><section><h4 id=总体功能-1>总体功能<a href=#总体功能-1 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><p>GAMES 202 的代码框架提供了 <code>WebGLRenderer</code> 类来存储和管理整个场景中的摄像机、灯光和 Mesh 等数据，在 <code>engine.ts</code> 的 <code>GAMES202Main</code> 函数中，我们曾通过调用 <code>WebGLRenderer</code> 函数来重新渲染整个场景，其内部实际上是先清空整块画布，接着在有光源的情况下使用两重循环来遍历场景中的所有光源，针对某一个光源再遍历场景中的所有物体，在每个物体渲染前为 Shader 通过 <code>Uniforms</code> 设置光源的位置、强度等信息，再绘制物体，从而实现渲染一个单光源甚至多光源的场景。</p><p>单个 Mesh 的表示和渲染方面，代码框架提供了 <code>MeshRender</code> 来保存渲染一个 Mesh 所需要的 <code>Mesh</code> 对象（包含使用 JavaScript 原生数据类型保存的顶点、法线、纹理坐标等数据）、材质、着色器实例，以及提供与 WebGL 交换数据的 <code>WebGLBuffer</code> 的引用。<code>MeshRender</code> 还提供 <code>draw</code> 方法，在其内先向 WebGL 通过设置 <code>Attributes</code> 来传递各类顶点坐标、法线、纹理坐标等数据，接着通过 <code>gl.uniformXXX</code> 系列方法从材质实例和 <code>draw</code> 函数参数中读取并设置 Shader 的各类 <code>Uniforms</code> 渲染参数，最后调用 <code>gl.drawElements</code> 来实现渲染单个物体。</p></section><section><h4 id=webglrendererts-代码注释><code>WebGLRenderer.ts</code> 代码注释<a href=#webglrendererts-代码注释 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d>// 导入依赖项</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { MeshRender } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "./MeshRender"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#79b8ff> *</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> THREE </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "three"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { PointLight } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../lights/PointLight"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { vec3 } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "gl-matrix"</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>// 保存一组 Transform 参数，包含位移和缩放信息，但保持物体旋转不变</span></span>
<span class=line><span style=color:#6a737d>// Remain rotatation</span></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> class</span><span style=color:#b392f0> TRSTransform</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>    // 位移数据</span></span>
<span class=line><span style=color:#ffab70>    translate</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 缩放数据</span></span>
<span class=line><span style=color:#ffab70>    scale</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>    constructor</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>translate</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> [</span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>], </span><span style=color:#ffab70>scale</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> [</span><span style=color:#79b8ff>1</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1</span><span style=color:#e1e4e8>]) {</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.translate </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> translate;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.scale </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> scale;</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> class</span><span style=color:#b392f0> WebGLRenderer</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>    // 保存场景中所有的 MeshRender</span></span>
<span class=line><span style=color:#ffab70>    meshes</span><span style=color:#f97583>:</span><span style=color:#b392f0> MeshRender</span><span style=color:#e1e4e8>[] </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> [];</span></span>
<span class=line><span style=color:#6a737d>    // 保存场景中所有的光源</span></span>
<span class=line><span style=color:#6a737d>    // 包含光源本身的数据，以及光源模型自己的 MeshRender</span></span>
<span class=line><span style=color:#ffab70>    lights</span><span style=color:#f97583>:</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#ffab70>        entity</span><span style=color:#f97583>:</span><span style=color:#b392f0> PointLight</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>        meshRender</span><span style=color:#f97583>:</span><span style=color:#b392f0> MeshRender</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>    }[] </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> [];</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 保存目标画布的 WebGL 渲染上下文</span></span>
<span class=line><span style=color:#ffab70>    gl</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLRenderingContext</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 保存先前创建的透视投影摄像机的引用</span></span>
<span class=line><span style=color:#ffab70>    camera</span><span style=color:#f97583>:</span><span style=color:#b392f0> THREE</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>PerspectiveCamera</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 构造函数，需要传入 WebGL 渲染上下文和相应的透视投影摄像机</span></span>
<span class=line><span style=color:#f97583>    constructor</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>gl</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLRenderingContext</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>camera</span><span style=color:#f97583>:</span><span style=color:#b392f0> THREE</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>PerspectiveCamera</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.gl </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> gl;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.camera </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> camera;</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 添加一组点光源，除了保存点光源外，并使用光源对应的 Mesh 和材质创建一个光源对应的 MeshRender</span></span>
<span class=line><span style=color:#b392f0>    addLight</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>light</span><span style=color:#f97583>:</span><span style=color:#b392f0> PointLight</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.lights.</span><span style=color:#b392f0>push</span><span style=color:#e1e4e8>({</span></span>
<span class=line><span style=color:#e1e4e8>            entity: light,</span></span>
<span class=line><span style=color:#e1e4e8>            meshRender: </span><span style=color:#f97583>new</span><span style=color:#b392f0> MeshRender</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.gl, light.mesh, light.mat),</span></span>
<span class=line><span style=color:#e1e4e8>        });</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 为场景添加一个 MeshRender</span></span>
<span class=line><span style=color:#b392f0>    addMesh</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>mesh</span><span style=color:#f97583>:</span><span style=color:#b392f0> MeshRender</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.meshes.</span><span style=color:#b392f0>push</span><span style=color:#e1e4e8>(mesh);</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 以 guiParams 包含的位移、缩放参数来重新渲染整个场景</span></span>
<span class=line><span style=color:#b392f0>    render</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>guiParams</span><span style=color:#f97583>:</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#ffab70>        modelTransX</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>        modelTransY</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>        modelTransZ</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>        modelScaleX</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>        modelScaleY</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>        modelScaleZ</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>    }) {</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> gl</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.gl;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 将画布清空，像素充值为不透明黑色，同时重置 Z 深度，并重新启用深度测试</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>clearColor</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>0.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>0.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>0.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>); </span><span style=color:#6a737d>// Clear to black, fully opaque</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>clearDepth</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>); </span><span style=color:#6a737d>// Clear everything</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>enable</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>DEPTH_TEST</span><span style=color:#e1e4e8>); </span><span style=color:#6a737d>// Enable depth testing</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>depthFunc</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>LEQUAL</span><span style=color:#e1e4e8>); </span><span style=color:#6a737d>// Near things obscure far things</span></span>
<span class=line></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>clear</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>COLOR_BUFFER_BIT</span><span style=color:#f97583> |</span><span style=color:#e1e4e8> gl.</span><span style=color:#79b8ff>DEPTH_BUFFER_BIT</span><span style=color:#e1e4e8>);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 让场景中的光源以一种特定的周期性空间曲线路径移动</span></span>
<span class=line><span style=color:#6a737d>        // Handle light</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> timer</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> Date.</span><span style=color:#b392f0>now</span><span style=color:#e1e4e8>() </span><span style=color:#f97583>*</span><span style=color:#79b8ff> 0.00025</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>        let</span><span style=color:#e1e4e8> lightPos</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> [</span></span>
<span class=line><span style=color:#e1e4e8>            Math.</span><span style=color:#b392f0>sin</span><span style=color:#e1e4e8>(timer </span><span style=color:#f97583>*</span><span style=color:#79b8ff> 6</span><span style=color:#e1e4e8>) </span><span style=color:#f97583>*</span><span style=color:#79b8ff> 100</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>            Math.</span><span style=color:#b392f0>cos</span><span style=color:#e1e4e8>(timer </span><span style=color:#f97583>*</span><span style=color:#79b8ff> 4</span><span style=color:#e1e4e8>) </span><span style=color:#f97583>*</span><span style=color:#79b8ff> 150</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>            Math.</span><span style=color:#b392f0>cos</span><span style=color:#e1e4e8>(timer </span><span style=color:#f97583>*</span><span style=color:#79b8ff> 2</span><span style=color:#e1e4e8>) </span><span style=color:#f97583>*</span><span style=color:#79b8ff> 100</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        ];</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.lights.</span><span style=color:#79b8ff>length</span><span style=color:#f97583> !=</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#f97583>            for</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>let</span><span style=color:#e1e4e8> l </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>; l </span><span style=color:#f97583>&#x3C;</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.lights.</span><span style=color:#79b8ff>length</span><span style=color:#e1e4e8>; l</span><span style=color:#f97583>++</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>                // 遍历场景中每一个光源，用当前的新的 lightPos 更新并渲染其 Mesh</span></span>
<span class=line><span style=color:#f97583>                let</span><span style=color:#e1e4e8> trans </span><span style=color:#f97583>=</span><span style=color:#f97583> new</span><span style=color:#b392f0> TRSTransform</span><span style=color:#e1e4e8>(lightPos);</span></span>
<span class=line><span style=color:#79b8ff>                this</span><span style=color:#e1e4e8>.lights[l].meshRender.</span><span style=color:#b392f0>draw</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.camera, trans);</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>                for</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>let</span><span style=color:#e1e4e8> i </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>; i </span><span style=color:#f97583>&#x3C;</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.meshes.</span><span style=color:#79b8ff>length</span><span style=color:#e1e4e8>; i</span><span style=color:#f97583>++</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#f97583>                    const</span><span style=color:#79b8ff> mesh</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.meshes[i];</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>                    // 对场景中每一个 MeshRender</span></span>
<span class=line><span style=color:#6a737d>                    // 先使用 guiParams 设置其位移和缩放</span></span>
<span class=line><span style=color:#f97583>                    const</span><span style=color:#79b8ff> modelTranslation</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> [</span></span>
<span class=line><span style=color:#e1e4e8>                        guiParams.modelTransX,</span></span>
<span class=line><span style=color:#e1e4e8>                        guiParams.modelTransY,</span></span>
<span class=line><span style=color:#e1e4e8>                        guiParams.modelTransZ,</span></span>
<span class=line><span style=color:#e1e4e8>                    ];</span></span>
<span class=line><span style=color:#f97583>                    const</span><span style=color:#79b8ff> modelScale</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> [</span></span>
<span class=line><span style=color:#e1e4e8>                        guiParams.modelScaleX,</span></span>
<span class=line><span style=color:#e1e4e8>                        guiParams.modelScaleY,</span></span>
<span class=line><span style=color:#e1e4e8>                        guiParams.modelScaleZ,</span></span>
<span class=line><span style=color:#e1e4e8>                    ];</span></span>
<span class=line><span style=color:#f97583>                    let</span><span style=color:#e1e4e8> meshTrans </span><span style=color:#f97583>=</span><span style=color:#f97583> new</span><span style=color:#b392f0> TRSTransform</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                        modelTranslation,</span></span>
<span class=line><span style=color:#e1e4e8>                        modelScale</span></span>
<span class=line><span style=color:#e1e4e8>                    );</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>                    // 应用当前 MeshRender 的着色器程序</span></span>
<span class=line><span style=color:#79b8ff>                    this</span><span style=color:#e1e4e8>.gl.</span><span style=color:#b392f0>useProgram</span><span style=color:#e1e4e8>(mesh.shader.program.glShaderProgram);</span></span>
<span class=line><span style=color:#6a737d>                    // 使用当前光源位置设置着色器的参数</span></span>
<span class=line><span style=color:#6a737d>                    // 着色器中关于光源参数的 uLightPos: WebGLUniformLocation 是在着色器初始化时赋值的</span></span>
<span class=line><span style=color:#6a737d>                    // 这里可以认为是将着色器程序中第 uLightPos 号 uniforms 参数的值设置为 lightPos</span></span>
<span class=line><span style=color:#79b8ff>                    this</span><span style=color:#e1e4e8>.gl.</span><span style=color:#b392f0>uniform3fv</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                        mesh.shader.program.uniforms.uLightPos,</span></span>
<span class=line><span style=color:#e1e4e8>                        lightPos</span></span>
<span class=line><span style=color:#e1e4e8>                    );</span></span>
<span class=line><span style=color:#6a737d>                    // 传入摄像机和对应的 trans 来渲染该 Mesh</span></span>
<span class=line><span style=color:#e1e4e8>                    mesh.</span><span style=color:#b392f0>draw</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.camera, meshTrans);</span></span>
<span class=line><span style=color:#e1e4e8>                }</span></span>
<span class=line><span style=color:#e1e4e8>            }</span></span>
<span class=line><span style=color:#e1e4e8>        } </span><span style=color:#f97583>else</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>            // 如果没有任何光源，则跳过灯光渲染，直接渲染 Mesh</span></span>
<span class=line><span style=color:#6a737d>            // Handle mesh(no light)</span></span>
<span class=line><span style=color:#f97583>            for</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>let</span><span style=color:#e1e4e8> i </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>; i </span><span style=color:#f97583>&#x3C;</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.meshes.</span><span style=color:#79b8ff>length</span><span style=color:#e1e4e8>; i</span><span style=color:#f97583>++</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#f97583>                const</span><span style=color:#79b8ff> mesh</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.meshes[i];</span></span>
<span class=line><span style=color:#f97583>                let</span><span style=color:#e1e4e8> trans </span><span style=color:#f97583>=</span><span style=color:#f97583> new</span><span style=color:#b392f0> TRSTransform</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#e1e4e8>                mesh.</span><span style=color:#b392f0>draw</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.camera, trans);</span></span>
<span class=line><span style=color:#e1e4e8>            }</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span></code></pre></section><section><h4 id=meshrenderts-代码注释><code>MeshRender.ts</code> 代码注释<a href=#meshrenderts-代码注释 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { mat4 } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "gl-matrix"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { Mesh } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../objects/Mesh"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { Material } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../materials/Material"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { Shader } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../shaders/Shader"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#79b8ff> *</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> THREE </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "three"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { TRSTransform } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "./WebGLRenderer"</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> class</span><span style=color:#b392f0> MeshRender</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>    // 渲染一个 Mesh 所需要的几组向 WebGL 传递数据的 WebGLBuffer</span></span>
<span class=line><span style=color:#6a737d>    // 这些 WebGLBuffer 都将通过 Attributes 来将 JavaScript 端的数据</span></span>
<span class=line><span style=color:#6a737d>    // 传递给 WebGL</span></span>
<span class=line><span style=color:#f97583>    private</span><span style=color:#ffab70> vertexBuffer</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>    private</span><span style=color:#ffab70> normalBuffer</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>    private</span><span style=color:#ffab70> texcoordBuffer</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>    private</span><span style=color:#ffab70> indicesBuffer</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 保存 WebGL 渲染上下文</span></span>
<span class=line><span style=color:#ffab70>    gl</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLRenderingContext</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 保存 Mesh 本身的顶点坐标、法线、纹理坐标等数据的对象</span></span>
<span class=line><span style=color:#ffab70>    mesh</span><span style=color:#f97583>:</span><span style=color:#b392f0> Mesh</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 保存要渲染 Mesh 所需要的各类参数，包括各种 Uniforms 和 Textures</span></span>
<span class=line><span style=color:#ffab70>    material</span><span style=color:#f97583>:</span><span style=color:#b392f0> Material</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 保存渲染一个 Mesh 所使用的着色器程序，</span></span>
<span class=line><span style=color:#6a737d>    // 在 MeshRender 初始化时进行编译</span></span>
<span class=line><span style=color:#ffab70>    shader</span><span style=color:#f97583>:</span><span style=color:#b392f0> Shader</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>    constructor</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>gl</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLRenderingContext</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>mesh</span><span style=color:#f97583>:</span><span style=color:#b392f0> Mesh</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>material</span><span style=color:#f97583>:</span><span style=color:#b392f0> Material</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>        // 从传入的参数初始化 gl, mesh, material 等数据</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.gl </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> gl;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.mesh </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> mesh;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.material </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> material;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 通过 gl 对象为每一种 buffer 创建实例 </span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.vertexBuffer </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> gl.</span><span style=color:#b392f0>createBuffer</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.normalBuffer </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> gl.</span><span style=color:#b392f0>createBuffer</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.texcoordBuffer </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> gl.</span><span style=color:#b392f0>createBuffer</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.indicesBuffer </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> gl.</span><span style=color:#b392f0>createBuffer</span><span style=color:#e1e4e8>();</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        let</span><span style=color:#e1e4e8> extraAttribs </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> [];</span></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (mesh.hasVertices) {</span></span>
<span class=line><span style=color:#6a737d>            // 如果 mesh 包含顶点坐标信息</span></span>
<span class=line><span style=color:#6a737d>            // 保存该顶点坐标序列在着色器中对应的 attribute 名字</span></span>
<span class=line><span style=color:#e1e4e8>            extraAttribs.</span><span style=color:#b392f0>push</span><span style=color:#e1e4e8>(mesh.verticesName);</span></span>
<span class=line><span style=color:#6a737d>            // 将 mesh 存储在 JavaScript 端的顶点数据拷贝到 WebGL 端的 vertexBuffer</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.vertexBuffer);</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bufferData</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, mesh.vertices, gl.</span><span style=color:#79b8ff>STATIC_DRAW</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>null</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (mesh.hasNormals) {</span></span>
<span class=line><span style=color:#6a737d>            // 如果 mesh 包含法线信息</span></span>
<span class=line><span style=color:#6a737d>            // 保存该法线序列在着色器中对应的 attribute 名字</span></span>
<span class=line><span style=color:#e1e4e8>            extraAttribs.</span><span style=color:#b392f0>push</span><span style=color:#e1e4e8>(mesh.normalsName);</span></span>
<span class=line><span style=color:#6a737d>            // 将 mesh 存储在 JavaScript 端的法线数据拷贝到 WebGL 端的 normalBuffer</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.normalBuffer);</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bufferData</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, mesh.normals, gl.</span><span style=color:#79b8ff>STATIC_DRAW</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>null</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (mesh.hasTexcoords) {</span></span>
<span class=line><span style=color:#6a737d>            // 如果 mesh 包含纹理坐标信息</span></span>
<span class=line><span style=color:#6a737d>            // 保存该纹理坐标序列在着色器中对应的 attribute 名字</span></span>
<span class=line><span style=color:#e1e4e8>            extraAttribs.</span><span style=color:#b392f0>push</span><span style=color:#e1e4e8>(mesh.texcoordsName);</span></span>
<span class=line><span style=color:#6a737d>            // 将 mesh 存储在 JavaScript 端的纹理坐标数据拷贝到 WebGL 端的 texcoordBuffer</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.texcoordBuffer);</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bufferData</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, mesh.texcoords, gl.</span><span style=color:#79b8ff>STATIC_DRAW</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>null</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // mesh 默认需要有顶点索引，用来描述每个三角形由顶点坐标序列中的哪几个顶点构成</span></span>
<span class=line><span style=color:#6a737d>        // 这里将 mesh 包含的顶点索引数据拷贝到 indicesBuffer</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ELEMENT_ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.indicesBuffer);</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>bufferData</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#79b8ff>ELEMENT_ARRAY_BUFFER</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#f97583>            new</span><span style=color:#b392f0> Uint16Array</span><span style=color:#e1e4e8>(mesh.indices),</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#79b8ff>STATIC_DRAW</span></span>
<span class=line><span style=color:#e1e4e8>        );</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ELEMENT_ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>null</span><span style=color:#e1e4e8>);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 将新收集到的 attribute 数据名字添加到材质对象的 attribute 列表中</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.material.</span><span style=color:#b392f0>setMeshAttribs</span><span style=color:#e1e4e8>(extraAttribs);</span></span>
<span class=line><span style=color:#6a737d>        // 重新从 material 对象中编译着色器</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.shader </span><span style=color:#f97583>=</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.material.</span><span style=color:#b392f0>compile</span><span style=color:#e1e4e8>(gl);</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#b392f0>    draw</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>camera</span><span style=color:#f97583>:</span><span style=color:#b392f0> THREE</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>PerspectiveCamera</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>transform</span><span style=color:#f97583>:</span><span style=color:#b392f0> TRSTransform</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> gl</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.gl;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 创建 MVP 变换矩阵，</span></span>
<span class=line><span style=color:#6a737d>        // 其中模型变换和视口变换直接综合到一个 modelViewMatrix 矩阵中</span></span>
<span class=line><span style=color:#f97583>        let</span><span style=color:#e1e4e8> modelViewMatrix </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> mat4.</span><span style=color:#b392f0>create</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#f97583>        let</span><span style=color:#e1e4e8> projectionMatrix </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> mat4.</span><span style=color:#b392f0>create</span><span style=color:#e1e4e8>();</span></span>
<span class=line></span>
<span class=line><span style=color:#e1e4e8>        camera.</span><span style=color:#b392f0>updateMatrixWorld</span><span style=color:#e1e4e8>();</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 坐标变换算法推导：</span></span>
<span class=line><span style=color:#6a737d>        // X 表示顶点原坐标，X‘ 表示变换空间的坐标</span></span>
<span class=line><span style=color:#6a737d>        // P 表示投影变换矩阵，V 表示视口变换矩阵，M 表示模型变换矩阵</span></span>
<span class=line><span style=color:#6a737d>        // T 表示位移变换矩阵，S 表示缩放变换矩阵</span></span>
<span class=line><span style=color:#6a737d>        // M = S(T) = S T</span></span>
<span class=line><span style=color:#6a737d>        // X' = P(V(M(X))) = P V M X</span></span>
<span class=line><span style=color:#6a737d>        // 由矩阵满足交换律，上式可变换为：X' = P (V S T) X</span></span>
<span class=line><span style=color:#6a737d>        // projectionMatrix = P</span></span>
<span class=line><span style=color:#6a737d>        // modelViewMatrix = V S T</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 对摄像机世界坐标求逆即可得到视口变换矩阵 V</span></span>
<span class=line><span style=color:#e1e4e8>        mat4.</span><span style=color:#b392f0>invert</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>            modelViewMatrix,</span></span>
<span class=line><span style=color:#f97583>            new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>(camera.matrixWorld.elements)</span></span>
<span class=line><span style=color:#e1e4e8>        );</span></span>
<span class=line><span style=color:#6a737d>        // modelViewMatrix = V S T</span></span>
<span class=line><span style=color:#e1e4e8>        mat4.</span><span style=color:#b392f0>translate</span><span style=color:#e1e4e8>(modelViewMatrix, modelViewMatrix, transform.translate);</span></span>
<span class=line><span style=color:#e1e4e8>        mat4.</span><span style=color:#b392f0>scale</span><span style=color:#e1e4e8>(modelViewMatrix, modelViewMatrix, transform.scale);</span></span>
<span class=line><span style=color:#6a737d>        // projectionMatrix = P</span></span>
<span class=line><span style=color:#e1e4e8>        mat4.</span><span style=color:#b392f0>copy</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>            projectionMatrix,</span></span>
<span class=line><span style=color:#f97583>            new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>(camera.projectionMatrix.elements)</span></span>
<span class=line><span style=color:#e1e4e8>        );</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.mesh.hasVertices) {</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> numComponents</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 3</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> type</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> gl.</span><span style=color:#79b8ff>FLOAT</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> normalize</span><span style=color:#f97583> =</span><span style=color:#79b8ff> false</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> stride</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> offset</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>            // 指示 WebGL 我们系统从 vertexBuffer 中提供 ARRAY_BUFFER 类型数据</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.vertexBuffer);</span></span>
<span class=line><span style=color:#6a737d>            // 将 vertexBuffer 绑定到顶点坐标在 Shader 中对应的地址</span></span>
<span class=line><span style=color:#6a737d>            // 地址/位置由 shader.program.attribs 提供，在编译 shader 时确定</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>vertexAttribPointer</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#79b8ff>                this</span><span style=color:#e1e4e8>.shader.program.attribs[</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.mesh.verticesName],</span></span>
<span class=line><span style=color:#e1e4e8>                numComponents,</span></span>
<span class=line><span style=color:#e1e4e8>                type,</span></span>
<span class=line><span style=color:#e1e4e8>                normalize,</span></span>
<span class=line><span style=color:#e1e4e8>                stride,</span></span>
<span class=line><span style=color:#e1e4e8>                offset</span></span>
<span class=line><span style=color:#e1e4e8>            );</span></span>
<span class=line><span style=color:#6a737d>            // 启用 vertexBuffer 对应地址的数据</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>enableVertexAttribArray</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#79b8ff>                this</span><span style=color:#e1e4e8>.shader.program.attribs[</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.mesh.verticesName]</span></span>
<span class=line><span style=color:#e1e4e8>            );</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.mesh.hasNormals) {</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> numComponents</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 3</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> type</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> gl.</span><span style=color:#79b8ff>FLOAT</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> normalize</span><span style=color:#f97583> =</span><span style=color:#79b8ff> false</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> stride</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> offset</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>            // 指示 WebGL 我们系统从 normalBuffer 中提供 ARRAY_BUFFER 类型数据</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.normalBuffer);</span></span>
<span class=line><span style=color:#6a737d>            // 将 normalBuffer 绑定到顶点坐标在 Shader 中对应的地址</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>vertexAttribPointer</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#79b8ff>                this</span><span style=color:#e1e4e8>.shader.program.attribs[</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.mesh.normalsName],</span></span>
<span class=line><span style=color:#e1e4e8>                numComponents,</span></span>
<span class=line><span style=color:#e1e4e8>                type,</span></span>
<span class=line><span style=color:#e1e4e8>                normalize,</span></span>
<span class=line><span style=color:#e1e4e8>                stride,</span></span>
<span class=line><span style=color:#e1e4e8>                offset</span></span>
<span class=line><span style=color:#e1e4e8>            );</span></span>
<span class=line><span style=color:#6a737d>            // 启用 normalBuffer 对应地址的数据</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>enableVertexAttribArray</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#79b8ff>                this</span><span style=color:#e1e4e8>.shader.program.attribs[</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.mesh.normalsName]</span></span>
<span class=line><span style=color:#e1e4e8>            );</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.mesh.hasTexcoords) {</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> numComponents</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 2</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> type</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> gl.</span><span style=color:#79b8ff>FLOAT</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> normalize</span><span style=color:#f97583> =</span><span style=color:#79b8ff> false</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> stride</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> offset</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>            // 指示 WebGL 我们系统从 texcoordBuffer 中提供 ARRAY_BUFFER 类型数据</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.texcoordBuffer);</span></span>
<span class=line><span style=color:#6a737d>            // 将 texcoordBuffer 绑定到顶点坐标在 Shader 中对应的地址</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>vertexAttribPointer</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#79b8ff>                this</span><span style=color:#e1e4e8>.shader.program.attribs[</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.mesh.texcoordsName],</span></span>
<span class=line><span style=color:#e1e4e8>                numComponents,</span></span>
<span class=line><span style=color:#e1e4e8>                type,</span></span>
<span class=line><span style=color:#e1e4e8>                normalize,</span></span>
<span class=line><span style=color:#e1e4e8>                stride,</span></span>
<span class=line><span style=color:#e1e4e8>                offset</span></span>
<span class=line><span style=color:#e1e4e8>            );</span></span>
<span class=line><span style=color:#6a737d>            // 启用 texcoordBuffer 对应地址的数据</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>enableVertexAttribArray</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#79b8ff>                this</span><span style=color:#e1e4e8>.shader.program.attribs[</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.mesh.texcoordsName]</span></span>
<span class=line><span style=color:#e1e4e8>            );</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#6a737d>        // 指示 WebGL 我们系统从 indicesBuffer 中提供 ARRAY_BUFFER 类型数据</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>bindBuffer</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>ELEMENT_ARRAY_BUFFER</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.indicesBuffer);</span></span>
<span class=line><span style=color:#6a737d>        // 将 indicesBuffer 绑定到顶点坐标在 Shader 中对应的地址</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>useProgram</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.shader.program.glShaderProgram);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 向 Shader 中对应地址设置投影变换矩阵</span></span>
<span class=line><span style=color:#6a737d>        // 视口变换数据在 Shader 中的地址，即 WebGLUniformLocation，</span></span>
<span class=line><span style=color:#6a737d>        // 同样由着色器编译时确定</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>uniformMatrix4fv</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.shader.program.uniforms.uProjectionMatrix,</span></span>
<span class=line><span style=color:#79b8ff>            false</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>            projectionMatrix</span></span>
<span class=line><span style=color:#e1e4e8>        );</span></span>
<span class=line><span style=color:#6a737d>        // 向 Shader 中对应地址设置模型-视口变换矩阵</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>uniformMatrix4fv</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.shader.program.uniforms.uModelViewMatrix,</span></span>
<span class=line><span style=color:#79b8ff>            false</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>            modelViewMatrix</span></span>
<span class=line><span style=color:#e1e4e8>        );</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 向 Shader 中对应地址设置摄像机坐标</span></span>
<span class=line><span style=color:#6a737d>        // Specific the camera uniforms</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>uniform3fv</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.shader.program.uniforms.uCameraPos, [</span></span>
<span class=line><span style=color:#e1e4e8>            camera.position.x,</span></span>
<span class=line><span style=color:#e1e4e8>            camera.position.y,</span></span>
<span class=line><span style=color:#e1e4e8>            camera.position.z,</span></span>
<span class=line><span style=color:#e1e4e8>        ]);</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        for</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>let</span><span style=color:#e1e4e8> k </span><span style=color:#f97583>in</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.material.uniforms) {</span></span>
<span class=line><span style=color:#6a737d>            // 遍历材质中包含的其余 uniforms 参数，判断其类型，</span></span>
<span class=line><span style=color:#6a737d>            // 并向 Shader 对应位置设置 Uniforms 参数的值</span></span>
<span class=line><span style=color:#6a737d>            // 本代码框架支持设置 1 维整数，1 维浮点数，3 维浮点数，4 维浮点数</span></span>
<span class=line><span style=color:#6a737d>            // 以及材质数据</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> uniform</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.material.uniforms[k];</span></span>
<span class=line><span style=color:#f97583>            if</span><span style=color:#e1e4e8> (uniform.type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "matrix4fv"</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#e1e4e8>                gl.</span><span style=color:#b392f0>uniformMatrix4fv</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#79b8ff>                    this</span><span style=color:#e1e4e8>.shader.program.uniforms[k],</span></span>
<span class=line><span style=color:#79b8ff>                    false</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>                    uniform.value</span></span>
<span class=line><span style=color:#e1e4e8>                );</span></span>
<span class=line><span style=color:#e1e4e8>            } </span><span style=color:#f97583>else</span><span style=color:#f97583> if</span><span style=color:#e1e4e8> (uniform.type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "3fv"</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#e1e4e8>                gl.</span><span style=color:#b392f0>uniform3fv</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.shader.program.uniforms[k], uniform.value);</span></span>
<span class=line><span style=color:#e1e4e8>            } </span><span style=color:#f97583>else</span><span style=color:#f97583> if</span><span style=color:#e1e4e8> (uniform.type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "1f"</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#e1e4e8>                gl.</span><span style=color:#b392f0>uniform1f</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.shader.program.uniforms[k], uniform.value);</span></span>
<span class=line><span style=color:#e1e4e8>            } </span><span style=color:#f97583>else</span><span style=color:#f97583> if</span><span style=color:#e1e4e8> (uniform.type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "1i"</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#e1e4e8>                gl.</span><span style=color:#b392f0>uniform1i</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.shader.program.uniforms[k], uniform.value);</span></span>
<span class=line><span style=color:#e1e4e8>            } </span><span style=color:#f97583>else</span><span style=color:#f97583> if</span><span style=color:#e1e4e8> (uniform.type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "texture"</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#e1e4e8>                gl.</span><span style=color:#b392f0>activeTexture</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TEXTURE0</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>                gl.</span><span style=color:#b392f0>bindTexture</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>, uniform.value.texture);</span></span>
<span class=line><span style=color:#e1e4e8>                gl.</span><span style=color:#b392f0>uniform1i</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.shader.program.uniforms[k], </span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>            }</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line></span>
<span class=line><span style=color:#e1e4e8>        {</span></span>
<span class=line><span style=color:#6a737d>            // 所有参数设置完成后，以 TRIANGLES 使用顶点索引渲染模型</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> vertexCount</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.mesh.count;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> type</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> gl.</span><span style=color:#79b8ff>UNSIGNED_SHORT</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> offset</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>drawElements</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TRIANGLES</span><span style=color:#e1e4e8>, vertexCount, type, offset);</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span></code></pre></section></section><section><h3 id=mesh>Mesh<a href=#mesh class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h3><p><code>Mesh</code> 是直接存储模型网格体的数据类型。</p><section><h4 id=总体功能-2>总体功能<a href=#总体功能-2 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><p>要使用 <code>Mesh</code> 来存储一个网格体，需要传入四个参数：<code>verticesAttrib</code>，<code>normalsAttrib</code>，<code>texcoordsAttrib</code> 和 <code>indices</code> 前三个参数的数据类型为 <code>AttribType</code>，其内的 <code>name</code> 字段表明该 <code>Attribute</code> 在 Shader 中的变量名称是什么，使用 <code>Float32Array</code> 类型的 <code>array</code> 来存储数据本身。</p><p><code>number[]</code> 类型的 <code>indices</code> 则是网格体的顶点索引。网格体中两个三角形的某两个顶点可能是共用的，如果以三角形的三个顶点的顺序直接存储整个网格体，将导致某些顶点的数据重复存储，导致空间上的浪费，因此一般使用顶点索引来解决这个问题，顶点索引序列的每三个元素表示构成一个三角形的三个顶点在顶点、法线、纹理坐标数组中的索引是哪一个，以额外一次访存的代价实现大幅减少顶点存储数量的性能优化。</p></section><section><h4 id=meshts-代码注释><code>Mesh.ts</code> 代码注释<a href=#meshts-代码注释 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d>// 声明 Attribute 的类型</span></span>
<span class=line><span style=color:#f97583>interface</span><span style=color:#b392f0> AttribType</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>    // 表明该 Attribute 在 Shader 中的变量名</span></span>
<span class=line><span style=color:#ffab70>    name</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 将要作为 Attribute 的数据本身</span></span>
<span class=line><span style=color:#ffab70>    array</span><span style=color:#f97583>:</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> class</span><span style=color:#b392f0> Mesh</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>    // 顶点索引</span></span>
<span class=line><span style=color:#ffab70>    indices</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>[];</span></span>
<span class=line><span style=color:#6a737d>    // 顶点索引的长度</span></span>
<span class=line><span style=color:#ffab70>    count</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 是否包含顶点坐标</span></span>
<span class=line><span style=color:#ffab70>    hasVertices</span><span style=color:#f97583>:</span><span style=color:#79b8ff> boolean</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 是否包含法线</span></span>
<span class=line><span style=color:#ffab70>    hasNormals</span><span style=color:#f97583>:</span><span style=color:#79b8ff> boolean</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 是否包含纹理坐标</span></span>
<span class=line><span style=color:#ffab70>    hasTexcoords</span><span style=color:#f97583>:</span><span style=color:#79b8ff> boolean</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 顶点坐标数据序列</span></span>
<span class=line><span style=color:#ffab70>    vertices</span><span style=color:#f97583>:</span><span style=color:#b392f0> Float32Array</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#6a737d>    // 顶点坐标数据在 Shader 中的变量名</span></span>
<span class=line><span style=color:#ffab70>    verticesName</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#f97583> =</span><span style=color:#9ecbff> ""</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 法线数据序列</span></span>
<span class=line><span style=color:#ffab70>    normals</span><span style=color:#f97583>:</span><span style=color:#b392f0> Float32Array</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#6a737d>    // 法线数据在 Shader 中的变量名</span></span>
<span class=line><span style=color:#ffab70>    normalsName</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#f97583> =</span><span style=color:#9ecbff> ""</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 纹理坐标数据序列</span></span>
<span class=line><span style=color:#ffab70>    texcoords</span><span style=color:#f97583>:</span><span style=color:#b392f0> Float32Array</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#6a737d>    // 纹理坐标数据在 Shader 中的变量名</span></span>
<span class=line><span style=color:#ffab70>    texcoordsName</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#f97583> =</span><span style=color:#9ecbff> ""</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>    constructor</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#ffab70>        verticesAttrib</span><span style=color:#f97583>:</span><span style=color:#b392f0> AttribType</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>        normalsAttrib</span><span style=color:#f97583>:</span><span style=color:#b392f0> AttribType</span><span style=color:#f97583> |</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>        texcoordsAttrib</span><span style=color:#f97583>:</span><span style=color:#b392f0> AttribType</span><span style=color:#f97583> |</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>        indices</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>[]</span></span>
<span class=line><span style=color:#e1e4e8>    ) {</span></span>
<span class=line><span style=color:#6a737d>        // 初始化顶点索引数据</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.indices </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> indices;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.count </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> indices.</span><span style=color:#79b8ff>length</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>        // 默认没有顶点坐标、法线、纹理坐标数据</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.hasVertices </span><span style=color:#f97583>=</span><span style=color:#79b8ff> false</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.hasNormals </span><span style=color:#f97583>=</span><span style=color:#79b8ff> false</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.hasTexcoords </span><span style=color:#f97583>=</span><span style=color:#79b8ff> false</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>        let</span><span style=color:#e1e4e8> extraAttribs </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> [];</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (verticesAttrib </span><span style=color:#f97583>!=</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>            // 如果有顶点坐标数据，则赋值</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.hasVertices </span><span style=color:#f97583>=</span><span style=color:#79b8ff> true</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.vertices </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> verticesAttrib.array;</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.verticesName </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> verticesAttrib.name;</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (normalsAttrib </span><span style=color:#f97583>!=</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>            // 如果有法线数据，则赋值</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.hasNormals </span><span style=color:#f97583>=</span><span style=color:#79b8ff> true</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.normals </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> normalsAttrib.array;</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.normalsName </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> normalsAttrib.name;</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (texcoordsAttrib </span><span style=color:#f97583>!=</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>            // 如果有纹理坐标数据，则赋值</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.hasTexcoords </span><span style=color:#f97583>=</span><span style=color:#79b8ff> true</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.texcoords </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> texcoordsAttrib.array;</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.texcoordsName </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> texcoordsAttrib.name;</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>    static</span><span style=color:#b392f0> cube</span><span style=color:#e1e4e8>() {</span></span>
<span class=line><span style=color:#6a737d>        // 预先定义一个边长为 1 的立方体 Mesh，方便后续使用</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> positions</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> [</span></span>
<span class=line><span style=color:#6a737d>            // Front face</span></span>
<span class=line><span style=color:#f97583>            -</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#6a737d>            // Back face</span></span>
<span class=line><span style=color:#f97583>            -</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#6a737d>            // Top face</span></span>
<span class=line><span style=color:#f97583>            -</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#6a737d>            // Bottom face</span></span>
<span class=line><span style=color:#f97583>            -</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#6a737d>            // Right face</span></span>
<span class=line><span style=color:#79b8ff>            1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#6a737d>            // Left face</span></span>
<span class=line><span style=color:#f97583>            -</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>-</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        ];</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> indices</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> [</span></span>
<span class=line><span style=color:#79b8ff>            0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>1</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>2</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>2</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>3</span><span style=color:#e1e4e8>, </span><span style=color:#6a737d>// front</span></span>
<span class=line><span style=color:#79b8ff>            4</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>5</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>6</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>4</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>6</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>7</span><span style=color:#e1e4e8>, </span><span style=color:#6a737d>// back </span></span>
<span class=line><span style=color:#79b8ff>            8</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>9</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>10</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>8</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>10</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>11</span><span style=color:#e1e4e8>, </span><span style=color:#6a737d>// top</span></span>
<span class=line><span style=color:#79b8ff>            12</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>13</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>14</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>12</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>14</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>15</span><span style=color:#e1e4e8>, </span><span style=color:#6a737d>// bottom</span></span>
<span class=line><span style=color:#79b8ff>            16</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>17</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>18</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>16</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>18</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>19</span><span style=color:#e1e4e8>, </span><span style=color:#6a737d>// right</span></span>
<span class=line><span style=color:#79b8ff>            20</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>21</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>22</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>20</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>22</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>23</span><span style=color:#e1e4e8>, </span><span style=color:#6a737d>// left</span></span>
<span class=line><span style=color:#e1e4e8>        ];</span></span>
<span class=line><span style=color:#f97583>        return</span><span style=color:#f97583> new</span><span style=color:#b392f0> Mesh</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>            { name: </span><span style=color:#9ecbff>"aVertexPosition"</span><span style=color:#e1e4e8>, array: </span><span style=color:#f97583>new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>(positions) },</span></span>
<span class=line><span style=color:#79b8ff>            null</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#79b8ff>            null</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>            indices</span></span>
<span class=line><span style=color:#e1e4e8>        );</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span></code></pre></section></section><section><h3 id=material>Material<a href=#material class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h3><p>材质 <code>Material</code> 的概念是本项目需要理解的重难点内容。</p><p>在光线追踪渲染中，一种物体表面的材质定义了光线到达该表面时反射的方向与起始点，体现但不仅限于 BRDF 定义的双向反射分布情况，纹理则决定了某种颜色的光在经过该表面反射后的新光线是什么颜色的；而在光栅化渲染中，材质定义了为该表面某一个像素进行着色的过程中所需要的各类参数，以及如何使用这些参数和场景中的各类信息来计算该像素颜色的值。</p><section><h4 id=总体功能-3>总体功能<a href=#总体功能-3 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><p>GAMES 202 代码框架的 <code>Material</code> 类属于上述光栅化渲染的材质类，其内部的 <code>flatten_uniforms: string[]</code> 变量存储了渲染该材质的着色器所需的所有 <code>Uniforms</code> 变量的名称；<code>flatten_attribs: string[]</code> 和 <code>attribs: string</code> 则存储了所有 <code>Attributes</code> 类型的顶点数据的名称；<code>uniforms</code> 则以 <code>Uniforms</code> 类型变量的名称为 <code>key</code>，以具体的数据类型和数据本身构成的对象为 <code>value</code>，存储渲染该材质所需的各类数值、纹理等数据参数。</p></section><section><h4 id=materialts-代码注释><code>Material.ts</code> 代码注释<a href=#materialts-代码注释 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { Shader } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../shaders/Shader"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { vec3, mat4 } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> 'gl-matrix'</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { Texture } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../textures/Texture"</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>// 定义 Uniforms 的复合类型，通过 type 来判断 uniform 的类型，并给出正确类型的值</span></span>
<span class=line><span style=color:#f97583>type</span><span style=color:#b392f0> Uniform</span><span style=color:#f97583> =</span></span>
<span class=line><span style=color:#f97583>    |</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#ffab70>          type</span><span style=color:#f97583>:</span><span style=color:#9ecbff> "texture"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>          value</span><span style=color:#f97583>:</span><span style=color:#b392f0> Texture</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>      }</span></span>
<span class=line><span style=color:#f97583>    |</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#ffab70>          type</span><span style=color:#f97583>:</span><span style=color:#9ecbff> "1i"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>          value</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>      }</span></span>
<span class=line><span style=color:#f97583>    |</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#ffab70>          type</span><span style=color:#f97583>:</span><span style=color:#9ecbff> "1f"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>          value</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>      }</span></span>
<span class=line><span style=color:#f97583>    |</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#ffab70>          type</span><span style=color:#f97583>:</span><span style=color:#9ecbff> "3fv"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>          value</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>      }</span></span>
<span class=line><span style=color:#f97583>    |</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#ffab70>          type</span><span style=color:#f97583>:</span><span style=color:#9ecbff> "uKd"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>          value</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>[];</span></span>
<span class=line><span style=color:#e1e4e8>      }</span></span>
<span class=line><span style=color:#f97583>    |</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#ffab70>          type</span><span style=color:#f97583>:</span><span style=color:#9ecbff> "matrix4fv"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>          value</span><span style=color:#f97583>:</span><span style=color:#b392f0> mat4</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>      };</span></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> class</span><span style=color:#b392f0> Material</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>    // 保存所有 uniform 变量的名称</span></span>
<span class=line><span style=color:#f97583>    private</span><span style=color:#ffab70> flatten_uniforms</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 保存所有 attribute 变量的名称</span></span>
<span class=line><span style=color:#f97583>    private</span><span style=color:#ffab70> flatten_attribs</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // vertex shader 的源码</span></span>
<span class=line><span style=color:#f97583>    private</span><span style=color:#ffab70> vsSrc</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // fragment shader 的源码</span></span>
<span class=line><span style=color:#f97583>    private</span><span style=color:#ffab70> fsSrc</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // uniform 变量与值的对应关系</span></span>
<span class=line><span style=color:#ffab70>    uniforms</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 保存所有 attribute 变量的名称</span></span>
<span class=line><span style=color:#ffab70>    attribs</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // Uniforms is a map, attribs is a Array</span></span>
<span class=line><span style=color:#f97583>    constructor</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#ffab70>        uniforms</span><span style=color:#f97583>:</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#e1e4e8>            [</span><span style=color:#ffab70>index</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>]</span><span style=color:#f97583>:</span><span style=color:#b392f0> Uniform</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>        },</span></span>
<span class=line><span style=color:#ffab70>        attribs</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>[],</span></span>
<span class=line><span style=color:#ffab70>        vsSrc</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>        fsSrc</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span></span>
<span class=line><span style=color:#e1e4e8>    ) {</span></span>
<span class=line><span style=color:#6a737d>        // 初始化 uniforms, attribs 与着色器源码</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.uniforms </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> uniforms;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.attribs </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> attribs;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.vsSrc </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> vsSrc;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.fsSrc </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> fsSrc;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 所有材质着色器都默认具有</span></span>
<span class=line><span style=color:#6a737d>        // 位移-视口变换矩阵，投影变换矩阵</span></span>
<span class=line><span style=color:#6a737d>        // 摄像机位置，光源位置参数</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.flatten_uniforms </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> [</span></span>
<span class=line><span style=color:#9ecbff>            "uModelViewMatrix"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#9ecbff>            "uProjectionMatrix"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#9ecbff>            "uCameraPos"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#9ecbff>            "uLightPos"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        ];</span></span>
<span class=line><span style=color:#6a737d>        // 将其他 uniforms 的参数名添加到 flatten_uniforms 中</span></span>
<span class=line><span style=color:#f97583>        for</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>let</span><span style=color:#e1e4e8> k </span><span style=color:#f97583>in</span><span style=color:#e1e4e8> uniforms) {</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.flatten_uniforms.</span><span style=color:#b392f0>push</span><span style=color:#e1e4e8>(k);</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#6a737d>        // 保持 flatten_attribs 和 attribs 一致</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.flatten_attribs </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> attribs;</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#b392f0>    setMeshAttribs</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>extraAttribs</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>[]) {</span></span>
<span class=line><span style=color:#6a737d>        // 添加额外的 Attribute 变量名</span></span>
<span class=line><span style=color:#f97583>        for</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>let</span><span style=color:#e1e4e8> i </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>; i </span><span style=color:#f97583>&#x3C;</span><span style=color:#e1e4e8> extraAttribs.</span><span style=color:#79b8ff>length</span><span style=color:#e1e4e8>; i</span><span style=color:#f97583>++</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#79b8ff>            this</span><span style=color:#e1e4e8>.flatten_attribs.</span><span style=color:#b392f0>push</span><span style=color:#e1e4e8>(extraAttribs[i]);</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#b392f0>    compile</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>gl</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLRenderingContext</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>        // 从源码编译 Shader，返回着色器程序和各类 Attribute，Uniform 变量名与地址的对应关系</span></span>
<span class=line><span style=color:#f97583>        return</span><span style=color:#f97583> new</span><span style=color:#b392f0> Shader</span><span style=color:#e1e4e8>(gl, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.vsSrc, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.fsSrc, {</span></span>
<span class=line><span style=color:#e1e4e8>            uniforms: </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.flatten_uniforms,</span></span>
<span class=line><span style=color:#e1e4e8>            attribs: </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.flatten_attribs,</span></span>
<span class=line><span style=color:#e1e4e8>        });</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span></code></pre></section></section><section><h3 id=shader>Shader<a href=#shader class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h3><p>本节是本项目中最接近底层的内容，我们将讲述如何通过传入源码来获得一个由 WebGL 编译好的着色器子程序的，理解这一切的成本仅仅是了解 WebGL 的基本使用方法。</p><section><h4 id=总体功能-4>总体功能<a href=#总体功能-4 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><p>GAMES 202 代码框架中 <code>Shader</code> 类型的基本任务是从 <code>Material</code> 端调用 <code>Shader</code> 的构造函数，通过传入 Vertex Shader 和 Fragment Shader 的源码来编译并链接形成完整的着色器程序。</p><p>此外，由于在着色器程序之上设置 <code>Attributes</code> 和 <code>Uniforms</code> 值的操作是非常频繁的，而一般要设置它们的值，一般要先从 WebGL 上下文中获取它们的地址，再将值设置到对应的地址上。为了避免反复获取变量地址的过程带来的麻烦，<code>Shader</code> 类还提供 <code>addShaderLocations</code> 的功能，通过传入一组 <code>Attributes</code> 和 <code>Uniforms</code> 的名称，指示 <code>Shader</code> 类将这些变量名称对应的地址（索引、位置）保存到 <code>ProgramInfo</code> 类的 <code>uniforms</code> 和 <code>attribs</code> 字段中，<code>ProgramInfo</code> 还通过 <code>glShaderProgram</code> 字段保存编译好的着色器程序的引用。</p></section><section><h4 id=shaderts-代码注释><code>Shader.ts</code> 代码注释<a href=#shaderts-代码注释 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d>// 一组着色器 attributes 和 uniforms 变量名字的记录</span></span>
<span class=line><span style=color:#6a737d>// 用于指示从编译好的着色器中查找对变量对应的地址</span></span>
<span class=line><span style=color:#f97583>interface</span><span style=color:#b392f0> ShaderLocations</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#ffab70>    uniforms</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>[] </span><span style=color:#f97583>|</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>    attribs</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>[] </span><span style=color:#f97583>|</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>// 存储着色器信息的一组变量</span></span>
<span class=line><span style=color:#f97583>interface</span><span style=color:#b392f0> ProgramInfo</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>    // 编译好的着色器程序的引用</span></span>
<span class=line><span style=color:#ffab70>    glShaderProgram</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLProgram</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // key 表示着色器程序中某个 uniform 变量的名字</span></span>
<span class=line><span style=color:#6a737d>    // value 表示该名字对应的地址（位置）</span></span>
<span class=line><span style=color:#ffab70>    uniforms</span><span style=color:#f97583>:</span><span style=color:#e1e4e8> { [</span><span style=color:#ffab70>index</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>]</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLUniformLocation</span><span style=color:#e1e4e8> };</span></span>
<span class=line><span style=color:#6a737d>    // key 表示着色器程序中某个 attribute 变量的名字</span></span>
<span class=line><span style=color:#6a737d>    // value 表示该名字对应的索引</span></span>
<span class=line><span style=color:#ffab70>    attribs</span><span style=color:#f97583>:</span><span style=color:#e1e4e8> { [</span><span style=color:#ffab70>index</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>]</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8> };</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> class</span><span style=color:#b392f0> Shader</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#ffab70>    gl</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLRenderingContext</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#ffab70>    program</span><span style=color:#f97583>:</span><span style=color:#b392f0> ProgramInfo</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>    constructor</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#ffab70>        gl</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLRenderingContext</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>        vsSrc</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>        fsSrc</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>        shaderLocations</span><span style=color:#f97583>:</span><span style=color:#b392f0> ShaderLocations</span></span>
<span class=line><span style=color:#e1e4e8>    ) {</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.gl </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> gl;</span></span>
<span class=line><span style=color:#6a737d>        // 从传入的源码中分别编译顶点着色器和片元着色器</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> vs</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>compileShader</span><span style=color:#e1e4e8>(vsSrc, gl.</span><span style=color:#79b8ff>VERTEX_SHADER</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> fs</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>compileShader</span><span style=color:#e1e4e8>(fsSrc, gl.</span><span style=color:#79b8ff>FRAGMENT_SHADER</span><span style=color:#e1e4e8>);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 将编译好的着色器进行链接操作，</span></span>
<span class=line><span style=color:#6a737d>        // 并根据 shaderLocations 中的变量名查找出这些变量名在着色器程序中的位置</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.program </span><span style=color:#f97583>=</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>addShaderLocations</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>            {</span></span>
<span class=line><span style=color:#e1e4e8>                glShaderProgram: </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>linkShader</span><span style=color:#e1e4e8>(vs, fs),</span></span>
<span class=line><span style=color:#e1e4e8>                uniforms: {},</span></span>
<span class=line><span style=color:#e1e4e8>                attribs: {},</span></span>
<span class=line><span style=color:#e1e4e8>            },</span></span>
<span class=line><span style=color:#e1e4e8>            shaderLocations</span></span>
<span class=line><span style=color:#e1e4e8>        );</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 通过提供的源码与类型编译着色器</span></span>
<span class=line><span style=color:#b392f0>    compileShader</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>shaderSource</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>shaderType</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> gl</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.gl;</span></span>
<span class=line><span style=color:#6a737d>        // 创建一个 WebGL 着色器实例</span></span>
<span class=line><span style=color:#f97583>        var</span><span style=color:#e1e4e8> shader </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> gl.</span><span style=color:#b392f0>createShader</span><span style=color:#e1e4e8>(shaderType);</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (shader </span><span style=color:#f97583>===</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>) </span><span style=color:#f97583>throw</span><span style=color:#9ecbff> "shader creator error"</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 设置着色器源码与类型</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>shaderSource</span><span style=color:#e1e4e8>(shader, shaderSource);</span></span>
<span class=line><span style=color:#6a737d>        // 编译着色器</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>compileShader</span><span style=color:#e1e4e8>(shader);</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>!</span><span style=color:#e1e4e8>gl.</span><span style=color:#b392f0>getShaderParameter</span><span style=color:#e1e4e8>(shader, gl.</span><span style=color:#79b8ff>COMPILE_STATUS</span><span style=color:#e1e4e8>)) {</span></span>
<span class=line><span style=color:#6a737d>            // 编译出错时打印错误信息</span></span>
<span class=line><span style=color:#e1e4e8>            console.</span><span style=color:#b392f0>error</span><span style=color:#e1e4e8>(shaderSource);</span></span>
<span class=line><span style=color:#e1e4e8>            console.</span><span style=color:#b392f0>error</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#9ecbff>                "shader compiler error:</span><span style=color:#79b8ff>\n</span><span style=color:#9ecbff>"</span><span style=color:#f97583> +</span><span style=color:#e1e4e8> gl.</span><span style=color:#b392f0>getShaderInfoLog</span><span style=color:#e1e4e8>(shader)</span></span>
<span class=line><span style=color:#e1e4e8>            );</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        return</span><span style=color:#e1e4e8> shader;</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 通过提供的顶点和片元着色器来链接并返回一个完整的着色器程序</span></span>
<span class=line><span style=color:#b392f0>    linkShader</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>vs</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLShader</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>fs</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLShader</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> gl</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.gl;</span></span>
<span class=line><span style=color:#6a737d>        // 创建一个 WebGL 着色器程序实例</span></span>
<span class=line><span style=color:#f97583>        var</span><span style=color:#e1e4e8> prog </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> gl.</span><span style=color:#b392f0>createProgram</span><span style=color:#e1e4e8>();</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>!</span><span style=color:#e1e4e8>prog) {</span></span>
<span class=line><span style=color:#f97583>            throw</span><span style=color:#9ecbff> "shader creator error"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 添加顶点着色器</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>attachShader</span><span style=color:#e1e4e8>(prog, vs);</span></span>
<span class=line><span style=color:#6a737d>        // 添加片元着色器</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>attachShader</span><span style=color:#e1e4e8>(prog, fs);</span></span>
<span class=line><span style=color:#6a737d>        // 链接两个着色器</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>linkProgram</span><span style=color:#e1e4e8>(prog);</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>!</span><span style=color:#e1e4e8>gl.</span><span style=color:#b392f0>getProgramParameter</span><span style=color:#e1e4e8>(prog, gl.</span><span style=color:#79b8ff>LINK_STATUS</span><span style=color:#e1e4e8>)) {</span></span>
<span class=line><span style=color:#6a737d>            // 链接出错时打印错误信息</span></span>
<span class=line><span style=color:#f97583>            throw</span><span style=color:#9ecbff> `shader linker error:</span><span style=color:#79b8ff>\n</span><span style=color:#9ecbff> ${</span><span style=color:#e1e4e8>gl</span><span style=color:#9ecbff>.</span><span style=color:#b392f0>getProgramInfoLog</span><span style=color:#9ecbff>(</span><span style=color:#e1e4e8>prog</span><span style=color:#9ecbff>)</span><span style=color:#9ecbff>}`</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#f97583>        return</span><span style=color:#e1e4e8> prog;</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line></span>
<span class=line><span style=color:#b392f0>    addShaderLocations</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#ffab70>        result</span><span style=color:#f97583>:</span><span style=color:#b392f0> ProgramInfo</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>        shaderLocations</span><span style=color:#f97583>:</span><span style=color:#b392f0> ShaderLocations</span><span style=color:#f97583> |</span><span style=color:#79b8ff> null</span></span>
<span class=line><span style=color:#e1e4e8>    ) {</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> gl</span><span style=color:#f97583> =</span><span style=color:#79b8ff> this</span><span style=color:#e1e4e8>.gl;</span></span>
<span class=line><span style=color:#6a737d>        // 初始化存储 uniform, attribute 名称与地址的对象的索引</span></span>
<span class=line><span style=color:#e1e4e8>        result.uniforms </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> {};</span></span>
<span class=line><span style=color:#e1e4e8>        result.attribs </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> {};</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (</span></span>
<span class=line><span style=color:#e1e4e8>            shaderLocations </span><span style=color:#f97583>&#x26;&#x26;</span></span>
<span class=line><span style=color:#e1e4e8>            shaderLocations.uniforms </span><span style=color:#f97583>&#x26;&#x26;</span></span>
<span class=line><span style=color:#e1e4e8>            shaderLocations.uniforms.</span><span style=color:#79b8ff>length</span></span>
<span class=line><span style=color:#e1e4e8>        ) {</span></span>
<span class=line><span style=color:#f97583>            for</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>let</span><span style=color:#e1e4e8> i </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>; i </span><span style=color:#f97583>&#x3C;</span><span style=color:#e1e4e8> shaderLocations.uniforms.</span><span style=color:#79b8ff>length</span><span style=color:#e1e4e8>; </span><span style=color:#f97583>++</span><span style=color:#e1e4e8>i) {</span></span>
<span class=line><span style=color:#6a737d>                // 遍历 shaderLocations 中所有的 uniform，</span></span>
<span class=line><span style=color:#6a737d>                // 以其名称为 key，对应的地址（位置）为 value，存储这两组变量的对应关系</span></span>
<span class=line><span style=color:#e1e4e8>                result.uniforms </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Object.</span><span style=color:#b392f0>assign</span><span style=color:#e1e4e8>(result.uniforms, {</span></span>
<span class=line><span style=color:#e1e4e8>                    [shaderLocations.uniforms[i]]: gl.</span><span style=color:#b392f0>getUniformLocation</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                        result.glShaderProgram,</span></span>
<span class=line><span style=color:#e1e4e8>                        shaderLocations.uniforms[i]</span></span>
<span class=line><span style=color:#e1e4e8>                    ),</span></span>
<span class=line><span style=color:#e1e4e8>                });</span></span>
<span class=line><span style=color:#6a737d>                //console.log(gl.getUniformLocation(result.glShaderProgram, 'uKd'));</span></span>
<span class=line><span style=color:#e1e4e8>            }</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (</span></span>
<span class=line><span style=color:#e1e4e8>            shaderLocations </span><span style=color:#f97583>&#x26;&#x26;</span></span>
<span class=line><span style=color:#e1e4e8>            shaderLocations.attribs </span><span style=color:#f97583>&#x26;&#x26;</span></span>
<span class=line><span style=color:#e1e4e8>            shaderLocations.attribs.</span><span style=color:#79b8ff>length</span></span>
<span class=line><span style=color:#e1e4e8>        ) {</span></span>
<span class=line><span style=color:#f97583>            for</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>let</span><span style=color:#e1e4e8> i </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>; i </span><span style=color:#f97583>&#x3C;</span><span style=color:#e1e4e8> shaderLocations.attribs.</span><span style=color:#79b8ff>length</span><span style=color:#e1e4e8>; </span><span style=color:#f97583>++</span><span style=color:#e1e4e8>i) {</span></span>
<span class=line><span style=color:#6a737d>                // 遍历 shaderLocations 中所有的 attribute</span></span>
<span class=line><span style=color:#6a737d>                // 以其名称为 key，对应的索引为 value，存储这两组变量的对应关系</span></span>
<span class=line><span style=color:#e1e4e8>                result.attribs </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Object.</span><span style=color:#b392f0>assign</span><span style=color:#e1e4e8>(result.attribs, {</span></span>
<span class=line><span style=color:#e1e4e8>                    [shaderLocations.attribs[i]]: gl.</span><span style=color:#b392f0>getAttribLocation</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                        result.glShaderProgram,</span></span>
<span class=line><span style=color:#e1e4e8>                        shaderLocations.attribs[i]</span></span>
<span class=line><span style=color:#e1e4e8>                    ),</span></span>
<span class=line><span style=color:#e1e4e8>                });</span></span>
<span class=line><span style=color:#e1e4e8>            }</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>        return</span><span style=color:#e1e4e8> result;</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span></code></pre></section></section><section><h3 id=texture>Texture<a href=#texture class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h3><p>纹理是图形渲染过程中所需的重要数据，大部分时候它是每个像素点着色的重要参数，另一些时候它用于保存物体的法线、表明凹凸性等信息</p><section><h4 id=总体功能-5>总体功能<a href=#总体功能-5 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><p>在 Web 应用中，存储图片数据最主要的容器是 <code>HTMLImageElement</code>，WebGL 从 JavaScript 端获取 <code>WebGLTexture</code> 数据同样依赖 <code>HTMLImageElement</code>。GAMES 202 作业代码框架提供了 <code>Texture</code> 类来通过传入 <code>WebGLRenderingContext</code> 和 <code>HTMLImageElement</code> 来构造 <code>WebGLTexture</code>、设置一系列参数、拷贝纹理数据。</p></section><section><h4 id=texturets-代码注释><code>Texture.ts</code> 代码注释<a href=#texturets-代码注释 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f97583>export</span><span style=color:#f97583> class</span><span style=color:#b392f0> Texture</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>    // 存储 WebGL 可直接访问的图片纹理数据</span></span>
<span class=line><span style=color:#ffab70>    texture</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLTexture</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>    constructor</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>gl</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLRenderingContext</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>img</span><span style=color:#f97583>:</span><span style=color:#b392f0> HTMLImageElement</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>        // 创建 WebGLTexture 实例</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> texture</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> gl.</span><span style=color:#b392f0>createTexture</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (texture </span><span style=color:#f97583>===</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#f97583>            throw</span><span style=color:#9ecbff> "failed to create texture"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.texture </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> texture;</span></span>
<span class=line><span style=color:#6a737d>        // 将创建出的 WebGLTexture 实例与 gl.TEXTURE_2D 绑定</span></span>
<span class=line><span style=color:#6a737d>        // 之后用 gl.TEXTURE_2D 这个枚举来操作纹理</span></span>
<span class=line><span style=color:#6a737d>        // 都相当于操作当前绑定的 WebGLTexture 实例</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>bindTexture</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.texture);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 为当前绑定的 WebGLTexture 设置一系列参数</span></span>
<span class=line><span style=color:#6a737d>        // Because images have to be download over the internet</span></span>
<span class=line><span style=color:#6a737d>        // they might take a moment until they are ready.</span></span>
<span class=line><span style=color:#6a737d>        // Until then put a single pixel in the texture so we can</span></span>
<span class=line><span style=color:#6a737d>        // use it immediately. When the image has finished downloading</span></span>
<span class=line><span style=color:#6a737d>        // we'll update the texture with the contents of the image.</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> level</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;    </span><span style=color:#6a737d>// LOD 级别为 0，即不生成 mipmap</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> internalFormat</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> gl.</span><span style=color:#79b8ff>RGBA</span><span style=color:#e1e4e8>; </span><span style=color:#6a737d>// 图片是 RGBA 图像</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> width</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 1</span><span style=color:#e1e4e8>;    </span><span style=color:#6a737d>// 宽设为 1</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> height</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 1</span><span style=color:#e1e4e8>;   </span><span style=color:#6a737d>// 高设为 1</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> border</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;   </span><span style=color:#6a737d>// 边界必须设为 0</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> srcFormat</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> gl.</span><span style=color:#79b8ff>RGBA</span><span style=color:#e1e4e8>;  </span><span style=color:#6a737d>// 像素格式为 RGBA</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> srcType</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> gl.</span><span style=color:#79b8ff>UNSIGNED_BYTE</span><span style=color:#e1e4e8>;   </span><span style=color:#6a737d>// 每个像素的数据类型是 unsigned byte</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> pixel</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#b392f0> Uint8Array</span><span style=color:#e1e4e8>([</span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>255</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>255</span><span style=color:#e1e4e8>]); </span><span style=color:#6a737d>// opaque blue</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>texImage2D</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>            level,</span></span>
<span class=line><span style=color:#e1e4e8>            internalFormat,</span></span>
<span class=line><span style=color:#e1e4e8>            width,</span></span>
<span class=line><span style=color:#e1e4e8>            height,</span></span>
<span class=line><span style=color:#e1e4e8>            border,</span></span>
<span class=line><span style=color:#e1e4e8>            srcFormat,</span></span>
<span class=line><span style=color:#e1e4e8>            srcType,</span></span>
<span class=line><span style=color:#e1e4e8>            pixel</span></span>
<span class=line><span style=color:#e1e4e8>        );</span></span>
<span class=line></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>bindTexture</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.texture);</span></span>
<span class=line><span style=color:#6a737d>        // 将图像做上下翻转预处理</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>pixelStorei</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>UNPACK_FLIP_Y_WEBGL</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>true</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#6a737d>        // 将 HTMLImageElement 图像数据拷贝到 WebGLTexture 纹理</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>texImage2D</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>            level,</span></span>
<span class=line><span style=color:#e1e4e8>            internalFormat,</span></span>
<span class=line><span style=color:#e1e4e8>            srcFormat,</span></span>
<span class=line><span style=color:#e1e4e8>            srcType,</span></span>
<span class=line><span style=color:#e1e4e8>            img</span></span>
<span class=line><span style=color:#e1e4e8>        );</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>        // 如果图像的长宽都是 2 的幂</span></span>
<span class=line><span style=color:#6a737d>        // WebGL1 has different requirements for power of 2 images</span></span>
<span class=line><span style=color:#6a737d>        // vs non power of 2 images so check if the image is a</span></span>
<span class=line><span style=color:#6a737d>        // power of 2 in both dimensions.</span></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (</span><span style=color:#b392f0>isPowerOf2</span><span style=color:#e1e4e8>(img.width) </span><span style=color:#f97583>&#x26;&#x26;</span><span style=color:#b392f0> isPowerOf2</span><span style=color:#e1e4e8>(img.height)) {</span></span>
<span class=line><span style=color:#6a737d>            // 则为其生成 mipmap</span></span>
<span class=line><span style=color:#6a737d>            // Yes, it's a power of 2. Generate mips.</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>generateMipmap</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>        } </span><span style=color:#f97583>else</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>            // 否则将其水平和垂直方向设置为重复纹理</span></span>
<span class=line><span style=color:#6a737d>            // 图像缩放过程使用线性插值</span></span>
<span class=line><span style=color:#6a737d>            // 从而实现绘制非 2 次幂边长的图像</span></span>
<span class=line><span style=color:#6a737d>            // No, it's not a power of 2. Turn of mips and set</span></span>
<span class=line><span style=color:#6a737d>            // wrapping to clamp to edge</span></span>
<span class=line><span style=color:#6a737d>            //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>texParameteri</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>, gl.</span><span style=color:#79b8ff>TEXTURE_WRAP_S</span><span style=color:#e1e4e8>, gl.</span><span style=color:#79b8ff>REPEAT</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#6a737d>            //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>texParameteri</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>, gl.</span><span style=color:#79b8ff>TEXTURE_WRAP_T</span><span style=color:#e1e4e8>, gl.</span><span style=color:#79b8ff>REPEAT</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>texParameteri</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>, gl.</span><span style=color:#79b8ff>TEXTURE_MIN_FILTER</span><span style=color:#e1e4e8>, gl.</span><span style=color:#79b8ff>LINEAR</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>            gl.</span><span style=color:#b392f0>texParameteri</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>, gl.</span><span style=color:#79b8ff>TEXTURE_MAG_FILTER</span><span style=color:#e1e4e8>, gl.</span><span style=color:#79b8ff>LINEAR</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#e1e4e8>        gl.</span><span style=color:#b392f0>bindTexture</span><span style=color:#e1e4e8>(gl.</span><span style=color:#79b8ff>TEXTURE_2D</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>null</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>function</span><span style=color:#b392f0> isPowerOf2</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>value</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>    // 要判断一个数是不是 2 的幂次</span></span>
<span class=line><span style=color:#6a737d>    // 相当于判断它的二进制表示下，是否除了最高位是 1 其他位都是 0，</span></span>
<span class=line><span style=color:#6a737d>    // 可以用如下规律来判断：</span></span>
<span class=line><span style=color:#6a737d>    // 一个数 x 是 2 的幂次，当且仅当 x - 1 除了最高位是 0，其他低位都是 1</span></span>
<span class=line><span style=color:#f97583>    return</span><span style=color:#e1e4e8> (value </span><span style=color:#f97583>&#x26;</span><span style=color:#e1e4e8> (value </span><span style=color:#f97583>-</span><span style=color:#79b8ff> 1</span><span style=color:#e1e4e8>)) </span><span style=color:#f97583>==</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span></code></pre></section></section><section><h3 id=loader>Loader<a href=#loader class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h3><p>作为一个渲染器，从外部加载模型、着色器源码资源是必要的功能之一。</p><section><h4 id=总体功能-6>总体功能<a href=#总体功能-6 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><p>GAMES 202 代码框架封装了两种加载器，其中一种用于从本地加载 <code>.mtl</code> 和 <code>.obj</code> 格式的模型资源；另一种用于加载着色器源码。由于我们已经使用了 Vite 来在编译器打包外部着色器源码资源，因此后一种加载器的原理将不过多赘述。</p><p>对于 <code>loadOBJ</code> 函数，这是一个使用 <code>THREE.js</code> 的 <code>MTLLoader</code> 和 <code>OBJLoader</code> 进行封装的函数。它首先创建了一个 <code>THREE.LoadingManager</code> 来便于我们观察加载的进度；接着创建一个 <code>MTLLoader</code> 用来加载 <code>.mtl</code> 格式的材质库文件，并调用 <code>load</code> 函数、传入加载完成后的回调函数，<code>MTLLoader</code> 在加载完成后调用回调函数、传入加载好的材质（纹理）相关数据；传入 <code>MTLLoader</code> 的回调函数里创建了一个 <code>OBJLoader</code> 用于加载 <code>.obj</code> 模型的顶点、法线、纹理坐标等信息，该加载器同样具有加载完成的回调函数，该回调函数中传入了加载完成的模型实例，包含顶点、纹理等数据，用这些数据创建 <code>Mesh</code>，<code>Texture</code>，<code>Material</code> 等数据实例，最终创建出一个 <code>MeshRender</code> 并添加到 <code>WebGLRenderer</code> 中，从而完成了从外部静态资源中加载模型数据并添加到场景中的功能。</p></section><section><h4 id=loadobjts><code>loadOBJ.ts</code><a href=#loadobjts class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f97583>import</span><span style=color:#79b8ff> *</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> THREE </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "three"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { MTLLoader } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "three/examples/jsm/loaders/MTLLoader"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { OBJLoader } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "three/examples/jsm/loaders/OBJLoader"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { Mesh } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../objects/Mesh"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { Material } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../materials/Material"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> VertexShader </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../shaders/InternalShader/VertexShader.glsl?raw"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> FragmentShader </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../shaders/InternalShader/FragmentShader.glsl?raw"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { MeshRender } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../renderers/MeshRender"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { Texture } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../textures/Texture"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { WebGLRenderer } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../renderers/WebGLRenderer"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { BufferAttribute } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "three"</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> function</span><span style=color:#b392f0> loadOBJ</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>renderer</span><span style=color:#f97583>:</span><span style=color:#b392f0> WebGLRenderer</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>path</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>name</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>    // 创建一个加载管理器，可以添加到 MTLLoader 和 OBJLoader 中以追踪加载进度</span></span>
<span class=line><span style=color:#f97583>    const</span><span style=color:#79b8ff> manager</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#79b8ff> THREE</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>LoadingManager</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#e1e4e8>    manager.</span><span style=color:#b392f0>onProgress</span><span style=color:#f97583> =</span><span style=color:#f97583> function</span><span style=color:#e1e4e8> (</span><span style=color:#ffab70>item</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>loaded</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>total</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#e1e4e8>        console.</span><span style=color:#b392f0>log</span><span style=color:#e1e4e8>(item, loaded, total);</span></span>
<span class=line><span style=color:#e1e4e8>    };</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 定义打印 OBJLoader 自身加载进度的回调函数 </span></span>
<span class=line><span style=color:#f97583>    function</span><span style=color:#b392f0> onProgress</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>xhr</span><span style=color:#f97583>:</span><span style=color:#b392f0> ProgressEvent</span><span style=color:#e1e4e8>&#x3C;</span><span style=color:#b392f0>EventTarget</span><span style=color:#e1e4e8>>) {</span></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> (xhr.lengthComputable) {</span></span>
<span class=line><span style=color:#f97583>            const</span><span style=color:#79b8ff> percentComplete</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> (xhr.loaded </span><span style=color:#f97583>/</span><span style=color:#e1e4e8> xhr.total) </span><span style=color:#f97583>*</span><span style=color:#79b8ff> 100</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>            console.</span><span style=color:#b392f0>log</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#6a737d>                // "model " + Math.round(percentComplete, 2) + "% downloaded"</span></span>
<span class=line><span style=color:#9ecbff>                "model "</span><span style=color:#f97583> +</span><span style=color:#e1e4e8> Math.</span><span style=color:#b392f0>round</span><span style=color:#e1e4e8>(percentComplete) </span><span style=color:#f97583>+</span><span style=color:#9ecbff> "% downloaded"</span></span>
<span class=line><span style=color:#e1e4e8>            );</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line><span style=color:#f97583>    function</span><span style=color:#b392f0> onError</span><span style=color:#e1e4e8>() { }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 新建一个 MTLLoader，指定其加载外部资源的路径，并设置加载完成的回调函数</span></span>
<span class=line><span style=color:#f97583>    new</span><span style=color:#b392f0> MTLLoader</span><span style=color:#e1e4e8>(manager)</span></span>
<span class=line><span style=color:#e1e4e8>        .</span><span style=color:#b392f0>setPath</span><span style=color:#e1e4e8>(path)</span></span>
<span class=line><span style=color:#e1e4e8>        .</span><span style=color:#b392f0>load</span><span style=color:#e1e4e8>(name </span><span style=color:#f97583>+</span><span style=color:#9ecbff> ".mtl"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>function</span><span style=color:#e1e4e8> (</span><span style=color:#ffab70>materials</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>            // 这里被执行时表明 .mtl 文件已经加载完成，传入的是将要加载的材质纹理数据</span></span>
<span class=line><span style=color:#e1e4e8>            materials.</span><span style=color:#b392f0>preload</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#6a737d>            // 新建一个 OBJLoader，为其设置材质和资源路径，使用类似的方法来设置加载完成的回调函数</span></span>
<span class=line><span style=color:#f97583>            new</span><span style=color:#b392f0> OBJLoader</span><span style=color:#e1e4e8>(manager)</span></span>
<span class=line><span style=color:#e1e4e8>                .</span><span style=color:#b392f0>setMaterials</span><span style=color:#e1e4e8>(materials)</span></span>
<span class=line><span style=color:#e1e4e8>                .</span><span style=color:#b392f0>setPath</span><span style=color:#e1e4e8>(path)</span></span>
<span class=line><span style=color:#e1e4e8>                .</span><span style=color:#b392f0>load</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                    name </span><span style=color:#f97583>+</span><span style=color:#9ecbff> ".obj"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#f97583>                    function</span><span style=color:#e1e4e8> (</span><span style=color:#ffab70>object</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>                        // 可能会加载到多个模型，因此需要遍历每一个模型来创建 MeshRender </span></span>
<span class=line><span style=color:#6a737d>                        // 并添加到 WebGLRenderer</span></span>
<span class=line><span style=color:#e1e4e8>                        object.</span><span style=color:#b392f0>traverse</span><span style=color:#e1e4e8>(</span><span style=color:#f97583>function</span><span style=color:#e1e4e8> (</span><span style=color:#ffab70>event</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#f97583>                            const</span><span style=color:#79b8ff> child</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> event;</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>                            // 判断每个 event 是不是 THREE.Mesh</span></span>
<span class=line><span style=color:#f97583>                            if</span><span style=color:#e1e4e8> (child </span><span style=color:#f97583>instanceof</span><span style=color:#b392f0> THREE</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>Mesh</span><span style=color:#f97583> &#x26;&#x26;</span><span style=color:#e1e4e8> child.isMesh) {</span></span>
<span class=line><span style=color:#6a737d>                                // 如果是，则取出它的几何数据和材质数据</span></span>
<span class=line><span style=color:#f97583>                                let</span><span style=color:#e1e4e8> geo </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> child.geometry;</span></span>
<span class=line><span style=color:#f97583>                                let</span><span style=color:#e1e4e8> mat </span><span style=color:#f97583>=</span><span style=color:#f97583> new</span><span style=color:#79b8ff> THREE</span><span style=color:#e1e4e8>.MeshPhongMaterial;</span></span>
<span class=line><span style=color:#6a737d>                                // 不论只有一个材质还是多个材质，</span></span>
<span class=line><span style=color:#6a737d>                                // 都检查并转换为 MeshPhongMaterial</span></span>
<span class=line><span style=color:#f97583>                                if</span><span style=color:#e1e4e8> (Array.</span><span style=color:#b392f0>isArray</span><span style=color:#e1e4e8>(child.material)) {</span></span>
<span class=line><span style=color:#f97583>                                    let</span><span style=color:#e1e4e8> firstMaterial </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> child</span></span>
<span class=line><span style=color:#e1e4e8>                                        .material[</span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>];</span></span>
<span class=line><span style=color:#f97583>                                    if</span><span style=color:#e1e4e8> (firstMaterial </span><span style=color:#f97583>instanceof</span><span style=color:#b392f0> THREE</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>MeshPhongMaterial</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#e1e4e8>                                        mat </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> firstMaterial;</span></span>
<span class=line><span style=color:#e1e4e8>                                    }</span></span>
<span class=line><span style=color:#e1e4e8>                                }</span></span>
<span class=line><span style=color:#f97583>                                else</span><span style=color:#f97583> if</span><span style=color:#e1e4e8> (child.material </span><span style=color:#f97583>instanceof</span><span style=color:#b392f0> THREE</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>MeshPhongMaterial</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#e1e4e8>                                    mat </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> child.material;</span></span>
<span class=line><span style=color:#e1e4e8>                                }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>                                // 从几何数据中取出顶点索引</span></span>
<span class=line><span style=color:#f97583>                                var</span><span style=color:#e1e4e8> indices </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Array.</span><span style=color:#b392f0>from</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                                    { length: geo.attributes.position.count },</span></span>
<span class=line><span style=color:#e1e4e8>                                    (</span><span style=color:#ffab70>v</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>k</span><span style=color:#e1e4e8>) </span><span style=color:#f97583>=></span><span style=color:#e1e4e8> k</span></span>
<span class=line><span style=color:#e1e4e8>                                );</span></span>
<span class=line><span style=color:#6a737d>                                // 如果存在顶点坐标、法线或纹理坐标数据，则一并取出</span></span>
<span class=line><span style=color:#6a737d>                                // 同时创建一个 Mesh 实例保存这些数据</span></span>
<span class=line><span style=color:#f97583>                                let</span><span style=color:#e1e4e8> mesh </span><span style=color:#f97583>=</span><span style=color:#f97583> new</span><span style=color:#b392f0> Mesh</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                                    {</span></span>
<span class=line><span style=color:#e1e4e8>                                        name: </span><span style=color:#9ecbff>"aVertexPosition"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>                                        array: </span><span style=color:#f97583>new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>(geo.attributes.position </span><span style=color:#f97583>instanceof</span><span style=color:#b392f0> BufferAttribute</span><span style=color:#f97583> ?</span><span style=color:#e1e4e8> geo.attributes.position.array </span><span style=color:#f97583>:</span><span style=color:#e1e4e8> []),</span></span>
<span class=line><span style=color:#e1e4e8>                                    },</span></span>
<span class=line><span style=color:#e1e4e8>                                    {</span></span>
<span class=line><span style=color:#e1e4e8>                                        name: </span><span style=color:#9ecbff>"aNormalPosition"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>                                        array: </span><span style=color:#f97583>new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>(geo.attributes.normal </span><span style=color:#f97583>instanceof</span><span style=color:#b392f0> BufferAttribute</span><span style=color:#f97583> ?</span><span style=color:#e1e4e8> geo.attributes.normal.array </span><span style=color:#f97583>:</span><span style=color:#e1e4e8> []),</span></span>
<span class=line><span style=color:#e1e4e8>                                    },</span></span>
<span class=line><span style=color:#e1e4e8>                                    {</span></span>
<span class=line><span style=color:#e1e4e8>                                        name: </span><span style=color:#9ecbff>"aTextureCoord"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>                                        array: </span><span style=color:#f97583>new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>(geo.attributes.uv </span><span style=color:#f97583>instanceof</span><span style=color:#b392f0> BufferAttribute</span><span style=color:#f97583> ?</span><span style=color:#e1e4e8> geo.attributes.uv.array </span><span style=color:#f97583>:</span><span style=color:#e1e4e8> []),</span></span>
<span class=line><span style=color:#e1e4e8>                                    },</span></span>
<span class=line><span style=color:#e1e4e8>                                    indices</span></span>
<span class=line><span style=color:#e1e4e8>                                );</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>                                // 如果模型材质中包含纹理数据，则创建一个 Texture 实例</span></span>
<span class=line><span style=color:#f97583>                                let</span><span style=color:#e1e4e8> colorMap</span><span style=color:#f97583>:</span><span style=color:#b392f0> Texture</span><span style=color:#f97583> |</span><span style=color:#79b8ff> null</span><span style=color:#f97583> =</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>                                if</span><span style=color:#e1e4e8> (mat.map </span><span style=color:#f97583>!=</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>                                    colorMap </span><span style=color:#f97583>=</span><span style=color:#f97583> new</span><span style=color:#b392f0> Texture</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                                        renderer.gl,</span></span>
<span class=line><span style=color:#e1e4e8>                                        mat.map.image</span></span>
<span class=line><span style=color:#e1e4e8>                                    );</span></span>
<span class=line><span style=color:#6a737d>                                // MARK: You can change the myMaterial object to your own Material instance</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>                                // 若存在纹理数据，在新创建的 Material 实例中添加该纹理数据</span></span>
<span class=line><span style=color:#6a737d>                                // 否则不添加任何纹理参数</span></span>
<span class=line><span style=color:#f97583>                                let</span><span style=color:#e1e4e8> textureSample </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>                                let</span><span style=color:#e1e4e8> myMaterial;</span></span>
<span class=line><span style=color:#f97583>                                if</span><span style=color:#e1e4e8> (colorMap </span><span style=color:#f97583>!=</span><span style=color:#79b8ff> null</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#e1e4e8>                                    textureSample </span><span style=color:#f97583>=</span><span style=color:#79b8ff> 1</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#e1e4e8>                                    myMaterial </span><span style=color:#f97583>=</span><span style=color:#f97583> new</span><span style=color:#b392f0> Material</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                                        {</span></span>
<span class=line><span style=color:#6a737d>                                            // 名为 uSampler 的材质参数</span></span>
<span class=line><span style=color:#6a737d>                                            // 类型为 texture，值为 colorMap</span></span>
<span class=line><span style=color:#e1e4e8>                                            uSampler: {</span></span>
<span class=line><span style=color:#e1e4e8>                                                type: </span><span style=color:#9ecbff>"texture"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>                                                value: colorMap,</span></span>
<span class=line><span style=color:#e1e4e8>                                            },</span></span>
<span class=line><span style=color:#e1e4e8>                                            uTextureSample: {</span></span>
<span class=line><span style=color:#e1e4e8>                                                type: </span><span style=color:#9ecbff>"1i"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>                                                value: textureSample,</span></span>
<span class=line><span style=color:#e1e4e8>                                            },</span></span>
<span class=line><span style=color:#e1e4e8>                                            uKd: {</span></span>
<span class=line><span style=color:#e1e4e8>                                                type: </span><span style=color:#9ecbff>"3fv"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>                                                value: </span><span style=color:#f97583>new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>(mat.color.</span><span style=color:#b392f0>toArray</span><span style=color:#e1e4e8>() </span><span style=color:#f97583>||</span><span style=color:#e1e4e8> []),</span></span>
<span class=line><span style=color:#e1e4e8>                                            },</span></span>
<span class=line><span style=color:#e1e4e8>                                        },</span></span>
<span class=line><span style=color:#e1e4e8>                                        [],</span></span>
<span class=line><span style=color:#e1e4e8>                                        VertexShader,</span></span>
<span class=line><span style=color:#e1e4e8>                                        FragmentShader</span></span>
<span class=line><span style=color:#e1e4e8>                                    );</span></span>
<span class=line><span style=color:#e1e4e8>                                } </span><span style=color:#f97583>else</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#e1e4e8>                                    myMaterial </span><span style=color:#f97583>=</span><span style=color:#f97583> new</span><span style=color:#b392f0> Material</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                                        {</span></span>
<span class=line><span style=color:#e1e4e8>                                            uTextureSample: {</span></span>
<span class=line><span style=color:#e1e4e8>                                                type: </span><span style=color:#9ecbff>"1i"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>                                                value: textureSample,</span></span>
<span class=line><span style=color:#e1e4e8>                                            },</span></span>
<span class=line><span style=color:#e1e4e8>                                            uKd: {</span></span>
<span class=line><span style=color:#e1e4e8>                                                type: </span><span style=color:#9ecbff>"3fv"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>                                                value: </span><span style=color:#f97583>new</span><span style=color:#b392f0> Float32Array</span><span style=color:#e1e4e8>(mat.color.</span><span style=color:#b392f0>toArray</span><span style=color:#e1e4e8>() </span><span style=color:#f97583>||</span><span style=color:#e1e4e8> []),</span></span>
<span class=line><span style=color:#e1e4e8>                                            },</span></span>
<span class=line><span style=color:#e1e4e8>                                        },</span></span>
<span class=line><span style=color:#e1e4e8>                                        [],</span></span>
<span class=line><span style=color:#e1e4e8>                                        VertexShader,</span></span>
<span class=line><span style=color:#e1e4e8>                                        FragmentShader</span></span>
<span class=line><span style=color:#e1e4e8>                                    );</span></span>
<span class=line><span style=color:#e1e4e8>                                }</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>                                // 从模型资源中取出的各类数据准备好之后</span></span>
<span class=line><span style=color:#6a737d>                                // 用这些数据创建一个 MeshRender 实例</span></span>
<span class=line><span style=color:#f97583>                                let</span><span style=color:#e1e4e8> meshRender </span><span style=color:#f97583>=</span><span style=color:#f97583> new</span><span style=color:#b392f0> MeshRender</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>                                    renderer.gl,</span></span>
<span class=line><span style=color:#e1e4e8>                                    mesh,</span></span>
<span class=line><span style=color:#e1e4e8>                                    myMaterial</span></span>
<span class=line><span style=color:#e1e4e8>                                );</span></span>
<span class=line><span style=color:#6a737d>                                // 并将该 MeshRenderer 添加到 WebGLRenderer 中</span></span>
<span class=line><span style=color:#e1e4e8>                                renderer.</span><span style=color:#b392f0>addMesh</span><span style=color:#e1e4e8>(meshRender);</span></span>
<span class=line><span style=color:#e1e4e8>                            }</span></span>
<span class=line><span style=color:#e1e4e8>                        });</span></span>
<span class=line><span style=color:#e1e4e8>                    },</span></span>
<span class=line><span style=color:#e1e4e8>                    onProgress,</span></span>
<span class=line><span style=color:#e1e4e8>                    onError</span></span>
<span class=line><span style=color:#e1e4e8>                );</span></span>
<span class=line><span style=color:#e1e4e8>        });</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span></code></pre></section><section><h4 id=loadshaderts-代码注释><code>loadShader.ts</code> 代码注释<a href=#loadshaderts-代码注释 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f97583>import</span><span style=color:#79b8ff> *</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> THREE </span><span style=color:#f97583>from</span><span style=color:#9ecbff> 'three'</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> function</span><span style=color:#b392f0> loadShaderFile</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>filename</span><span style=color:#f97583>:</span><span style=color:#79b8ff> string</span><span style=color:#e1e4e8>) {</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 使用一个将由 Three.js 提供的加载操作放在一个 Promise 中进行，</span></span>
<span class=line><span style=color:#6a737d>    // 当加载完成后调用 resovle 表示加载完成</span></span>
<span class=line><span style=color:#6a737d>    // 外部使用时可以在 async 函数中使用 await 等待 resolve 执行完成</span></span>
<span class=line><span style=color:#6a737d>    // 也可以直接对 Promise 调用 then 方法获取该 Promise 中调用 resolve 所传入的参数</span></span>
<span class=line><span style=color:#6a737d>    // 实现异步加载 Shader 源码文件</span></span>
<span class=line><span style=color:#f97583>    return</span><span style=color:#f97583> new</span><span style=color:#79b8ff> Promise</span><span style=color:#e1e4e8>((</span><span style=color:#ffab70>resolve</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>reject</span><span style=color:#e1e4e8>) </span><span style=color:#f97583>=></span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#f97583>        const</span><span style=color:#79b8ff> loader</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#79b8ff> THREE</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>FileLoader</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#e1e4e8>        loader.</span><span style=color:#b392f0>load</span><span style=color:#e1e4e8>(filename, (</span><span style=color:#ffab70>data</span><span style=color:#e1e4e8>) </span><span style=color:#f97583>=></span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#b392f0>            resolve</span><span style=color:#e1e4e8>(data);</span></span>
<span class=line><span style=color:#6a737d>            //console.log(data);</span></span>
<span class=line><span style=color:#e1e4e8>        });</span></span>
<span class=line><span style=color:#e1e4e8>    });</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span></code></pre></section></section><section><h3 id=lights>Lights<a href=#lights class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h3><p>光源是代码框架中结构较为简单的类型。逻辑上光源只表示场景空间中的某处存在一个发光的物体，它具有一定的发光强度，可以照亮场景中的其他物体；表现上在渲染出的场景中具有具体的形态，可能是一个灯泡模型，也可能是其他，带有自己的 Mesh 和相应的材质。</p><section><h4 id=总体功能-7>总体功能<a href=#总体功能-7 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><p>代码框架在光源部分提供了两个类型：<code>EmissiveMaterial</code> 和 <code>PointLight</code>。前者定义了一种特殊的材质，用来表现发光实体本身的视觉效果；后者定义了光源的具体数据，包括发光强度，使用什么样的 Mesh 表现它的形状等，同时保存了发光材质的引用。</p></section><section><h4 id=lightts-代码注释><code>Light.ts</code> 代码注释<a href=#lightts-代码注释 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { Material } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> '../materials/Material'</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> LightCubeVertexShader </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../shaders/InternalShader/LightCubeVertexShader.glsl?raw"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> LightCubeFragmentShader </span><span style=color:#f97583>from</span><span style=color:#9ecbff> "../shaders/InternalShader/LightCubeFragmentShader.glsl?raw"</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { vec3 } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> 'gl-matrix'</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> class</span><span style=color:#b392f0> EmissiveMaterial</span><span style=color:#f97583> extends</span><span style=color:#b392f0> Material</span><span style=color:#e1e4e8> {</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 定义光源的发光强度</span></span>
<span class=line><span style=color:#ffab70>    intensity</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 定义发光的颜色</span></span>
<span class=line><span style=color:#ffab70>    color</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>    constructor</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>lightIntensity</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>lightColor</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#e1e4e8>) {    </span></span>
<span class=line><span style=color:#6a737d>        // 构造材质实例，传入着色器源码和发光强度、颜色等参数</span></span>
<span class=line><span style=color:#79b8ff>        super</span><span style=color:#e1e4e8>({</span></span>
<span class=line><span style=color:#9ecbff>            'uLigIntensity'</span><span style=color:#e1e4e8>: { type: </span><span style=color:#9ecbff>'1f'</span><span style=color:#e1e4e8>, value: lightIntensity },</span></span>
<span class=line><span style=color:#9ecbff>            'uLightColor'</span><span style=color:#e1e4e8>: { type: </span><span style=color:#9ecbff>'3fv'</span><span style=color:#e1e4e8>, value: lightColor }</span></span>
<span class=line><span style=color:#e1e4e8>        }, [], LightCubeVertexShader, LightCubeFragmentShader);</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.intensity </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> lightIntensity;</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.color </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> lightColor;</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span>
<span class=line></span></code></pre></section><section><h4 id=pointlightts-代码注释><code>PointLight.ts</code> 代码注释<a href=#pointlightts-代码注释 class=anchor><span class=anchor-icon data-pagefind-ignore="">#</span></a></h4><pre class="astro-code github-dark" data-language=ts style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { Mesh } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> '../objects/Mesh'</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { EmissiveMaterial } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> './Light'</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> { vec3 } </span><span style=color:#f97583>from</span><span style=color:#9ecbff> 'gl-matrix'</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>export</span><span style=color:#f97583> class</span><span style=color:#b392f0> PointLight</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#6a737d>    /**</span></span>
<span class=line><span style=color:#6a737d>     * Creates an instance of PointLight.</span></span>
<span class=line><span style=color:#6a737d>     * </span><span style=color:#f97583>@param</span><span style=color:#b392f0> {float}</span><span style=color:#e1e4e8> lightIntensity</span><span style=color:#6a737d>  The intensity of the PointLight.</span></span>
<span class=line><span style=color:#6a737d>     * </span><span style=color:#f97583>@param</span><span style=color:#b392f0> {vec3f}</span><span style=color:#e1e4e8> lightColor</span><span style=color:#6a737d> The color of the PointLight.</span></span>
<span class=line><span style=color:#6a737d>     * </span><span style=color:#f97583>@memberof</span><span style=color:#b392f0> PointLight</span></span>
<span class=line><span style=color:#6a737d>     */</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>    // 定义发光实体的网格体</span></span>
<span class=line><span style=color:#ffab70>    mesh</span><span style=color:#f97583>:</span><span style=color:#b392f0> Mesh</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#6a737d>    // 保存渲染该实体所需的材质</span></span>
<span class=line><span style=color:#ffab70>    mat</span><span style=color:#f97583>:</span><span style=color:#b392f0> EmissiveMaterial</span><span style=color:#e1e4e8>;</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>    constructor</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>lightIntensity</span><span style=color:#f97583>:</span><span style=color:#79b8ff> number</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>lightColor</span><span style=color:#f97583>:</span><span style=color:#b392f0> vec3</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#6a737d>        // 光源的形状默认是一个立方体</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.mesh </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Mesh.</span><span style=color:#b392f0>cube</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#79b8ff>        this</span><span style=color:#e1e4e8>.mat </span><span style=color:#f97583>=</span><span style=color:#f97583> new</span><span style=color:#b392f0> EmissiveMaterial</span><span style=color:#e1e4e8>(lightIntensity, lightColor);</span></span>
<span class=line><span style=color:#e1e4e8>    }</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span></code></pre></section></section></section></div><script type=module>const n=new MutationObserver(i);function i(){n.disconnect();let e=Array.from(document.querySelectorAll("pre"));for(let t of e){if("DIV"===t.parentElement?.nodeName&&t.parentElement?.classList.contains("code-block"))continue;let e=document.createElement("div");e.className="relative code-block";let n=document.createElement("button");n.className="copy-btn btn-regular-dark absolute active:scale-90 h-8 w-8 top-2 right-2 opacity-75 text-sm p-1.5 rounded-lg transition-all ease-in-out",t.setAttribute("tabindex","0"),t.parentNode&&t.parentNode.insertBefore(e,t);let o,s='<svg class="copy-btn-icon copy-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="M368.37-237.37q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-474.26q0-34.48 24.26-58.74 24.26-24.26 58.74-24.26h378.26q34.48 0 58.74 24.26 24.26 24.26 24.26 58.74v474.26q0 34.48-24.26 58.74-24.26 24.26-58.74 24.26H368.37Zm0-83h378.26v-474.26H368.37v474.26Zm-155 238q-34.48 0-58.74-24.26-24.26-24.26-24.26-58.74v-515.76q0-17.45 11.96-29.48 11.97-12.02 29.33-12.02t29.54 12.02q12.17 12.03 12.17 29.48v515.76h419.76q17.45 0 29.48 11.96 12.02 11.97 12.02 29.33t-12.02 29.54q-12.03 12.17-29.48 12.17H213.37Zm155-238v-474.26 474.26Z"/></svg>',i='<svg class="copy-btn-icon success-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"><path d="m389-377.13 294.7-294.7q12.58-12.67 29.52-12.67 16.93 0 29.61 12.67 12.67 12.68 12.67 29.53 0 16.86-12.28 29.14L419.07-288.41q-12.59 12.67-29.52 12.67-16.94 0-29.62-12.67L217.41-430.93q-12.67-12.68-12.79-29.45-.12-16.77 12.55-29.45 12.68-12.67 29.62-12.67 16.93 0 29.28 12.67L389-377.13Z"/></svg>';n.innerHTML=`<div>${s} ${i}</div>\n      `,e.appendChild(t),e.appendChild(n),n.addEventListener("click",(async()=>{o&&clearTimeout(o);let e=t?.querySelector("code")?.innerText;void 0!==e&&(await navigator.clipboard.writeText(e),n.classList.add("success"),o=setTimeout((()=>{n.classList.remove("success")}),1e3))}))}n.observe(document.body,{childList:!0,subtree:!0})}n.observe(document.body,{childList:!0,subtree:!0}),document.addEventListener("DOMContentLoaded",i)</script><div class="transition overflow-hidden relative bg-[var(--license-block-bg)] license-container mb-6 onload-animation px-6 py-5 rounded-xl"><div class="transition font-bold dark:text-white/75 text-black/75">GAMES 202 作业代码框架剖析</div><a href=https://blog.vonbrank.com/posts/games-202-assignment-framework-analysis/ class="text-[var(--primary)] link">https://blog.vonbrank.com/posts/games-202-assignment-framework-analysis/</a><div class="flex gap-6 mt-2"><div><div class="transition text-sm dark:text-white/30 text-black/30">作者</div><div class="transition dark:text-white/75 text-black/75 whitespace-nowrap">Von Brank</div></div><div><div class="transition text-sm dark:text-white/30 text-black/30">发布于</div><div class="transition dark:text-white/75 text-black/75 whitespace-nowrap">2023-08-23</div></div><div><div class="transition text-sm dark:text-white/30 text-black/30">许可协议</div><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ class="text-[var(--primary)] link whitespace-nowrap" target=_blank>CC BY-NC-SA 4.0</a></div></div><svg data-icon=fa6-brands:creative-commons height=1em width=0.97em class="transition absolute pointer-events-none -translate-y-1/2 dark:text-white/5 right-6 text-[15rem] text-black/5 top-1/2"><symbol id=ai:fa6-brands:creative-commons viewBox="0 0 496 512"><path d="m245.83 214.87l-33.22 17.28c-9.43-19.58-25.24-19.93-27.46-19.93c-22.13 0-33.22 14.61-33.22 43.84c0 23.57 9.21 43.84 33.22 43.84c14.47 0 24.65-7.09 30.57-21.26l30.55 15.5c-6.17 11.51-25.69 38.98-65.1 38.98c-22.6 0-73.96-10.32-73.96-77.05c0-58.69 43-77.06 72.63-77.06c30.72-.01 52.7 11.95 65.99 35.86m143.05 0l-32.78 17.28c-9.5-19.77-25.72-19.93-27.9-19.93c-22.14 0-33.22 14.61-33.22 43.84c0 23.55 9.23 43.84 33.22 43.84c14.45 0 24.65-7.09 30.54-21.26l31 15.5c-2.1 3.75-21.39 38.98-65.09 38.98c-22.69 0-73.96-9.87-73.96-77.05c0-58.67 42.97-77.06 72.63-77.06c30.71-.01 52.58 11.95 65.56 35.86M247.56 8.05C104.74 8.05 0 123.11 0 256.05c0 138.49 113.6 248 247.56 248c129.93 0 248.44-100.87 248.44-248c0-137.87-106.62-248-248.44-248m.87 450.81c-112.54 0-203.7-93.04-203.7-202.81c0-105.42 85.43-203.27 203.72-203.27c112.53 0 202.82 89.46 202.82 203.26c-.01 121.69-99.68 202.82-202.84 202.82" fill=currentColor /></symbol><use href=#ai:fa6-brands:creative-commons></use></svg></div></div></div><div class="flex w-full flex-col gap-4 mb-4 justify-between md:flex-row overflow-hidden"><a href=# class="overflow-hidden w-full active:scale-95 font-bold pointer-events-none"></a> <a href=# class="overflow-hidden w-full active:scale-95 font-bold pointer-events-none"></a></div><div class="onload-animation col-span-2 footer hidden lg:block"><div class="transition border-dashed dark:border-white/15 border-black/10 border-t mx-32 my-10"></div><div class="transition flex items-center justify-center border-[oklch(85%_0.01_var(--hue))] border-dashed dark:border-white/15 flex-col mb-12 px-6 rounded-2xl"><div class="transition text-sm text-50 text-center">&copy; <span id=copyright-year>2025</span> Von Brank. All Rights Reserved. / <a href=/rss.xml class="transition font-medium link text-[var(--primary)]" target=_blank>RSS</a> / <a href=/sitemap-index.xml class="transition font-medium link text-[var(--primary)]" target=_blank>Sitemap</a><br>Powered by <a href=https://astro.build class="transition font-medium link text-[var(--primary)]" target=_blank>Astro</a> & <a href=https://github.com/saicaca/fuwari class="transition font-medium link text-[var(--primary)]" target=_blank>Fuwari</a></div></div></div></div></main><div class="onload-animation col-span-2 footer block lg:hidden"><div class="transition border-dashed dark:border-white/15 border-black/10 border-t mx-32 my-10"></div><div class="transition flex items-center justify-center border-[oklch(85%_0.01_var(--hue))] border-dashed dark:border-white/15 flex-col mb-12 px-6 rounded-2xl"><div class="transition text-sm text-50 text-center">&copy; <span id=copyright-year>2025</span> Von Brank. All Rights Reserved. / <a href=/rss.xml class="transition font-medium link text-[var(--primary)]" target=_blank>RSS</a> / <a href=/sitemap-index.xml class="transition font-medium link text-[var(--primary)]" target=_blank>Sitemap</a><br>Powered by <a href=https://astro.build class="transition font-medium link text-[var(--primary)]" target=_blank>Astro</a> & <a href=https://github.com/saicaca/fuwari class="transition font-medium link text-[var(--primary)]" target=_blank>Fuwari</a></div></div></div></div><div class="hidden lg:block back-to-top-wrapper" data-astro-cid-eymb5ayk><div class="transition flex items-center rounded-2xl back-to-top-btn hide overflow-hidden" id=back-to-top-btn data-astro-cid-eymb5ayk onclick=backToTop()><button class="btn-card h-[3.75rem] w-[3.75rem]" aria-label="Back to Top" data-astro-cid-eymb5ayk><svg data-icon=material-symbols:keyboard-arrow-up-rounded height=1em width=1em class=mx-auto data-astro-cid-eymb5ayk=true><symbol id=ai:material-symbols:keyboard-arrow-up-rounded viewBox="0 0 24 24"><path d="m12 10.8l-3.9 3.9q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7l4.6-4.6q.3-.3.7-.3t.7.3l4.6 4.6q.275.275.275.7t-.275.7t-.7.275t-.7-.275z" fill=currentColor /></symbol><use href=#ai:material-symbols:keyboard-arrow-up-rounded></use></svg></button></div></div><script>function backToTop(){window.scroll({top:0,behavior:"smooth"})}</script></div></div><div class="hidden absolute 2xl:block w-full z-0"><div class="mx-auto relative max-w-[var(--page-width)]"><div class="transition flex items-center absolute -right-[var(--toc-width)] hidden lg:block toc-hide top-0 w-[var(--toc-width)]" id=toc-wrapper><div class="fixed h-[calc(100vh_-_20rem)] hide-scrollbar overflow-x-hidden overflow-y-scroll top-14 w-[var(--toc-width)]" id=toc-inner-wrapper><div class="h-full w-full transition-swup-fade" id=toc><div class="h-8 w-full"></div><table-of-contents class=group><a href=#webgl-使用方法回顾 class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center text-[var(--btn-content)] bg-[var(--toc-badge-bg)] h-5 shrink-0 text-xs w-5">1</div><div class="transition text-sm text-50">WebGL 使用方法回顾</div></a><a href=#将官方代码框架引入现代前端开发流的说明 class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center text-[var(--btn-content)] bg-[var(--toc-badge-bg)] h-5 shrink-0 text-xs w-5">2</div><div class="transition text-sm text-50">将官方代码框架引入现代前端开发流的说明</div></a><a href=#作业-0-代码框架详解 class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center text-[var(--btn-content)] bg-[var(--toc-badge-bg)] h-5 shrink-0 text-xs w-5">3</div><div class="transition text-sm text-50">作业 0 代码框架详解</div></a><a href=#games-202-作业代码框架体系结构 class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 h-5 shrink-0 text-xs w-5"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">GAMES 202 作业代码框架体系结构</div></a><a href=#games-202-engine class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 h-5 shrink-0 text-xs w-5"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">GAMES 202 Engine</div></a><a href=#renderer class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 h-5 shrink-0 text-xs w-5"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">Renderer</div></a><a href=#mesh class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 h-5 shrink-0 text-xs w-5"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">Mesh</div></a><a href=#material class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 h-5 shrink-0 text-xs w-5"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">Material</div></a><a href=#shader class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 h-5 shrink-0 text-xs w-5"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">Shader</div></a><a href=#texture class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 h-5 shrink-0 text-xs w-5"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">Texture</div></a><a href=#loader class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 h-5 shrink-0 text-xs w-5"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">Loader</div></a><a href=#lights class="transition flex px-2 active:bg-[var(--toc-btn-active)] gap-2 hover:bg-[var(--toc-btn-hover)] min-h-9 py-2 relative rounded-xl w-full"><div class="transition flex items-center rounded-lg font-bold justify-center ml-4 h-5 shrink-0 text-xs w-5"><div class="transition bg-[var(--toc-badge-bg)] h-2 rounded-[0.1875rem] w-2"></div></div><div class="transition text-sm text-50">Lights</div></a><div class="transition-all absolute -z-10 bg-[var(--toc-btn-hover)] border-2 border-[var(--toc-btn-hover)] border-dashed group-hover:bg-transparent group-hover:border-[var(--toc-btn-active)] left-0 right-0 rounded-xl" id=active-indicator></div></table-of-contents><script type=module>class h extends HTMLElement{tocEl=null;visibleClass="visible";observer;anchorNavTarget=null;headingIdxMap=new Map;headings=[];sections=[];tocEntries=[];active=[];activeIndicator=null;constructor(){super(),this.observer=new IntersectionObserver(this.markVisibleSection,{threshold:0})}markVisibleSection=t=>{t.forEach((t=>{const e=t.target.children[0]?.getAttribute("id"),i=e?this.headingIdxMap.get(e):void 0;null!=i&&(this.active[i]=t.isIntersecting),t.isIntersecting&&this.anchorNavTarget==t.target.firstChild&&(this.anchorNavTarget=null)})),this.active.includes(!0)||this.fallback(),this.update()};toggleActiveHeading=()=>{let t=this.active.length-1,e=this.active.length-1,i=0;for(;t>=0&&!this.active[t];)this.tocEntries[t].classList.remove(this.visibleClass),t--;for(;t>=0&&this.active[t];)this.tocEntries[t].classList.add(this.visibleClass),e=Math.min(e,t),i=Math.max(i,t),t--;for(;t>=0;)this.tocEntries[t].classList.remove(this.visibleClass),t--;let n=this.tocEl?.getBoundingClientRect().top||0,s=this.tocEl?.scrollTop||0,o=this.tocEntries[e].getBoundingClientRect().top-n+s,c=this.tocEntries[i].getBoundingClientRect().bottom-n+s;this.activeIndicator?.setAttribute("style",`top: ${o}px; height: ${c-o}px`)};scrollToActiveHeading=()=>{if(this.anchorNavTarget||!this.tocEl)return;const t=document.querySelectorAll(`#toc .${this.visibleClass}`);if(!t.length)return;const e=t[0],i=t[t.length-1],n=this.tocEl.clientHeight;let s;s=i.getBoundingClientRect().bottom-e.getBoundingClientRect().top<.9*n?e.offsetTop-32:i.offsetTop-.8*n,this.tocEl.scrollTo({top:s,left:0,behavior:"smooth"})};update=()=>{requestAnimationFrame((()=>{this.toggleActiveHeading(),this.scrollToActiveHeading()}))};fallback=()=>{if(this.sections.length)for(let t=0;t<this.sections.length;t++){let e=this.sections[t].getBoundingClientRect().top,i=this.sections[t].getBoundingClientRect().bottom;if(this.isInRange(e,0,window.innerHeight)||this.isInRange(i,0,window.innerHeight)||e<0&&i>window.innerHeight)this.markActiveHeading(t);else if(e>window.innerHeight)break}};markActiveHeading=t=>{this.active[t]=!0};handleAnchorClick=t=>{const e=t.composedPath().find((t=>t instanceof HTMLAnchorElement));if(e){const t=decodeURIComponent(e.hash?.substring(1)),i=this.headingIdxMap.get(t);this.anchorNavTarget=void 0!==i?this.headings[i]:null}};isInRange(t,e,i){return e<t&&t<i}connectedCallback(){const t=document.querySelector(".prose");t?t.addEventListener("animationend",(()=>{this.init()}),{once:!0}):console.warn("Animation element not found")}init(){if(this.tocEl=document.getElementById("toc-inner-wrapper"),this.tocEl&&(this.tocEl.addEventListener("click",this.handleAnchorClick,{capture:!0}),this.activeIndicator=document.getElementById("active-indicator"),this.tocEntries=Array.from(document.querySelectorAll("#toc a[href^='#']")),0!==this.tocEntries.length)){this.sections=new Array(this.tocEntries.length),this.headings=new Array(this.tocEntries.length);for(let t=0;t<this.tocEntries.length;t++){const e=decodeURIComponent(this.tocEntries[t].hash?.substring(1)),i=document.getElementById(e),n=i?.parentElement;i instanceof HTMLElement&&n instanceof HTMLElement&&(this.headings[t]=i,this.sections[t]=n,this.headingIdxMap.set(e,t))}this.active=new Array(this.tocEntries.length).fill(!1),this.sections.forEach((t=>this.observer.observe(t))),this.fallback(),this.update()}}disconnectedCallback(){this.sections.forEach((t=>this.observer.unobserve(t))),this.observer.disconnect(),this.tocEl?.removeEventListener("click",this.handleAnchorClick)}}customElements.define("table-of-contents",h)</script><div class="h-8 w-full"></div></div></div></div><!-- #toc needs to exist for Swup to work normally --></div></div><div class="hidden h-[300vh]" id=page-height-extend style=--bannerOffset:15vh;--banner-height-home:65vh;--banner-height:35vh;--configHue:250;--page-width:75rem data-astro-cid-sckkx6r4></div><script type=module src=/_astro/Layout.astro_astro_type_script_index_0_lang.Dfc1V895.js></script><script type=module src=/_astro/Layout.astro_astro_type_script_index_1_lang.wh3O24fx.js></script></body></html>