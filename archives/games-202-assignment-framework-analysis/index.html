<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>GAMES 202 作业代码框架剖析 | Von Brank</title><meta name="author" content="Von Brank"><meta name="copyright" content="Von Brank"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="《GAMES202：高质量实时渲染》是由闫令琪老师开设的计算机图形学进阶课程。相比 GAMES 101，GAMES 202 不仅作业内容的难度更高，其代码框架也更难以理解。由于对代码框架、尤其是 WebGL API 的理解直接影响到完成作业的思路，并且 GAMES 202 代码框架也是使用 WebGL 封装简易图形渲染引擎的一次很好的实践，因此本文将对 GAMES 202 使用了 WebGL 的部">
<meta property="og:type" content="article">
<meta property="og:title" content="GAMES 202 作业代码框架剖析">
<meta property="og:url" content="https://vonbrank.github.io/archives/games-202-assignment-framework-analysis/index.html">
<meta property="og:site_name" content="Von Brank">
<meta property="og:description" content="《GAMES202：高质量实时渲染》是由闫令琪老师开设的计算机图形学进阶课程。相比 GAMES 101，GAMES 202 不仅作业内容的难度更高，其代码框架也更难以理解。由于对代码框架、尤其是 WebGL API 的理解直接影响到完成作业的思路，并且 GAMES 202 代码框架也是使用 WebGL 封装简易图形渲染引擎的一次很好的实践，因此本文将对 GAMES 202 使用了 WebGL 的部">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn2.unrealengine.com/Unreal+Engine%2Fblog%2Fporsche-nvidia-and-epic-games-reveal-the-speed-of-light-for-porsche-911-speedster-concept%2FSpeed_of_Light_Hero_1_1920-1920x873-0006adad2a4df33615d426901e38ae89a7a5d25a.jpg">
<meta property="article:published_time" content="2023-08-23T07:30:36.000Z">
<meta property="article:modified_time" content="2023-08-27T05:14:52.105Z">
<meta property="article:author" content="Von Brank">
<meta property="article:tag" content="教程">
<meta property="article:tag" content="计算机图形学">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn2.unrealengine.com/Unreal+Engine%2Fblog%2Fporsche-nvidia-and-epic-games-reveal-the-speed-of-light-for-porsche-911-speedster-concept%2FSpeed_of_Light_Hero_1_1920-1920x873-0006adad2a4df33615d426901e38ae89a7a5d25a.jpg"><link rel="shortcut icon" href="https://vonbrank-images.oss-cn-hangzhou.aliyuncs.com/20230826-Blog-Image/system/vonbrank-profile.jpg"><link rel="canonical" href="https://vonbrank.github.io/archives/games-202-assignment-framework-analysis/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'GAMES 202 作业代码框架剖析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-08-27 13:14:52'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Von Brank" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://vonbrank-images.oss-cn-hangzhou.aliyuncs.com/20230826-Blog-Image/system/vonbrank-profile.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">53</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn2.unrealengine.com/Unreal+Engine%2Fblog%2Fporsche-nvidia-and-epic-games-reveal-the-speed-of-light-for-porsche-911-speedster-concept%2FSpeed_of_Light_Hero_1_1920-1920x873-0006adad2a4df33615d426901e38ae89a7a5d25a.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Von Brank"><span class="site-name">Von Brank</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">GAMES 202 作业代码框架剖析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-08-23T07:30:36.000Z" title="发表于 2023-08-23 15:30:36">2023-08-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-27T05:14:52.105Z" title="更新于 2023-08-27 13:14:52">2023-08-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/">计算机图形学</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">11.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>47分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="GAMES 202 作业代码框架剖析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>《GAMES202：高质量实时渲染》是由闫令琪老师开设的计算机图形学进阶课程。相比 GAMES 101，GAMES 202 不仅作业内容的难度更高，其代码框架也更难以理解。由于对代码框架、尤其是 WebGL API 的理解直接影响到完成作业的思路，并且 GAMES 202 代码框架也是使用 WebGL 封装简易图形渲染引擎的一次很好的实践，因此本文将对 GAMES 202 使用了 WebGL 的部分作业代码框架进行剖析，尝试解释代码框架中每一个文件、每一行代码做了什么，从而为更好更深入地理解和完成作业内容打下坚实基础。</p>
<h2 id="WebGL-使用方法回顾">WebGL 使用方法回顾</h2>
<p>WebGL 是 OpenGL 的一个子集，是一套光栅化 API。浏览器在底层实现了 OpenGL 标准接口并在以 JavaScript 封装的方式提供给开发者使用，开发者首先通过 <code>canvas</code> 元素获取 WebGL 上下文对象，通过操作该对象上的 WebGL 接口并输出到画布上，从而实现各类渲染功能。</p>
<p>要在 WebGL 中实现渲染物体，比如渲染一个三角形，需要向着色器提供以下几类数据：</p>
<ul>
<li><code>Attributes</code> 和 <code>Buffer</code>：Buffer 通常是一个类似数组的东西，里面按顺序存储了物体的顶点、法线、纹理坐标、颜色等信息。将一组 Buffer 提供给着色器，通过 <code>Attributes</code> 来告诉着色器如何理解这些数据（如多少个数表示第一个顶点，一次渲染中这一组数据在着色器中对应的变量名称是什么等）</li>
<li><code>Uniforms</code>：可以认为是渲染一帧过程中，着色器程序每次运行过程中都不变的常量，如摄像机的参数、光源的位置等</li>
<li><code>Textures</code>：纹理数据在渲染过程中的数据不必多说，WebGL 提供 <code>Textures</code> 数据类型及其相关方法专门用于传递纹理数据，当然，这也只是一种数据类型而已，开发者也可以向其中存储任意类型的数据，并以自己理解的方式进行读取和使用，前提是使用 <code>Textures</code> 数据类型提供的数据操作方法</li>
</ul>
<p>WebGL 在运行过程中，首先将顶点数据输入顶点着色器（Vertex Shader），以由 <code>Attributes</code> 和 <code>Buffer</code> 提供的顶点数据为单位将顶点坐标变换到裁剪空间，接着根据顶点进行光栅化和插值，以插值得到的每一个结果作为片元着色器（Fragment Shader）的输入，运行该着色器以获得一个像素的值。该过程中渲染所需的其他参数，如变换规则、摄像机的位置、光源位置等，需通过 <code>Uniforms</code> 和 <code>Textures</code> 得到。</p>
<p><img src="https://webglfundamentals.org/webgl/lessons/resources/vertex-shader-anim.gif" alt="顶点着色器运行过程"></p>
<p>更多关于 WebGL 使用方法的内容，请参考 <a target="_blank" rel="noopener" href="https://webglfundamentals.org/">WebGL Fundamentals</a></p>
<h2 id="将官方代码框架引入现代前端开发流的说明">将官方代码框架引入现代前端开发流的说明</h2>
<p>GAMES202 课程作业大都基于 WebGL 实现。得益于 WebGL 简单易用的特点，这免去了我们手动配置 OpenGL 的麻烦。</p>
<p>然而原代码框架使用传统 Web 前端技术与原生 JavaScript 进行编写，缺乏代码提示与静态检查，使得完成作业、调试 bug 较为困难。</p>
<p>因此笔者针对 GAMES202 官方作业代码框架进行了简单修改，将原代码框架迁移至 TypeScript，使用 Vite 进行打包，并引入 ES Module 模块化，同时实现类型声明与静态检查，期望能提升开发体验。项目链接：<a target="_blank" rel="noopener" href="https://github.com/vonbrank/GAMES202-Assignment-Framework-with-TypeScript-Support">GAMES202 Assignment Framework with TypeScript Support</a></p>
<p>本文针对代码框架的剖析都将基于迁移到 TypeScript 的版本进行。</p>
<h2 id="作业-0-代码框架详解">作业 0 代码框架详解</h2>
<h3 id="GAMES-202-作业代码框架体系结构">GAMES 202 作业代码框架体系结构</h3>
<p>作业 0 的代码框架目录结构如下：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">+</span><br><span class="line">|   .gitignore</span><br><span class="line">|   index.html</span><br><span class="line">|   package.json</span><br><span class="line">|   tsconfig.json</span><br><span class="line">|   vite.config.ts</span><br><span class="line">|   yarn.lock</span><br><span class="line">|</span><br><span class="line">+---public</span><br><span class="line">|   |   vite.svg</span><br><span class="line">|   |</span><br><span class="line">|   \---assets</span><br><span class="line">|       \---mary</span><br><span class="line">|               Marry.mtl</span><br><span class="line">|               Marry.obj</span><br><span class="line">|               MC003_Kozakura_Mari.png</span><br><span class="line">|</span><br><span class="line">\---src</span><br><span class="line">    |   engine.ts</span><br><span class="line">    |   main.ts</span><br><span class="line">    |   style.css</span><br><span class="line">    |   typescript.svg</span><br><span class="line">    |   vite-env.d.ts</span><br><span class="line">    |</span><br><span class="line">    +---lights</span><br><span class="line">    |       Light.ts</span><br><span class="line">    |       PointLight.ts</span><br><span class="line">    |</span><br><span class="line">    +---loads</span><br><span class="line">    |       loadOBJ.ts</span><br><span class="line">    |       loadShader.ts</span><br><span class="line">    |</span><br><span class="line">    +---materials</span><br><span class="line">    |       Material.ts</span><br><span class="line">    |</span><br><span class="line">    +---objects</span><br><span class="line">    |       Mesh.ts</span><br><span class="line">    |</span><br><span class="line">    +---renderers</span><br><span class="line">    |       MeshRender.ts</span><br><span class="line">    |       WebGLRenderer.ts</span><br><span class="line">    |</span><br><span class="line">    +---shaders</span><br><span class="line">    |   |   Shader.ts</span><br><span class="line">    |   |</span><br><span class="line">    |   +---InternalShader</span><br><span class="line">    |   |       FragmentShader.glsl</span><br><span class="line">    |   |       index.ts</span><br><span class="line">    |   |       LightCubeFragmentShader.glsl</span><br><span class="line">    |   |       LightCubeVertexShader.glsl</span><br><span class="line">    |   |       VertexShader.glsl</span><br><span class="line">    |   |</span><br><span class="line">    |   +---lightShader</span><br><span class="line">    |   |       fragment.glsl</span><br><span class="line">    |   |       vertex.glsl</span><br><span class="line">    |   |</span><br><span class="line">    |   \---phongShader</span><br><span class="line">    |           fragment.glsl</span><br><span class="line">    |           vertex.glsl</span><br><span class="line">    |</span><br><span class="line">    \---textures</span><br><span class="line">            Texture.ts</span><br></pre></td></tr></table></figure>
<ul>
<li><code>index.html</code>：描述网页的布局文件，这里只需要一个充满屏幕的 <code>canvas</code> 元素即可，用来获取 WebGL 的上下文</li>
<li><code>public</code> 文件夹：存放各类公共资源，如网页 logo，要渲染的模型等，在 JavaScript 中引入本地静态资源时使用的相对路径可以被认为是以此为根目录的相对路径。
<ul>
<li><code>assets</code>：这里一般存放要渲染的模型资产，如要在 JavaScript 中访问 <code>marry</code> 文件夹，使用 <code>assets/marry</code> 进行访问即可</li>
</ul>
</li>
<li><code>src</code>：这是存放各类代码的地方，包括 TypeScript 文件和 GLSL 文件
<ul>
<li><code>main.ts</code>：程序的入口，从这里调用来自 <code>engine.ts</code> 的 <code>GAMES202Main</code> 来初始化 WebGL 配置、加载并渲染模型等</li>
<li><code>engine.ts</code>：定义了 <code>GAMES202Main</code> 函数和摄像机的初始位置，在该函数中，首先从 DOM 树中获取在 <code>index.html</code> 定义的 <code>canvas</code> 元素，创建一个用于操作 WebGL 的上下文；接着使用 <code>THREE.js</code> 创建摄像机对象用于生成可以在 Shader 中使用的各类摄像机参数；然后创建光源数据，和一个自定义的、使用 WebGL 接口封装的 Mesh Renderer，用以渲染从资产文件中加载出来的包含顶点、纹理坐标、法线数据的模型；最后进入消息循环，监听镜头移动并持续刷新渲染场景。</li>
<li><code>renders</code>：通过传入摄像机数据、光源位置，和定义了顶点、纹理坐标、法线等信息的 Mesh 来向 <code>engine.ts</code> 提供两种渲染功能
<ul>
<li><code>WebGLRenderer.ts</code>：总的渲染器，通过保存若干光源、Mesh 和摄像机的信息，调用内置 Shader 的 MeshRender 实例的 <code>draw</code> 方法、传入摄像机、光源参数，以实现渲染整个场景中渲染所有 Mesh 和光源的功能</li>
<li><code>MeshRenderer.ts</code>：提供渲染一个 Mesh 的功能，通过保存一个模型的所有顶点、法线、材质、纹理坐标、缓冲等数据，在 <code>draw</code> 函数中根据传入的 Transform、摄像机参数等实现在场景中渲染单个 Mesh</li>
</ul>
</li>
<li><code>objects</code>：
<ul>
<li><code>Mesh.ts</code>：直接存储一个 Mesh 的各类数据，包括所有顶点坐标、顶点对应的法线方向、顶点对应的纹理坐标、每个三角形对应三个顶点的索引</li>
</ul>
</li>
<li><code>materials</code>：定义了各种项目所需的 Material，在作业 0 中只有 Blinn-Phong 模型的 Material 及其 Shader
<ul>
<li><code>Materials.ts</code>：保存了对赋予了该材质的表面进行渲染/着色的过程中所使用的着色器的源码，以及渲染管线中需要从外部传入的 <code>Uniforms</code> 数据的名称，将要输入顶点着色器的各类 <code>Attributes</code> 在顶点着色器中的变量名等</li>
</ul>
</li>
<li><code>shaders</code>：保存了项目所需的各类着色器的源码，以及从 WebGL 封装的着色器类
<ul>
<li><code>Shader.ts</code>：通过传入顶点着色器与片元着色器的源码、该源码需要关注的 <code>Attributes</code> 与 <code>Uniforms</code> 名称列表，编译着色器，并整理出所有需要关注的 <code>Attributes</code> 的顶点着色器中的索引和 <code>Uniforms</code> 在整个渲染管线中的 <code>WebGLUniformLocation</code> 值，以便为 <code>Material</code> 提供编译着色器与快速设置 <code>Attributes</code> 和 <code>Uniforms</code> 值的服务</li>
</ul>
</li>
<li><code>textures</code>：
<ul>
<li><code>Texture.ts</code>：向 <code>OBJ Loader</code> 和 <code>Material</code> 模块提供将 <code>HTMLImageElement</code> 转换为 <code>WebGLTexture</code> 的功能</li>
</ul>
</li>
<li><code>loads</code>：几种外部资源加载器
<ul>
<li><code>loadOBJ.ts</code>：提供从本地加载模型资产的功能，通过传入 <code>WebGLRenderer</code> 和文件路径，借助 <code>THREE.js</code> 提供的 <code>MTLLoader</code> 来从本地加载模型资产、纹理等数据，自动为 <code>MeshRender</code> 创建 <code>Mesh</code>，<code>Material</code>，<code>Texture</code> 数据并添加到 <code>WebGLRenderer</code> 中</li>
<li><code>loadShader.ts</code>：允许用户从本地加载着色器源码，但因为我们使用 Vite 进行打包，可以在项目编译期直接以字符串形式在 JavaScript 代码中引入着色器源码，故 <code>loadShader</code> 功能可弃用</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="GAMES-202-Engine">GAMES 202 Engine</h3>
<p>这部分主要讲述程序入口处调用的第一个，也是唯一一个函数 <code>GAMES202Main</code> 与包含这个函数的 <code>engine.ts</code> 的功能。</p>
<h4 id="总体功能">总体功能</h4>
<p>先总体说一下 <code>GAMES202Main</code> 的功能：当浏览器打开本项目的页面时，Chrome 自动加载一同随 Web 应用打包的 JavaScript 文件，接着就会调用 <code>GAMES202Main</code> 函数，在调用前，由 <code>index.html</code> 定义的页面所对应的 DOM 树就已经生成。因此在 <code>GAMES202Main</code> 中可以直接获取到页面中定义的 <code>canvas</code> 元素，进而获取对应的 <code>WebGLRenderingContext</code> 以便操作该 <code>canvas</code> 的渲染。</p>
<p>获取完 <code>WebGLRenderingContext</code> 实例后就要准备渲染所需要的一系列参数了，<code>GAMES202Main</code> 首先准备的是摄像机的参数。我们知道，不论是光栅化还是光线追踪渲染，定义摄像机实际上就是在定义摄像机位置、屏幕长宽比、场视角（FOV）、屏幕到摄像机的距离等，这些数据将用于定义光栅化渲染中的 MVP 矩阵或光线追踪中发射光线的范围限制，总之这些数据最终会转换为 GLSL 中某些 <code>Uniforms</code> 参数。<code>GAMES202Main</code> 使用 <code>THREE.js</code> 的 <code>PerspectiveCamera</code> 来构造摄像机实例，<code>PerspectiveCamera</code> 可以仅通过 FOV、长宽比、最近最远距离来定义摄像机，进而计算 MVP 矩阵；此外程序还构造了一个同样由 <code>THREE.js</code> 提供的 <code>OrbitControls</code> 摄像机控制组件实例，可以通过修改该实例来控制摄像机的运动、朝向等，从而无需手动通过修改摄像机参数的方式来处理摄像机的运动。</p>
<p>除了摄像机，<code>GAMES202Main</code> 还会创建一个 <code>WebGLRenderer</code> 对象，如前文所述，该对象是自定义的，可以为其指定 <code>WebGLRenderingContext</code> 和由 <code>THREE.js</code> 创建的摄像机对象，并向其中添加 <code>MeshRender</code> 对象、光源对象等来实现渲染场景中的多个物体和光源。</p>
<p>接着程序创建好场景所需的一个光源、得到一个 <code>PointLight</code>，再从 <code>loadOBJ</code> 加载要渲染的模型、获得一个 <code>MeshRender</code>，并将它们都添加到 <code>WebGLRenderer</code> 的渲染列表中。</p>
<p>然后使用 <code>THREE.js</code> 提供的 <code>dat.gui</code> 库来快速向页面上添加一个基于 <code>HTML</code> 元素的 GUI。</p>
<p>最后，<code>GAMES202Main</code> 陷入循环，在每一轮循环首先通过 <code>cameraControls</code> 来更新摄像机参数，再使用 <code>WebGLRenderer</code> 来更新 <code>canvas</code> 元素中的渲染内容。</p>
<h4 id="engine-ts-代码注释"><code>engine.ts</code> 代码注释</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入依赖项</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">&#x27;three&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; OrbitControls &#125; <span class="keyword">from</span> <span class="string">&#x27;three/examples/jsm/controls/OrbitControls&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PointLight &#125; <span class="keyword">from</span> <span class="string">&#x27;./lights/PointLight&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> dat <span class="keyword">from</span> <span class="string">&#x27;dat.gui&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; WebGLRenderer &#125; <span class="keyword">from</span> <span class="string">&#x27;./renderers/WebGLRenderer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; loadOBJ &#125; <span class="keyword">from</span> <span class="string">&#x27;./loads/loadOBJ&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义摄像机的初始位置</span></span><br><span class="line"><span class="keyword">var</span> cameraPosition = [-<span class="number">20</span>, <span class="number">180</span>, <span class="number">250</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">GAMES202Main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// document 对象是 JavaScript 与前端网页中的 HTML 元素进行交互的接口</span></span><br><span class="line">  <span class="comment">// 这里是从 DOM 树中获取 id 为 glcanvas 的 HTMLCanvasElement 对象</span></span><br><span class="line">  <span class="comment">// querySelector 函数通过传入一个 CSS 选择器 &#x27;#glcanvas&#x27; 来从 DOM 树中筛选出</span></span><br><span class="line">  <span class="comment">// 第一个 id 为 glcanvas 的元素</span></span><br><span class="line">  <span class="comment">// &lt;HTMLCanvasElement&gt; 泛型表明期望返回 HTMLCanvasElement | null 类型的对象</span></span><br><span class="line">  <span class="keyword">const</span> canvas = <span class="built_in">document</span>.querySelector&lt;HTMLCanvasElement&gt;(<span class="string">&#x27;#glcanvas&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span>(canvas === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果返回了 null，表明不存在 id 为 glcanvas 的 HTMLCanvasElement 元素</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;can not find #glcanvas&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将 canvas 的长宽更新为浏览器视口的长和宽</span></span><br><span class="line">  canvas.width = <span class="built_in">window</span>.screen.width;</span><br><span class="line">  canvas.height = <span class="built_in">window</span>.screen.height;</span><br><span class="line">  <span class="comment">// 从 canvas 对象中获取 WebGLRenderingContext，便于后续控制画布渲染</span></span><br><span class="line">  <span class="keyword">const</span> gl = canvas.getContext(<span class="string">&#x27;webgl&#x27;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!gl) &#123;</span><br><span class="line">     <span class="comment">// 如果没有成功获取，说明浏览器可能不支持 WebGL</span></span><br><span class="line">    alert(<span class="string">&#x27;Unable to initialize WebGL. Your browser or machine may not support it.&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 THREE.js 创建了一个透视投影摄像机，FOV = 75，长宽比为 canvas 自己的长宽比</span></span><br><span class="line">  <span class="comment">// 远点和近点分别为 1000 和 0.1</span></span><br><span class="line">  <span class="keyword">const</span> camera = <span class="keyword">new</span> THREE.PerspectiveCamera(<span class="number">75</span>, canvas.clientWidth / canvas.clientHeight, <span class="number">0.1</span>, <span class="number">1000</span>);</span><br><span class="line">  <span class="comment">// 创建一个摄像机控制对象，并将其绑定到先前创建的摄像机上</span></span><br><span class="line">  <span class="keyword">const</span> cameraControls = <span class="keyword">new</span> OrbitControls(camera, canvas);</span><br><span class="line">  <span class="comment">// 设置摄像机的控制参数：</span></span><br><span class="line">  <span class="comment">// 允许缩放、旋转、移动</span></span><br><span class="line">  <span class="comment">// 旋转、缩放、移动速度分别为 0.3, 1.0, 2.0</span></span><br><span class="line">  cameraControls.enableZoom = <span class="literal">true</span>;</span><br><span class="line">  cameraControls.enableRotate = <span class="literal">true</span>;</span><br><span class="line">  cameraControls.enablePan = <span class="literal">true</span>;</span><br><span class="line">  cameraControls.rotateSpeed = <span class="number">0.3</span>;</span><br><span class="line">  cameraControls.zoomSpeed = <span class="number">1.0</span>;</span><br><span class="line">  cameraControls.keyPanSpeed = <span class="number">2.0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 封装设置摄像机长宽比的功能</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setSize</span>(<span class="params">width: <span class="built_in">number</span>, height: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 重新计算长宽比</span></span><br><span class="line">    camera.aspect = width / height;</span><br><span class="line">    <span class="comment">// 根据新的长宽比重新计算投影变换矩阵</span></span><br><span class="line">    <span class="comment">// 即 MVP 矩阵变换中的 P</span></span><br><span class="line">    camera.updateProjectionMatrix();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用画布的长宽比更新摄像机的长宽比及其投影变换矩阵</span></span><br><span class="line">  setSize(canvas.clientWidth, canvas.clientHeight);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听浏览器视口的 resize 事件，以便在用户缩放视口时摄像机参数仍实时正确更新</span></span><br><span class="line">  <span class="built_in">window</span>.addEventListener(<span class="string">&#x27;resize&#x27;</span>, <span class="function">() =&gt;</span> setSize(canvas.clientWidth, canvas.clientHeight));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化摄像机位置</span></span><br><span class="line">  camera.position.set(cameraPosition[<span class="number">0</span>], cameraPosition[<span class="number">1</span>], cameraPosition[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过 camaeraControls 设置摄像机的朝向位置</span></span><br><span class="line">  cameraControls.target.set(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个光源，并初始化其亮度、位置</span></span><br><span class="line">  <span class="keyword">const</span> pointLight = <span class="keyword">new</span> PointLight(<span class="number">250</span>, [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个 WebGLRenderer 渲染器对象，并将 WebGL 渲染上下文和摄像机对象绑定到其上</span></span><br><span class="line">  <span class="keyword">const</span> renderer = <span class="keyword">new</span> WebGLRenderer(gl, camera);</span><br><span class="line">  <span class="comment">// 向渲染器中添加光源</span></span><br><span class="line">  renderer.addLight(pointLight);</span><br><span class="line">  <span class="comment">// 从本地的 assets/mary 目录中加载名为 Marry 的资源模型，并添加到渲染器对象中</span></span><br><span class="line">  loadOBJ(renderer, <span class="string">&#x27;assets/mary/&#x27;</span>, <span class="string">&#x27;Marry&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 以下涉及 dat.GUI 的基本使用</span></span><br><span class="line">  <span class="comment">// 简单来说，这里先定义了需要使用 dat.GUI 控制的数据 guiParams</span></span><br><span class="line">  <span class="comment">// 使用 dat.GUI 创建一个 GUI 的实例后，使用 addFolder 来添加数据面板</span></span><br><span class="line">  <span class="comment">// 每个面板可以包含若干用来调整数据的 UI</span></span><br><span class="line">  <span class="comment">// 调用面板的 add 方法可以通过传入要操控的数据对象引用、操控的对象名称、</span></span><br><span class="line">  <span class="comment">// 和在面板中显示的对象名字，来实现将对象的某一字段绑定到面板中</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义需要使用 dat.GUI 控制的数据：模型的 translation 和 scale</span></span><br><span class="line">  <span class="comment">// 分别初始化为 (0, 0, 0) 和 (52, 52, 52)</span></span><br><span class="line">  <span class="keyword">var</span> guiParams = &#123;</span><br><span class="line">    modelTransX: <span class="number">0</span>,</span><br><span class="line">    modelTransY: <span class="number">0</span>,</span><br><span class="line">    modelTransZ: <span class="number">0</span>,</span><br><span class="line">    modelScaleX: <span class="number">52</span>,</span><br><span class="line">    modelScaleY: <span class="number">52</span>,</span><br><span class="line">    modelScaleZ: <span class="number">52</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createGUI</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个 dat.GUI 实例</span></span><br><span class="line">    <span class="keyword">const</span> gui = <span class="keyword">new</span> dat.GUI();</span><br><span class="line">    <span class="comment">// 创建一个总的面板，名为 panelModel</span></span><br><span class="line">    <span class="keyword">const</span> panelModel = gui.addFolder(<span class="string">&#x27;Model properties&#x27;</span>);</span><br><span class="line">    <span class="comment">// 在 panelModel 下创建两个子面板，分别名为 Translation 和 Scale</span></span><br><span class="line">    <span class="keyword">const</span> panelModelTrans = panelModel.addFolder(<span class="string">&#x27;Translation&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> panelModelScale = panelModel.addFolder(<span class="string">&#x27;Scale&#x27;</span>);</span><br><span class="line">    <span class="comment">// 在 Translation 面板下添加一个参数输入框与控制杆，</span></span><br><span class="line">    <span class="comment">// 表示将这个控件的值与 guiParams 中名为 modelTransX 的字段绑定起来</span></span><br><span class="line">    <span class="comment">// 每次在 UI 中更新它的值，都将更新 guiParams 的值</span></span><br><span class="line">    <span class="comment">// 并在面板中将这个值的名称显示为 X</span></span><br><span class="line">    panelModelTrans.add(guiParams, <span class="string">&#x27;modelTransX&#x27;</span>).name(<span class="string">&#x27;X&#x27;</span>);</span><br><span class="line">    <span class="comment">// 其他 add 语句的含义与上述相同</span></span><br><span class="line">    panelModelTrans.add(guiParams, <span class="string">&#x27;modelTransY&#x27;</span>).name(<span class="string">&#x27;Y&#x27;</span>);</span><br><span class="line">    panelModelTrans.add(guiParams, <span class="string">&#x27;modelTransZ&#x27;</span>).name(<span class="string">&#x27;Z&#x27;</span>);</span><br><span class="line">    panelModelScale.add(guiParams, <span class="string">&#x27;modelScaleX&#x27;</span>).name(<span class="string">&#x27;X&#x27;</span>);</span><br><span class="line">    panelModelScale.add(guiParams, <span class="string">&#x27;modelScaleY&#x27;</span>).name(<span class="string">&#x27;Y&#x27;</span>);</span><br><span class="line">    panelModelScale.add(guiParams, <span class="string">&#x27;modelScaleZ&#x27;</span>).name(<span class="string">&#x27;Z&#x27;</span>);</span><br><span class="line">    <span class="comment">// 依次展开 panelModel，panelModelTrans 和 panelModelScale 面板</span></span><br><span class="line">    panelModel.open();</span><br><span class="line">    panelModelTrans.open();</span><br><span class="line">    panelModelScale.open();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建 dat.GUI 实例并将 guiParams 绑定到 GUI 上</span></span><br><span class="line">  createGUI();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// requestAnimationFrame 是由浏览器提供的动画 API，可以认为传入的函数将在下一次浏览器更新动画时被执行</span></span><br><span class="line">  <span class="comment">// 传入的 mainLoop 是用于在每一帧进行渲染的主循环函数</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mainLoop</span>(<span class="params">now: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// cameraControls 实际上提供了使用鼠标、滚轮更新其参数的功能</span></span><br><span class="line">    <span class="comment">// 因此每一帧其中的数据都可能更新</span></span><br><span class="line">    <span class="comment">// 需要调用 update 来更新 cameraControls 自身的某些参数</span></span><br><span class="line">    <span class="comment">// 和被其控制的摄像机的参数</span></span><br><span class="line">    cameraControls.update();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用新的（可能被用户通过 dat.GUI 更新的）guiParams 来对场景和模型进行重新渲染</span></span><br><span class="line">    renderer.render(guiParams);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在主循环结尾再次将自身传入 requestAnimationFrame 可以实现浏览器每帧动画更新时都重新渲染 canvas 的内容</span></span><br><span class="line">    requestAnimationFrame(mainLoop);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 在引擎各参数初始化完成后手动调用第一次 requestAnimationFrame 来进入主渲染循环</span></span><br><span class="line">  requestAnimationFrame(mainLoop);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Renderer">Renderer</h3>
<p>要想渲染一个场景，首先需要一个对象用来管理整个场景中的所有物体，如摄像机、可渲染的 Mesh、灯光等。在本例中，除了场景本身的表示，我们还需要一种方式来表示场景中可以被渲染的每一个 Mesh。</p>
<h4 id="总体功能-2">总体功能</h4>
<p>GAMES 202 的代码框架提供了 <code>WebGLRenderer</code> 类来存储和管理整个场景中的摄像机、灯光和 Mesh 等数据，在 <code>engine.ts</code> 的 <code>GAMES202Main</code> 函数中，我们曾通过调用 <code>WebGLRenderer</code> 函数来重新渲染整个场景，其内部实际上是先清空整块画布，接着在有光源的情况下使用两重循环来遍历场景中的所有光源，针对某一个光源再遍历场景中的所有物体，在每个物体渲染前为 Shader 通过 <code>Uniforms</code> 设置光源的位置、强度等信息，再绘制物体，从而实现渲染一个单光源甚至多光源的场景。</p>
<p>单个 Mesh 的表示和渲染方面，代码框架提供了 <code>MeshRender</code> 来保存渲染一个 Mesh 所需要的 <code>Mesh</code> 对象（包含使用 JavaScript 原生数据类型保存的顶点、法线、纹理坐标等数据）、材质、着色器实例，以及提供与 WebGL 交换数据的 <code>WebGLBuffer</code> 的引用。<code>MeshRender</code> 还提供 <code>draw</code> 方法，在其内先向 WebGL 通过设置 <code>Attributes</code> 来传递各类顶点坐标、法线、纹理坐标等数据，接着通过 <code>gl.uniformXXX</code> 系列方法从材质实例和 <code>draw</code> 函数参数中读取并设置 Shader 的各类 <code>Uniforms</code> 渲染参数，最后调用 <code>gl.drawElements</code> 来实现渲染单个物体。</p>
<h4 id="WebGLRenderer-ts-代码注释"><code>WebGLRenderer.ts</code> 代码注释</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入依赖项</span></span><br><span class="line"><span class="keyword">import</span> &#123; MeshRender &#125; <span class="keyword">from</span> <span class="string">&quot;./MeshRender&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">&quot;three&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PointLight &#125; <span class="keyword">from</span> <span class="string">&quot;../lights/PointLight&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; vec3 &#125; <span class="keyword">from</span> <span class="string">&quot;gl-matrix&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 保存一组 Transform 参数，包含位移和缩放信息，但保持物体旋转不变</span></span><br><span class="line"><span class="comment">// Remain rotatation</span></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">TRSTransform</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 位移数据</span></span><br><span class="line">    translate: vec3;</span><br><span class="line">    <span class="comment">// 缩放数据</span></span><br><span class="line">    scale: vec3;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">translate: vec3 = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], scale: vec3 = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>]</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.translate = translate;</span><br><span class="line">        <span class="built_in">this</span>.scale = scale;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">WebGLRenderer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存场景中所有的 MeshRender</span></span><br><span class="line">    meshes: MeshRender[] = [];</span><br><span class="line">    <span class="comment">// 保存场景中所有的光源</span></span><br><span class="line">    <span class="comment">// 包含光源本身的数据，以及光源模型自己的 MeshRender</span></span><br><span class="line">    lights: &#123;</span><br><span class="line">        entity: PointLight;</span><br><span class="line">        meshRender: MeshRender;</span><br><span class="line">    &#125;[] = [];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存目标画布的 WebGL 渲染上下文</span></span><br><span class="line">    gl: WebGLRenderingContext;</span><br><span class="line">    <span class="comment">// 保存先前创建的透视投影摄像机的引用</span></span><br><span class="line">    camera: THREE.PerspectiveCamera;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数，需要传入 WebGL 渲染上下文和相应的透视投影摄像机</span></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">gl: WebGLRenderingContext, camera: THREE.PerspectiveCamera</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.gl = gl;</span><br><span class="line">        <span class="built_in">this</span>.camera = camera;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加一组点光源，除了保存点光源外，并使用光源对应的 Mesh 和材质创建一个光源对应的 MeshRender</span></span><br><span class="line">    <span class="function"><span class="title">addLight</span>(<span class="params">light: PointLight</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.lights.push(&#123;</span><br><span class="line">            entity: light,</span><br><span class="line">            meshRender: <span class="keyword">new</span> MeshRender(<span class="built_in">this</span>.gl, light.mesh, light.mat),</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为场景添加一个 MeshRender</span></span><br><span class="line">    <span class="function"><span class="title">addMesh</span>(<span class="params">mesh: MeshRender</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.meshes.push(mesh);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以 guiParams 包含的位移、缩放参数来重新渲染整个场景</span></span><br><span class="line">    render(guiParams: &#123;</span><br><span class="line">        modelTransX: <span class="built_in">number</span>;</span><br><span class="line">        modelTransY: <span class="built_in">number</span>;</span><br><span class="line">        modelTransZ: <span class="built_in">number</span>;</span><br><span class="line">        modelScaleX: <span class="built_in">number</span>;</span><br><span class="line">        modelScaleY: <span class="built_in">number</span>;</span><br><span class="line">        modelScaleZ: <span class="built_in">number</span>;</span><br><span class="line">    &#125;) &#123;</span><br><span class="line">        <span class="keyword">const</span> gl = <span class="built_in">this</span>.gl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将画布清空，像素充值为不透明黑色，同时重置 Z 深度，并重新启用深度测试</span></span><br><span class="line">        gl.clearColor(<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>); <span class="comment">// Clear to black, fully opaque</span></span><br><span class="line">        gl.clearDepth(<span class="number">1.0</span>); <span class="comment">// Clear everything</span></span><br><span class="line">        gl.enable(gl.DEPTH_TEST); <span class="comment">// Enable depth testing</span></span><br><span class="line">        gl.depthFunc(gl.LEQUAL); <span class="comment">// Near things obscure far things</span></span><br><span class="line"></span><br><span class="line">        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 让场景中的光源以一种特定的周期性空间曲线路径移动</span></span><br><span class="line">        <span class="comment">// Handle light</span></span><br><span class="line">        <span class="keyword">const</span> timer = <span class="built_in">Date</span>.now() * <span class="number">0.00025</span>;</span><br><span class="line">        <span class="keyword">let</span> lightPos: vec3 = [</span><br><span class="line">            <span class="built_in">Math</span>.sin(timer * <span class="number">6</span>) * <span class="number">100</span>,</span><br><span class="line">            <span class="built_in">Math</span>.cos(timer * <span class="number">4</span>) * <span class="number">150</span>,</span><br><span class="line">            <span class="built_in">Math</span>.cos(timer * <span class="number">2</span>) * <span class="number">100</span>,</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.lights.length != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> l = <span class="number">0</span>; l &lt; <span class="built_in">this</span>.lights.length; l++) &#123;</span><br><span class="line">                <span class="comment">// 遍历场景中每一个光源，用当前的新的 lightPos 更新并渲染其 Mesh</span></span><br><span class="line">                <span class="keyword">let</span> trans = <span class="keyword">new</span> TRSTransform(lightPos);</span><br><span class="line">                <span class="built_in">this</span>.lights[l].meshRender.draw(<span class="built_in">this</span>.camera, trans);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.meshes.length; i++) &#123;</span><br><span class="line">                    <span class="keyword">const</span> mesh = <span class="built_in">this</span>.meshes[i];</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 对场景中每一个 MeshRender</span></span><br><span class="line">                    <span class="comment">// 先使用 guiParams 设置其位移和缩放</span></span><br><span class="line">                    <span class="keyword">const</span> modelTranslation: vec3 = [</span><br><span class="line">                        guiParams.modelTransX,</span><br><span class="line">                        guiParams.modelTransY,</span><br><span class="line">                        guiParams.modelTransZ,</span><br><span class="line">                    ];</span><br><span class="line">                    <span class="keyword">const</span> modelScale: vec3 = [</span><br><span class="line">                        guiParams.modelScaleX,</span><br><span class="line">                        guiParams.modelScaleY,</span><br><span class="line">                        guiParams.modelScaleZ,</span><br><span class="line">                    ];</span><br><span class="line">                    <span class="keyword">let</span> meshTrans = <span class="keyword">new</span> TRSTransform(</span><br><span class="line">                        modelTranslation,</span><br><span class="line">                        modelScale</span><br><span class="line">                    );</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 应用当前 MeshRender 的着色器程序</span></span><br><span class="line">                    <span class="built_in">this</span>.gl.useProgram(mesh.shader.program.glShaderProgram);</span><br><span class="line">                    <span class="comment">// 使用当前光源位置设置着色器的参数</span></span><br><span class="line">                    <span class="comment">// 着色器中关于光源参数的 uLightPos: WebGLUniformLocation 是在着色器初始化时赋值的</span></span><br><span class="line">                    <span class="comment">// 这里可以认为是将着色器程序中第 uLightPos 号 uniforms 参数的值设置为 lightPos</span></span><br><span class="line">                    <span class="built_in">this</span>.gl.uniform3fv(</span><br><span class="line">                        mesh.shader.program.uniforms.uLightPos,</span><br><span class="line">                        lightPos</span><br><span class="line">                    );</span><br><span class="line">                    <span class="comment">// 传入摄像机和对应的 trans 来渲染该 Mesh</span></span><br><span class="line">                    mesh.draw(<span class="built_in">this</span>.camera, meshTrans);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果没有任何光源，则跳过灯光渲染，直接渲染 Mesh</span></span><br><span class="line">            <span class="comment">// Handle mesh(no light)</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.meshes.length; i++) &#123;</span><br><span class="line">                <span class="keyword">const</span> mesh = <span class="built_in">this</span>.meshes[i];</span><br><span class="line">                <span class="keyword">let</span> trans = <span class="keyword">new</span> TRSTransform();</span><br><span class="line">                mesh.draw(<span class="built_in">this</span>.camera, trans);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="MeshRender-ts-代码注释"><code>MeshRender.ts</code> 代码注释</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; mat4 &#125; <span class="keyword">from</span> <span class="string">&quot;gl-matrix&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Mesh &#125; <span class="keyword">from</span> <span class="string">&quot;../objects/Mesh&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Material &#125; <span class="keyword">from</span> <span class="string">&quot;../materials/Material&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Shader &#125; <span class="keyword">from</span> <span class="string">&quot;../shaders/Shader&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">&quot;three&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; TRSTransform &#125; <span class="keyword">from</span> <span class="string">&quot;./WebGLRenderer&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MeshRender</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 渲染一个 Mesh 所需要的几组向 WebGL 传递数据的 WebGLBuffer</span></span><br><span class="line">    <span class="comment">// 这些 WebGLBuffer 都将通过 Attributes 来将 JavaScript 端的数据</span></span><br><span class="line">    <span class="comment">// 传递给 WebGL</span></span><br><span class="line">    <span class="keyword">private</span> vertexBuffer;</span><br><span class="line">    <span class="keyword">private</span> normalBuffer;</span><br><span class="line">    <span class="keyword">private</span> texcoordBuffer;</span><br><span class="line">    <span class="keyword">private</span> indicesBuffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存 WebGL 渲染上下文</span></span><br><span class="line">    gl: WebGLRenderingContext;</span><br><span class="line">    <span class="comment">// 保存 Mesh 本身的顶点坐标、法线、纹理坐标等数据的对象</span></span><br><span class="line">    mesh: Mesh;</span><br><span class="line">    <span class="comment">// 保存要渲染 Mesh 所需要的各类参数，包括各种 Uniforms 和 Textures</span></span><br><span class="line">    material: Material;</span><br><span class="line">    <span class="comment">// 保存渲染一个 Mesh 所使用的着色器程序，</span></span><br><span class="line">    <span class="comment">// 在 MeshRender 初始化时进行编译</span></span><br><span class="line">    shader: Shader;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">gl: WebGLRenderingContext, mesh: Mesh, material: Material</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 从传入的参数初始化 gl, mesh, material 等数据</span></span><br><span class="line">        <span class="built_in">this</span>.gl = gl;</span><br><span class="line">        <span class="built_in">this</span>.mesh = mesh;</span><br><span class="line">        <span class="built_in">this</span>.material = material;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过 gl 对象为每一种 buffer 创建实例 </span></span><br><span class="line">        <span class="built_in">this</span>.vertexBuffer = gl.createBuffer();</span><br><span class="line">        <span class="built_in">this</span>.normalBuffer = gl.createBuffer();</span><br><span class="line">        <span class="built_in">this</span>.texcoordBuffer = gl.createBuffer();</span><br><span class="line">        <span class="built_in">this</span>.indicesBuffer = gl.createBuffer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> extraAttribs = [];</span><br><span class="line">        <span class="keyword">if</span> (mesh.hasVertices) &#123;</span><br><span class="line">            <span class="comment">// 如果 mesh 包含顶点坐标信息</span></span><br><span class="line">            <span class="comment">// 保存该顶点坐标序列在着色器中对应的 attribute 名字</span></span><br><span class="line">            extraAttribs.push(mesh.verticesName);</span><br><span class="line">            <span class="comment">// 将 mesh 存储在 JavaScript 端的顶点数据拷贝到 WebGL 端的 vertexBuffer</span></span><br><span class="line">            gl.bindBuffer(gl.ARRAY_BUFFER, <span class="built_in">this</span>.vertexBuffer);</span><br><span class="line">            gl.bufferData(gl.ARRAY_BUFFER, mesh.vertices, gl.STATIC_DRAW);</span><br><span class="line">            gl.bindBuffer(gl.ARRAY_BUFFER, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mesh.hasNormals) &#123;</span><br><span class="line">            <span class="comment">// 如果 mesh 包含法线信息</span></span><br><span class="line">            <span class="comment">// 保存该法线序列在着色器中对应的 attribute 名字</span></span><br><span class="line">            extraAttribs.push(mesh.normalsName);</span><br><span class="line">            <span class="comment">// 将 mesh 存储在 JavaScript 端的法线数据拷贝到 WebGL 端的 normalBuffer</span></span><br><span class="line">            gl.bindBuffer(gl.ARRAY_BUFFER, <span class="built_in">this</span>.normalBuffer);</span><br><span class="line">            gl.bufferData(gl.ARRAY_BUFFER, mesh.normals, gl.STATIC_DRAW);</span><br><span class="line">            gl.bindBuffer(gl.ARRAY_BUFFER, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mesh.hasTexcoords) &#123;</span><br><span class="line">            <span class="comment">// 如果 mesh 包含纹理坐标信息</span></span><br><span class="line">            <span class="comment">// 保存该纹理坐标序列在着色器中对应的 attribute 名字</span></span><br><span class="line">            extraAttribs.push(mesh.texcoordsName);</span><br><span class="line">            <span class="comment">// 将 mesh 存储在 JavaScript 端的纹理坐标数据拷贝到 WebGL 端的 texcoordBuffer</span></span><br><span class="line">            gl.bindBuffer(gl.ARRAY_BUFFER, <span class="built_in">this</span>.texcoordBuffer);</span><br><span class="line">            gl.bufferData(gl.ARRAY_BUFFER, mesh.texcoords, gl.STATIC_DRAW);</span><br><span class="line">            gl.bindBuffer(gl.ARRAY_BUFFER, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mesh 默认需要有顶点索引，用来描述每个三角形由顶点坐标序列中的哪几个顶点构成</span></span><br><span class="line">        <span class="comment">// 这里将 mesh 包含的顶点索引数据拷贝到 indicesBuffer</span></span><br><span class="line">        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, <span class="built_in">this</span>.indicesBuffer);</span><br><span class="line">        gl.bufferData(</span><br><span class="line">            gl.ELEMENT_ARRAY_BUFFER,</span><br><span class="line">            <span class="keyword">new</span> <span class="built_in">Uint16Array</span>(mesh.indices),</span><br><span class="line">            gl.STATIC_DRAW</span><br><span class="line">        );</span><br><span class="line">        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将新收集到的 attribute 数据名字添加到材质对象的 attribute 列表中</span></span><br><span class="line">        <span class="built_in">this</span>.material.setMeshAttribs(extraAttribs);</span><br><span class="line">        <span class="comment">// 重新从 material 对象中编译着色器</span></span><br><span class="line">        <span class="built_in">this</span>.shader = <span class="built_in">this</span>.material.compile(gl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">draw</span>(<span class="params">camera: THREE.PerspectiveCamera, transform: TRSTransform</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> gl = <span class="built_in">this</span>.gl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 MVP 变换矩阵，</span></span><br><span class="line">        <span class="comment">// 其中模型变换和视口变换直接综合到一个 modelViewMatrix 矩阵中</span></span><br><span class="line">        <span class="keyword">let</span> modelViewMatrix = mat4.create();</span><br><span class="line">        <span class="keyword">let</span> projectionMatrix = mat4.create();</span><br><span class="line"></span><br><span class="line">        camera.updateMatrixWorld();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 坐标变换算法推导：</span></span><br><span class="line">        <span class="comment">// X 表示顶点原坐标，X‘ 表示变换空间的坐标</span></span><br><span class="line">        <span class="comment">// P 表示投影变换矩阵，V 表示视口变换矩阵，M 表示模型变换矩阵</span></span><br><span class="line">        <span class="comment">// T 表示位移变换矩阵，S 表示缩放变换矩阵</span></span><br><span class="line">        <span class="comment">// M = S(T) = S T</span></span><br><span class="line">        <span class="comment">// X&#x27; = P(V(M(X))) = P V M X</span></span><br><span class="line">        <span class="comment">// 由矩阵满足交换律，上式可变换为：X&#x27; = P (V S T) X</span></span><br><span class="line">        <span class="comment">// projectionMatrix = P</span></span><br><span class="line">        <span class="comment">// modelViewMatrix = V S T</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对摄像机世界坐标求逆即可得到视口变换矩阵 V</span></span><br><span class="line">        mat4.invert(</span><br><span class="line">            modelViewMatrix,</span><br><span class="line">            <span class="keyword">new</span> <span class="built_in">Float32Array</span>(camera.matrixWorld.elements)</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// modelViewMatrix = V S T</span></span><br><span class="line">        mat4.translate(modelViewMatrix, modelViewMatrix, transform.translate);</span><br><span class="line">        mat4.scale(modelViewMatrix, modelViewMatrix, transform.scale);</span><br><span class="line">        <span class="comment">// projectionMatrix = P</span></span><br><span class="line">        mat4.copy(</span><br><span class="line">            projectionMatrix,</span><br><span class="line">            <span class="keyword">new</span> <span class="built_in">Float32Array</span>(camera.projectionMatrix.elements)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.mesh.hasVertices) &#123;</span><br><span class="line">            <span class="keyword">const</span> numComponents = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">type</span> = gl.FLOAT;</span><br><span class="line">            <span class="keyword">const</span> normalize = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">const</span> stride = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">const</span> offset = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 指示 WebGL 我们系统从 vertexBuffer 中提供 ARRAY_BUFFER 类型数据</span></span><br><span class="line">            gl.bindBuffer(gl.ARRAY_BUFFER, <span class="built_in">this</span>.vertexBuffer);</span><br><span class="line">            <span class="comment">// 将 vertexBuffer 绑定到顶点坐标在 Shader 中对应的地址</span></span><br><span class="line">            <span class="comment">// 地址/位置由 shader.program.attribs 提供，在编译 shader 时确定</span></span><br><span class="line">            gl.vertexAttribPointer(</span><br><span class="line">                <span class="built_in">this</span>.shader.program.attribs[<span class="built_in">this</span>.mesh.verticesName],</span><br><span class="line">                numComponents,</span><br><span class="line">                <span class="keyword">type</span>,</span><br><span class="line">                normalize,</span><br><span class="line">                stride,</span><br><span class="line">                offset</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">// 启用 vertexBuffer 对应地址的数据</span></span><br><span class="line">            gl.enableVertexAttribArray(</span><br><span class="line">                <span class="built_in">this</span>.shader.program.attribs[<span class="built_in">this</span>.mesh.verticesName]</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.mesh.hasNormals) &#123;</span><br><span class="line">            <span class="keyword">const</span> numComponents = <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">type</span> = gl.FLOAT;</span><br><span class="line">            <span class="keyword">const</span> normalize = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">const</span> stride = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">const</span> offset = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 指示 WebGL 我们系统从 normalBuffer 中提供 ARRAY_BUFFER 类型数据</span></span><br><span class="line">            gl.bindBuffer(gl.ARRAY_BUFFER, <span class="built_in">this</span>.normalBuffer);</span><br><span class="line">            <span class="comment">// 将 normalBuffer 绑定到顶点坐标在 Shader 中对应的地址</span></span><br><span class="line">            gl.vertexAttribPointer(</span><br><span class="line">                <span class="built_in">this</span>.shader.program.attribs[<span class="built_in">this</span>.mesh.normalsName],</span><br><span class="line">                numComponents,</span><br><span class="line">                <span class="keyword">type</span>,</span><br><span class="line">                normalize,</span><br><span class="line">                stride,</span><br><span class="line">                offset</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">// 启用 normalBuffer 对应地址的数据</span></span><br><span class="line">            gl.enableVertexAttribArray(</span><br><span class="line">                <span class="built_in">this</span>.shader.program.attribs[<span class="built_in">this</span>.mesh.normalsName]</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.mesh.hasTexcoords) &#123;</span><br><span class="line">            <span class="keyword">const</span> numComponents = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">type</span> = gl.FLOAT;</span><br><span class="line">            <span class="keyword">const</span> normalize = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">const</span> stride = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">const</span> offset = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 指示 WebGL 我们系统从 texcoordBuffer 中提供 ARRAY_BUFFER 类型数据</span></span><br><span class="line">            gl.bindBuffer(gl.ARRAY_BUFFER, <span class="built_in">this</span>.texcoordBuffer);</span><br><span class="line">            <span class="comment">// 将 texcoordBuffer 绑定到顶点坐标在 Shader 中对应的地址</span></span><br><span class="line">            gl.vertexAttribPointer(</span><br><span class="line">                <span class="built_in">this</span>.shader.program.attribs[<span class="built_in">this</span>.mesh.texcoordsName],</span><br><span class="line">                numComponents,</span><br><span class="line">                <span class="keyword">type</span>,</span><br><span class="line">                normalize,</span><br><span class="line">                stride,</span><br><span class="line">                offset</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">// 启用 texcoordBuffer 对应地址的数据</span></span><br><span class="line">            gl.enableVertexAttribArray(</span><br><span class="line">                <span class="built_in">this</span>.shader.program.attribs[<span class="built_in">this</span>.mesh.texcoordsName]</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 指示 WebGL 我们系统从 indicesBuffer 中提供 ARRAY_BUFFER 类型数据</span></span><br><span class="line">        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, <span class="built_in">this</span>.indicesBuffer);</span><br><span class="line">        <span class="comment">// 将 indicesBuffer 绑定到顶点坐标在 Shader 中对应的地址</span></span><br><span class="line">        gl.useProgram(<span class="built_in">this</span>.shader.program.glShaderProgram);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 向 Shader 中对应地址设置投影变换矩阵</span></span><br><span class="line">        <span class="comment">// 视口变换数据在 Shader 中的地址，即 WebGLUniformLocation，</span></span><br><span class="line">        <span class="comment">// 同样由着色器编译时确定</span></span><br><span class="line">        gl.uniformMatrix4fv(</span><br><span class="line">            <span class="built_in">this</span>.shader.program.uniforms.uProjectionMatrix,</span><br><span class="line">            <span class="literal">false</span>,</span><br><span class="line">            projectionMatrix</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 向 Shader 中对应地址设置模型-视口变换矩阵</span></span><br><span class="line">        gl.uniformMatrix4fv(</span><br><span class="line">            <span class="built_in">this</span>.shader.program.uniforms.uModelViewMatrix,</span><br><span class="line">            <span class="literal">false</span>,</span><br><span class="line">            modelViewMatrix</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 向 Shader 中对应地址设置摄像机坐标</span></span><br><span class="line">        <span class="comment">// Specific the camera uniforms</span></span><br><span class="line">        gl.uniform3fv(<span class="built_in">this</span>.shader.program.uniforms.uCameraPos, [</span><br><span class="line">            camera.position.x,</span><br><span class="line">            camera.position.y,</span><br><span class="line">            camera.position.z,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> <span class="built_in">this</span>.material.uniforms) &#123;</span><br><span class="line">            <span class="comment">// 遍历材质中包含的其余 uniforms 参数，判断其类型，</span></span><br><span class="line">            <span class="comment">// 并向 Shader 对应位置设置 Uniforms 参数的值</span></span><br><span class="line">            <span class="comment">// 本代码框架支持设置 1 维整数，1 维浮点数，3 维浮点数，4 维浮点数</span></span><br><span class="line">            <span class="comment">// 以及材质数据</span></span><br><span class="line">            <span class="keyword">const</span> uniform = <span class="built_in">this</span>.material.uniforms[k];</span><br><span class="line">            <span class="keyword">if</span> (uniform.type == <span class="string">&quot;matrix4fv&quot;</span>) &#123;</span><br><span class="line">                gl.uniformMatrix4fv(</span><br><span class="line">                    <span class="built_in">this</span>.shader.program.uniforms[k],</span><br><span class="line">                    <span class="literal">false</span>,</span><br><span class="line">                    uniform.value</span><br><span class="line">                );</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uniform.type == <span class="string">&quot;3fv&quot;</span>) &#123;</span><br><span class="line">                gl.uniform3fv(<span class="built_in">this</span>.shader.program.uniforms[k], uniform.value);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uniform.type == <span class="string">&quot;1f&quot;</span>) &#123;</span><br><span class="line">                gl.uniform1f(<span class="built_in">this</span>.shader.program.uniforms[k], uniform.value);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uniform.type == <span class="string">&quot;1i&quot;</span>) &#123;</span><br><span class="line">                gl.uniform1i(<span class="built_in">this</span>.shader.program.uniforms[k], uniform.value);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (uniform.type == <span class="string">&quot;texture&quot;</span>) &#123;</span><br><span class="line">                gl.activeTexture(gl.TEXTURE0);</span><br><span class="line">                gl.bindTexture(gl.TEXTURE_2D, uniform.value.texture);</span><br><span class="line">                gl.uniform1i(<span class="built_in">this</span>.shader.program.uniforms[k], <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 所有参数设置完成后，以 TRIANGLES 使用顶点索引渲染模型</span></span><br><span class="line">            <span class="keyword">const</span> vertexCount = <span class="built_in">this</span>.mesh.count;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">type</span> = gl.UNSIGNED_SHORT;</span><br><span class="line">            <span class="keyword">const</span> offset = <span class="number">0</span>;</span><br><span class="line">            gl.drawElements(gl.TRIANGLES, vertexCount, <span class="keyword">type</span>, offset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Mesh">Mesh</h3>
<p><code>Mesh</code> 是直接存储模型网格体的数据类型。</p>
<h4 id="总体功能-3">总体功能</h4>
<p>要使用 <code>Mesh</code> 来存储一个网格体，需要传入四个参数：<code>verticesAttrib</code>，<code>normalsAttrib</code>，<code>texcoordsAttrib</code> 和 <code>indices</code> 前三个参数的数据类型为 <code>AttribType</code>，其内的 <code>name</code> 字段表明该 <code>Attribute</code> 在 Shader 中的变量名称是什么，使用 <code>Float32Array</code> 类型的 <code>array</code> 来存储数据本身。</p>
<p><code>number[]</code> 类型的 <code>indices</code> 则是网格体的顶点索引。网格体中两个三角形的某两个顶点可能是共用的，如果以三角形的三个顶点的顺序直接存储整个网格体，将导致某些顶点的数据重复存储，导致空间上的浪费，因此一般使用顶点索引来解决这个问题，顶点索引序列的每三个元素表示构成一个三角形的三个顶点在顶点、法线、纹理坐标数组中的索引是哪一个，以额外一次访存的代价实现大幅减少顶点存储数量的性能优化。</p>
<h4 id="Mesh-ts-代码注释"><code>Mesh.ts</code> 代码注释</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明 Attribute 的类型</span></span><br><span class="line"><span class="keyword">interface</span> AttribType &#123;</span><br><span class="line">    <span class="comment">// 表明该 Attribute 在 Shader 中的变量名</span></span><br><span class="line">    name: <span class="built_in">string</span>;</span><br><span class="line">    <span class="comment">// 将要作为 Attribute 的数据本身</span></span><br><span class="line">    array: <span class="built_in">Float32Array</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Mesh</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 顶点索引</span></span><br><span class="line">    indices: <span class="built_in">number</span>[];</span><br><span class="line">    <span class="comment">// 顶点索引的长度</span></span><br><span class="line">    count: <span class="built_in">number</span>;</span><br><span class="line">    <span class="comment">// 是否包含顶点坐标</span></span><br><span class="line">    hasVertices: <span class="built_in">boolean</span>;</span><br><span class="line">    <span class="comment">// 是否包含法线</span></span><br><span class="line">    hasNormals: <span class="built_in">boolean</span>;</span><br><span class="line">    <span class="comment">// 是否包含纹理坐标</span></span><br><span class="line">    hasTexcoords: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 顶点坐标数据序列</span></span><br><span class="line">    vertices: <span class="built_in">Float32Array</span> = <span class="keyword">new</span> <span class="built_in">Float32Array</span>();</span><br><span class="line">    <span class="comment">// 顶点坐标数据在 Shader 中的变量名</span></span><br><span class="line">    verticesName: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 法线数据序列</span></span><br><span class="line">    normals: <span class="built_in">Float32Array</span> = <span class="keyword">new</span> <span class="built_in">Float32Array</span>();</span><br><span class="line">    <span class="comment">// 法线数据在 Shader 中的变量名</span></span><br><span class="line">    normalsName: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 纹理坐标数据序列</span></span><br><span class="line">    texcoords: <span class="built_in">Float32Array</span> = <span class="keyword">new</span> <span class="built_in">Float32Array</span>();</span><br><span class="line">    <span class="comment">// 纹理坐标数据在 Shader 中的变量名</span></span><br><span class="line">    texcoordsName: <span class="built_in">string</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        verticesAttrib: AttribType,</span></span><br><span class="line"><span class="params">        normalsAttrib: AttribType | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">        texcoordsAttrib: AttribType | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">        indices: <span class="built_in">number</span>[]</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        <span class="comment">// 初始化顶点索引数据</span></span><br><span class="line">        <span class="built_in">this</span>.indices = indices;</span><br><span class="line">        <span class="built_in">this</span>.count = indices.length;</span><br><span class="line">        <span class="comment">// 默认没有顶点坐标、法线、纹理坐标数据</span></span><br><span class="line">        <span class="built_in">this</span>.hasVertices = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.hasNormals = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.hasTexcoords = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">let</span> extraAttribs = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (verticesAttrib != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果有顶点坐标数据，则赋值</span></span><br><span class="line">            <span class="built_in">this</span>.hasVertices = <span class="literal">true</span>;</span><br><span class="line">            <span class="built_in">this</span>.vertices = verticesAttrib.array;</span><br><span class="line">            <span class="built_in">this</span>.verticesName = verticesAttrib.name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (normalsAttrib != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果有法线数据，则赋值</span></span><br><span class="line">            <span class="built_in">this</span>.hasNormals = <span class="literal">true</span>;</span><br><span class="line">            <span class="built_in">this</span>.normals = normalsAttrib.array;</span><br><span class="line">            <span class="built_in">this</span>.normalsName = normalsAttrib.name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (texcoordsAttrib != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果有纹理坐标数据，则赋值</span></span><br><span class="line">            <span class="built_in">this</span>.hasTexcoords = <span class="literal">true</span>;</span><br><span class="line">            <span class="built_in">this</span>.texcoords = texcoordsAttrib.array;</span><br><span class="line">            <span class="built_in">this</span>.texcoordsName = texcoordsAttrib.name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">cube</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 预先定义一个边长为 1 的立方体 Mesh，方便后续使用</span></span><br><span class="line">        <span class="keyword">const</span> positions = [</span><br><span class="line">            <span class="comment">// Front face</span></span><br><span class="line">            -<span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">            <span class="comment">// Back face</span></span><br><span class="line">            -<span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>,</span><br><span class="line">            <span class="comment">// Top face</span></span><br><span class="line">            -<span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>,</span><br><span class="line">            <span class="comment">// Bottom face</span></span><br><span class="line">            -<span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">            <span class="comment">// Right face</span></span><br><span class="line">            <span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>,</span><br><span class="line">            <span class="comment">// Left face</span></span><br><span class="line">            -<span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>, <span class="number">1.0</span>, -<span class="number">1.0</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">const</span> indices = [</span><br><span class="line">            <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="comment">// front</span></span><br><span class="line">            <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="comment">// back </span></span><br><span class="line">            <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="comment">// top</span></span><br><span class="line">            <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="comment">// bottom</span></span><br><span class="line">            <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">16</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="comment">// right</span></span><br><span class="line">            <span class="number">20</span>, <span class="number">21</span>, <span class="number">22</span>, <span class="number">20</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="comment">// left</span></span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Mesh(</span><br><span class="line">            &#123; <span class="attr">name</span>: <span class="string">&quot;aVertexPosition&quot;</span>, <span class="attr">array</span>: <span class="keyword">new</span> <span class="built_in">Float32Array</span>(positions) &#125;,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            <span class="literal">null</span>,</span><br><span class="line">            indices</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Material">Material</h3>
<p>材质 <code>Material</code> 的概念是本项目需要理解的重难点内容。</p>
<p>在光线追踪渲染中，一种物体表面的材质定义了光线到达该表面时反射的方向与起始点，体现但不仅限于 BRDF 定义的双向反射分布情况，纹理则决定了某种颜色的光在经过该表面反射后的新光线是什么颜色的；而在光栅化渲染中，材质定义了为该表面某一个像素进行着色的过程中所需要的各类参数，以及如何使用这些参数和场景中的各类信息来计算该像素颜色的值。</p>
<h4 id="总体功能-4">总体功能</h4>
<p>GAMES 202 代码框架的 <code>Material</code> 类属于上述光栅化渲染的材质类，其内部的 <code>flatten_uniforms: string[]</code> 变量存储了渲染该材质的着色器所需的所有 <code>Uniforms</code> 变量的名称；<code>flatten_attribs: string[]</code> 和 <code>attribs: string</code> 则存储了所有 <code>Attributes</code> 类型的顶点数据的名称；<code>uniforms</code> 则以 <code>Uniforms</code> 类型变量的名称为 <code>key</code>，以具体的数据类型和数据本身构成的对象为 <code>value</code>，存储渲染该材质所需的各类数值、纹理等数据参数。</p>
<h4 id="Material-ts-代码注释"><code>Material.ts</code> 代码注释</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Shader &#125; <span class="keyword">from</span> <span class="string">&quot;../shaders/Shader&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; vec3, mat4 &#125; <span class="keyword">from</span> <span class="string">&#x27;gl-matrix&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Texture &#125; <span class="keyword">from</span> <span class="string">&quot;../textures/Texture&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 Uniforms 的复合类型，通过 type 来判断 uniform 的类型，并给出正确类型的值</span></span><br><span class="line"><span class="keyword">type</span> Uniform =</span><br><span class="line">    | &#123;</span><br><span class="line">          <span class="keyword">type</span>: <span class="string">&quot;texture&quot;</span>;</span><br><span class="line">          value: Texture;</span><br><span class="line">      &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">          <span class="keyword">type</span>: <span class="string">&quot;1i&quot;</span>;</span><br><span class="line">          value: <span class="built_in">number</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">          <span class="keyword">type</span>: <span class="string">&quot;1f&quot;</span>;</span><br><span class="line">          value: <span class="built_in">number</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">          <span class="keyword">type</span>: <span class="string">&quot;3fv&quot;</span>;</span><br><span class="line">          value: vec3;</span><br><span class="line">      &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">          <span class="keyword">type</span>: <span class="string">&quot;uKd&quot;</span>;</span><br><span class="line">          value: <span class="built_in">number</span>[];</span><br><span class="line">      &#125;</span><br><span class="line">    | &#123;</span><br><span class="line">          <span class="keyword">type</span>: <span class="string">&quot;matrix4fv&quot;</span>;</span><br><span class="line">          value: mat4;</span><br><span class="line">      &#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Material</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存所有 uniform 变量的名称</span></span><br><span class="line">    <span class="keyword">private</span> flatten_uniforms;</span><br><span class="line">    <span class="comment">// 保存所有 attribute 变量的名称</span></span><br><span class="line">    <span class="keyword">private</span> flatten_attribs;</span><br><span class="line">    <span class="comment">// vertex shader 的源码</span></span><br><span class="line">    <span class="keyword">private</span> vsSrc;</span><br><span class="line">    <span class="comment">// fragment shader 的源码</span></span><br><span class="line">    <span class="keyword">private</span> fsSrc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// uniform 变量与值的对应关系</span></span><br><span class="line">    uniforms;</span><br><span class="line">    <span class="comment">// 保存所有 attribute 变量的名称</span></span><br><span class="line">    attribs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Uniforms is a map, attribs is a Array</span></span><br><span class="line">    <span class="title">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        uniforms: &#123;</span></span><br><span class="line"><span class="params">            [index: <span class="built_in">string</span>]: Uniform;</span></span><br><span class="line"><span class="params">        &#125;,</span></span><br><span class="line"><span class="params">        attribs: <span class="built_in">string</span>[],</span></span><br><span class="line"><span class="params">        vsSrc: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">        fsSrc: <span class="built_in">string</span></span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        <span class="comment">// 初始化 uniforms, attribs 与着色器源码</span></span><br><span class="line">        <span class="built_in">this</span>.uniforms = uniforms;</span><br><span class="line">        <span class="built_in">this</span>.attribs = attribs;</span><br><span class="line">        <span class="built_in">this</span>.vsSrc = vsSrc;</span><br><span class="line">        <span class="built_in">this</span>.fsSrc = fsSrc;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 所有材质着色器都默认具有</span></span><br><span class="line">        <span class="comment">// 位移-视口变换矩阵，投影变换矩阵</span></span><br><span class="line">        <span class="comment">// 摄像机位置，光源位置参数</span></span><br><span class="line">        <span class="built_in">this</span>.flatten_uniforms = [</span><br><span class="line">            <span class="string">&quot;uModelViewMatrix&quot;</span>,</span><br><span class="line">            <span class="string">&quot;uProjectionMatrix&quot;</span>,</span><br><span class="line">            <span class="string">&quot;uCameraPos&quot;</span>,</span><br><span class="line">            <span class="string">&quot;uLightPos&quot;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="comment">// 将其他 uniforms 的参数名添加到 flatten_uniforms 中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">in</span> uniforms) &#123;</span><br><span class="line">            <span class="built_in">this</span>.flatten_uniforms.push(k);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 保持 flatten_attribs 和 attribs 一致</span></span><br><span class="line">        <span class="built_in">this</span>.flatten_attribs = attribs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">setMeshAttribs</span>(<span class="params">extraAttribs: <span class="built_in">string</span>[]</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 添加额外的 Attribute 变量名</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; extraAttribs.length; i++) &#123;</span><br><span class="line">            <span class="built_in">this</span>.flatten_attribs.push(extraAttribs[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">compile</span>(<span class="params">gl: WebGLRenderingContext</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 从源码编译 Shader，返回着色器程序和各类 Attribute，Uniform 变量名与地址的对应关系</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Shader(gl, <span class="built_in">this</span>.vsSrc, <span class="built_in">this</span>.fsSrc, &#123;</span><br><span class="line">            uniforms: <span class="built_in">this</span>.flatten_uniforms,</span><br><span class="line">            attribs: <span class="built_in">this</span>.flatten_attribs,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Shader">Shader</h3>
<p>本节是本项目中最接近底层的内容，我们将讲述如何通过传入源码来获得一个由 WebGL 编译好的着色器子程序的，理解这一切的成本仅仅是了解 WebGL 的基本使用方法。</p>
<h4 id="总体功能-5">总体功能</h4>
<p>GAMES 202 代码框架中 <code>Shader</code> 类型的基本任务是从 <code>Material</code> 端调用 <code>Shader</code> 的构造函数，通过传入 Vertex Shader 和 Fragment Shader 的源码来编译并链接形成完整的着色器程序。</p>
<p>此外，由于在着色器程序之上设置 <code>Attributes</code> 和 <code>Uniforms</code> 值的操作是非常频繁的，而一般要设置它们的值，一般要先从 WebGL 上下文中获取它们的地址，再将值设置到对应的地址上。为了避免反复获取变量地址的过程带来的麻烦，<code>Shader</code> 类还提供 <code>addShaderLocations</code> 的功能，通过传入一组 <code>Attributes</code> 和 <code>Uniforms</code> 的名称，指示 <code>Shader</code> 类将这些变量名称对应的地址（索引、位置）保存到 <code>ProgramInfo</code> 类的 <code>uniforms</code> 和 <code>attribs</code> 字段中，<code>ProgramInfo</code> 还通过 <code>glShaderProgram</code> 字段保存编译好的着色器程序的引用。</p>
<h4 id="Shader-ts-代码注释"><code>Shader.ts</code> 代码注释</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一组着色器 attributes 和 uniforms 变量名字的记录</span></span><br><span class="line"><span class="comment">// 用于指示从编译好的着色器中查找对变量对应的地址</span></span><br><span class="line"><span class="keyword">interface</span> ShaderLocations &#123;</span><br><span class="line">    uniforms: <span class="built_in">string</span>[] | <span class="literal">null</span>;</span><br><span class="line">    attribs: <span class="built_in">string</span>[] | <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 存储着色器信息的一组变量</span></span><br><span class="line"><span class="keyword">interface</span> ProgramInfo &#123;</span><br><span class="line">    <span class="comment">// 编译好的着色器程序的引用</span></span><br><span class="line">    glShaderProgram: WebGLProgram;</span><br><span class="line">    <span class="comment">// key 表示着色器程序中某个 uniform 变量的名字</span></span><br><span class="line">    <span class="comment">// value 表示该名字对应的地址（位置）</span></span><br><span class="line">    uniforms: &#123; [index: <span class="built_in">string</span>]: WebGLUniformLocation &#125;;</span><br><span class="line">    <span class="comment">// key 表示着色器程序中某个 attribute 变量的名字</span></span><br><span class="line">    <span class="comment">// value 表示该名字对应的索引</span></span><br><span class="line">    attribs: &#123; [index: <span class="built_in">string</span>]: <span class="built_in">number</span> &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Shader</span> </span>&#123;</span><br><span class="line">    gl: WebGLRenderingContext;</span><br><span class="line">    program: ProgramInfo;</span><br><span class="line"></span><br><span class="line">    <span class="title">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        gl: WebGLRenderingContext,</span></span><br><span class="line"><span class="params">        vsSrc: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">        fsSrc: <span class="built_in">string</span>,</span></span><br><span class="line"><span class="params">        shaderLocations: ShaderLocations</span></span><br><span class="line"><span class="params">    </span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.gl = gl;</span><br><span class="line">        <span class="comment">// 从传入的源码中分别编译顶点着色器和片元着色器</span></span><br><span class="line">        <span class="keyword">const</span> vs = <span class="built_in">this</span>.compileShader(vsSrc, gl.VERTEX_SHADER);</span><br><span class="line">        <span class="keyword">const</span> fs = <span class="built_in">this</span>.compileShader(fsSrc, gl.FRAGMENT_SHADER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将编译好的着色器进行链接操作，</span></span><br><span class="line">        <span class="comment">// 并根据 shaderLocations 中的变量名查找出这些变量名在着色器程序中的位置</span></span><br><span class="line">        <span class="built_in">this</span>.program = <span class="built_in">this</span>.addShaderLocations(</span><br><span class="line">            &#123;</span><br><span class="line">                glShaderProgram: <span class="built_in">this</span>.linkShader(vs, fs),</span><br><span class="line">                uniforms: &#123;&#125;,</span><br><span class="line">                attribs: &#123;&#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">            shaderLocations</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过提供的源码与类型编译着色器</span></span><br><span class="line">    <span class="function"><span class="title">compileShader</span>(<span class="params">shaderSource: <span class="built_in">string</span>, shaderType: <span class="built_in">number</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> gl = <span class="built_in">this</span>.gl;</span><br><span class="line">        <span class="comment">// 创建一个 WebGL 着色器实例</span></span><br><span class="line">        <span class="keyword">var</span> shader = gl.createShader(shaderType);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shader === <span class="literal">null</span>) <span class="keyword">throw</span> <span class="string">&quot;shader creator error&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置着色器源码与类型</span></span><br><span class="line">        gl.shaderSource(shader, shaderSource);</span><br><span class="line">        <span class="comment">// 编译着色器</span></span><br><span class="line">        gl.compileShader(shader);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) &#123;</span><br><span class="line">            <span class="comment">// 编译出错时打印错误信息</span></span><br><span class="line">            <span class="built_in">console</span>.error(shaderSource);</span><br><span class="line">            <span class="built_in">console</span>.error(</span><br><span class="line">                <span class="string">&quot;shader compiler error:\n&quot;</span> + gl.getShaderInfoLog(shader)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过提供的顶点和片元着色器来链接并返回一个完整的着色器程序</span></span><br><span class="line">    <span class="function"><span class="title">linkShader</span>(<span class="params">vs: WebGLShader, fs: WebGLShader</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> gl = <span class="built_in">this</span>.gl;</span><br><span class="line">        <span class="comment">// 创建一个 WebGL 着色器程序实例</span></span><br><span class="line">        <span class="keyword">var</span> prog = gl.createProgram();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!prog) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;shader creator error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加顶点着色器</span></span><br><span class="line">        gl.attachShader(prog, vs);</span><br><span class="line">        <span class="comment">// 添加片元着色器</span></span><br><span class="line">        gl.attachShader(prog, fs);</span><br><span class="line">        <span class="comment">// 链接两个着色器</span></span><br><span class="line">        gl.linkProgram(prog);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!gl.getProgramParameter(prog, gl.LINK_STATUS)) &#123;</span><br><span class="line">            <span class="comment">// 链接出错时打印错误信息</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="string">`shader linker error:\n <span class="subst">$&#123;gl.getProgramInfoLog(prog)&#125;</span>`</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> prog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    addShaderLocations(</span><br><span class="line">        result: ProgramInfo,</span><br><span class="line">        shaderLocations: ShaderLocations | <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">const</span> gl = <span class="built_in">this</span>.gl;</span><br><span class="line">        <span class="comment">// 初始化存储 uniform, attribute 名称与地址的对象的索引</span></span><br><span class="line">        result.uniforms = &#123;&#125;;</span><br><span class="line">        result.attribs = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            shaderLocations &amp;&amp;</span><br><span class="line">            shaderLocations.uniforms &amp;&amp;</span><br><span class="line">            shaderLocations.uniforms.length</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shaderLocations.uniforms.length; ++i) &#123;</span><br><span class="line">                <span class="comment">// 遍历 shaderLocations 中所有的 uniform，</span></span><br><span class="line">                <span class="comment">// 以其名称为 key，对应的地址（位置）为 value，存储这两组变量的对应关系</span></span><br><span class="line">                result.uniforms = <span class="built_in">Object</span>.assign(result.uniforms, &#123;</span><br><span class="line">                    [shaderLocations.uniforms[i]]: gl.getUniformLocation(</span><br><span class="line">                        result.glShaderProgram,</span><br><span class="line">                        shaderLocations.uniforms[i]</span><br><span class="line">                    ),</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">//console.log(gl.getUniformLocation(result.glShaderProgram, &#x27;uKd&#x27;));</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            shaderLocations &amp;&amp;</span><br><span class="line">            shaderLocations.attribs &amp;&amp;</span><br><span class="line">            shaderLocations.attribs.length</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shaderLocations.attribs.length; ++i) &#123;</span><br><span class="line">                <span class="comment">// 遍历 shaderLocations 中所有的 attribute</span></span><br><span class="line">                <span class="comment">// 以其名称为 key，对应的索引为 value，存储这两组变量的对应关系</span></span><br><span class="line">                result.attribs = <span class="built_in">Object</span>.assign(result.attribs, &#123;</span><br><span class="line">                    [shaderLocations.attribs[i]]: gl.getAttribLocation(</span><br><span class="line">                        result.glShaderProgram,</span><br><span class="line">                        shaderLocations.attribs[i]</span><br><span class="line">                    ),</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Texture">Texture</h3>
<p>纹理是图形渲染过程中所需的重要数据，大部分时候它是每个像素点着色的重要参数，另一些时候它用于保存物体的法线、表明凹凸性等信息</p>
<h4 id="总体功能-6">总体功能</h4>
<p>在 Web 应用中，存储图片数据最主要的容器是 <code>HTMLImageElement</code>，WebGL 从 JavaScript 端获取 <code>WebGLTexture</code> 数据同样依赖 <code>HTMLImageElement</code>。GAMES 202 作业代码框架提供了 <code>Texture</code> 类来通过传入 <code>WebGLRenderingContext</code> 和 <code>HTMLImageElement</code> 来构造 <code>WebGLTexture</code>、设置一系列参数、拷贝纹理数据。</p>
<h4 id="Texture-ts-代码注释"><code>Texture.ts</code> 代码注释</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Texture</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 存储 WebGL 可直接访问的图片纹理数据</span></span><br><span class="line">    texture: WebGLTexture;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">gl: WebGLRenderingContext, img: HTMLImageElement</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建 WebGLTexture 实例</span></span><br><span class="line">        <span class="keyword">const</span> texture = gl.createTexture();</span><br><span class="line">        <span class="keyword">if</span> (texture === <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;failed to create texture&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.texture = texture;</span><br><span class="line">        <span class="comment">// 将创建出的 WebGLTexture 实例与 gl.TEXTURE_2D 绑定</span></span><br><span class="line">        <span class="comment">// 之后用 gl.TEXTURE_2D 这个枚举来操作纹理</span></span><br><span class="line">        <span class="comment">// 都相当于操作当前绑定的 WebGLTexture 实例</span></span><br><span class="line">        gl.bindTexture(gl.TEXTURE_2D, <span class="built_in">this</span>.texture);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为当前绑定的 WebGLTexture 设置一系列参数</span></span><br><span class="line">        <span class="comment">// Because images have to be download over the internet</span></span><br><span class="line">        <span class="comment">// they might take a moment until they are ready.</span></span><br><span class="line">        <span class="comment">// Until then put a single pixel in the texture so we can</span></span><br><span class="line">        <span class="comment">// use it immediately. When the image has finished downloading</span></span><br><span class="line">        <span class="comment">// we&#x27;ll update the texture with the contents of the image.</span></span><br><span class="line">        <span class="keyword">const</span> level = <span class="number">0</span>;    <span class="comment">// LOD 级别为 0，即不生成 mipmap</span></span><br><span class="line">        <span class="keyword">const</span> internalFormat = gl.RGBA; <span class="comment">// 图片是 RGBA 图像</span></span><br><span class="line">        <span class="keyword">const</span> width = <span class="number">1</span>;    <span class="comment">// 宽设为 1</span></span><br><span class="line">        <span class="keyword">const</span> height = <span class="number">1</span>;   <span class="comment">// 高设为 1</span></span><br><span class="line">        <span class="keyword">const</span> border = <span class="number">0</span>;   <span class="comment">// 边界必须设为 0</span></span><br><span class="line">        <span class="keyword">const</span> srcFormat = gl.RGBA;  <span class="comment">// 像素格式为 RGBA</span></span><br><span class="line">        <span class="keyword">const</span> srcType = gl.UNSIGNED_BYTE;   <span class="comment">// 每个像素的数据类型是 unsigned byte</span></span><br><span class="line">        <span class="keyword">const</span> pixel = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">255</span>]); <span class="comment">// opaque blue</span></span><br><span class="line">        gl.texImage2D(</span><br><span class="line">            gl.TEXTURE_2D,</span><br><span class="line">            level,</span><br><span class="line">            internalFormat,</span><br><span class="line">            width,</span><br><span class="line">            height,</span><br><span class="line">            border,</span><br><span class="line">            srcFormat,</span><br><span class="line">            srcType,</span><br><span class="line">            pixel</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        gl.bindTexture(gl.TEXTURE_2D, <span class="built_in">this</span>.texture);</span><br><span class="line">        <span class="comment">// 将图像做上下翻转预处理</span></span><br><span class="line">        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, <span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 将 HTMLImageElement 图像数据拷贝到 WebGLTexture 纹理</span></span><br><span class="line">        gl.texImage2D(</span><br><span class="line">            gl.TEXTURE_2D,</span><br><span class="line">            level,</span><br><span class="line">            internalFormat,</span><br><span class="line">            srcFormat,</span><br><span class="line">            srcType,</span><br><span class="line">            img</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果图像的长宽都是 2 的幂</span></span><br><span class="line">        <span class="comment">// WebGL1 has different requirements for power of 2 images</span></span><br><span class="line">        <span class="comment">// vs non power of 2 images so check if the image is a</span></span><br><span class="line">        <span class="comment">// power of 2 in both dimensions.</span></span><br><span class="line">        <span class="keyword">if</span> (isPowerOf2(img.width) &amp;&amp; isPowerOf2(img.height)) &#123;</span><br><span class="line">            <span class="comment">// 则为其生成 mipmap</span></span><br><span class="line">            <span class="comment">// Yes, it&#x27;s a power of 2. Generate mips.</span></span><br><span class="line">            gl.generateMipmap(gl.TEXTURE_2D);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 否则将其水平和垂直方向设置为重复纹理</span></span><br><span class="line">            <span class="comment">// 图像缩放过程使用线性插值</span></span><br><span class="line">            <span class="comment">// 从而实现绘制非 2 次幂边长的图像</span></span><br><span class="line">            <span class="comment">// No, it&#x27;s not a power of 2. Turn of mips and set</span></span><br><span class="line">            <span class="comment">// wrapping to clamp to edge</span></span><br><span class="line">            <span class="comment">//gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);</span></span><br><span class="line">            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);</span><br><span class="line">            <span class="comment">//gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);</span></span><br><span class="line">            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);</span><br><span class="line">            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);</span><br><span class="line">            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);</span><br><span class="line">        &#125;</span><br><span class="line">        gl.bindTexture(gl.TEXTURE_2D, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPowerOf2</span>(<span class="params">value: <span class="built_in">number</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 要判断一个数是不是 2 的幂次</span></span><br><span class="line">    <span class="comment">// 相当于判断它的二进制表示下，是否除了最高位是 1 其他位都是 0，</span></span><br><span class="line">    <span class="comment">// 可以用如下规律来判断：</span></span><br><span class="line">    <span class="comment">// 一个数 x 是 2 的幂次，当且仅当 x - 1 除了最高位是 0，其他低位都是 1</span></span><br><span class="line">    <span class="keyword">return</span> (value &amp; (value - <span class="number">1</span>)) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Loader">Loader</h3>
<p>作为一个渲染器，从外部加载模型、着色器源码资源是必要的功能之一。</p>
<h4 id="总体功能-7">总体功能</h4>
<p>GAMES 202 代码框架封装了两种加载器，其中一种用于从本地加载 <code>.mtl</code> 和 <code>.obj</code> 格式的模型资源；另一种用于加载着色器源码。由于我们已经使用了 Vite 来在编译器打包外部着色器源码资源，因此后一种加载器的原理将不过多赘述。</p>
<p>对于 <code>loadOBJ</code> 函数，这是一个使用 <code>THREE.js</code> 的 <code>MTLLoader</code> 和 <code>OBJLoader</code> 进行封装的函数。它首先创建了一个 <code>THREE.LoadingManager</code> 来便于我们观察加载的进度；接着创建一个 <code>MTLLoader</code> 用来加载 <code>.mtl</code> 格式的材质库文件，并调用 <code>load</code> 函数、传入加载完成后的回调函数，<code>MTLLoader</code> 在加载完成后调用回调函数、传入加载好的材质（纹理）相关数据；传入 <code>MTLLoader</code> 的回调函数里创建了一个 <code>OBJLoader</code> 用于加载 <code>.obj</code> 模型的顶点、法线、纹理坐标等信息，该加载器同样具有加载完成的回调函数，该回调函数中传入了加载完成的模型实例，包含顶点、纹理等数据，用这些数据创建 <code>Mesh</code>，<code>Texture</code>，<code>Material</code> 等数据实例，最终创建出一个 <code>MeshRender</code> 并添加到 <code>WebGLRenderer</code> 中，从而完成了从外部静态资源中加载模型数据并添加到场景中的功能。</p>
<h4 id="loadOBJ-ts"><code>loadOBJ.ts</code></h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">&quot;three&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MTLLoader &#125; <span class="keyword">from</span> <span class="string">&quot;three/examples/jsm/loaders/MTLLoader&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; OBJLoader &#125; <span class="keyword">from</span> <span class="string">&quot;three/examples/jsm/loaders/OBJLoader&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Mesh &#125; <span class="keyword">from</span> <span class="string">&quot;../objects/Mesh&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Material &#125; <span class="keyword">from</span> <span class="string">&quot;../materials/Material&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> VertexShader <span class="keyword">from</span> <span class="string">&quot;../shaders/InternalShader/VertexShader.glsl?raw&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> FragmentShader <span class="keyword">from</span> <span class="string">&quot;../shaders/InternalShader/FragmentShader.glsl?raw&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; MeshRender &#125; <span class="keyword">from</span> <span class="string">&quot;../renderers/MeshRender&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Texture &#125; <span class="keyword">from</span> <span class="string">&quot;../textures/Texture&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; WebGLRenderer &#125; <span class="keyword">from</span> <span class="string">&quot;../renderers/WebGLRenderer&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BufferAttribute &#125; <span class="keyword">from</span> <span class="string">&quot;three&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">loadOBJ</span>(<span class="params">renderer: WebGLRenderer, path: <span class="built_in">string</span>, name: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个加载管理器，可以添加到 MTLLoader 和 OBJLoader 中以追踪加载进度</span></span><br><span class="line">    <span class="keyword">const</span> manager = <span class="keyword">new</span> THREE.LoadingManager();</span><br><span class="line">    manager.onProgress = <span class="function"><span class="keyword">function</span> (<span class="params">item, loaded, total</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(item, loaded, total);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义打印 OBJLoader 自身加载进度的回调函数 </span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onProgress</span>(<span class="params">xhr: ProgressEvent&lt;EventTarget&gt;</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (xhr.lengthComputable) &#123;</span><br><span class="line">            <span class="keyword">const</span> percentComplete = (xhr.loaded / xhr.total) * <span class="number">100</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(</span><br><span class="line">                <span class="comment">// &quot;model &quot; + Math.round(percentComplete, 2) + &quot;% downloaded&quot;</span></span><br><span class="line">                <span class="string">&quot;model &quot;</span> + <span class="built_in">Math</span>.round(percentComplete) + <span class="string">&quot;% downloaded&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params"></span>) </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新建一个 MTLLoader，指定其加载外部资源的路径，并设置加载完成的回调函数</span></span><br><span class="line">    <span class="keyword">new</span> MTLLoader(manager)</span><br><span class="line">        .setPath(path)</span><br><span class="line">        .load(name + <span class="string">&quot;.mtl&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">materials</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 这里被执行时表明 .mtl 文件已经加载完成，传入的是将要加载的材质纹理数据</span></span><br><span class="line">            materials.preload();</span><br><span class="line">            <span class="comment">// 新建一个 OBJLoader，为其设置材质和资源路径，使用类似的方法来设置加载完成的回调函数</span></span><br><span class="line">            <span class="keyword">new</span> OBJLoader(manager)</span><br><span class="line">                .setMaterials(materials)</span><br><span class="line">                .setPath(path)</span><br><span class="line">                .load(</span><br><span class="line">                    name + <span class="string">&quot;.obj&quot;</span>,</span><br><span class="line">                    <span class="function"><span class="keyword">function</span> (<span class="params"><span class="built_in">object</span></span>) </span>&#123;</span><br><span class="line">                        <span class="comment">// 可能会加载到多个模型，因此需要遍历每一个模型来创建 MeshRender </span></span><br><span class="line">                        <span class="comment">// 并添加到 WebGLRenderer</span></span><br><span class="line">                        <span class="built_in">object</span>.traverse(<span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">                            <span class="keyword">const</span> child = event;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 判断每个 event 是不是 THREE.Mesh</span></span><br><span class="line">                            <span class="keyword">if</span> (child <span class="keyword">instanceof</span> THREE.Mesh &amp;&amp; child.isMesh) &#123;</span><br><span class="line">                                <span class="comment">// 如果是，则取出它的几何数据和材质数据</span></span><br><span class="line">                                <span class="keyword">let</span> geo = child.geometry;</span><br><span class="line">                                <span class="keyword">let</span> mat = <span class="keyword">new</span> THREE.MeshPhongMaterial;</span><br><span class="line">                                <span class="comment">// 不论只有一个材质还是多个材质，</span></span><br><span class="line">                                <span class="comment">// 都检查并转换为 MeshPhongMaterial</span></span><br><span class="line">                                <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(child.material)) &#123;</span><br><span class="line">                                    <span class="keyword">let</span> firstMaterial = child</span><br><span class="line">                                        .material[<span class="number">0</span>];</span><br><span class="line">                                    <span class="keyword">if</span> (firstMaterial <span class="keyword">instanceof</span> THREE.MeshPhongMaterial) &#123;</span><br><span class="line">                                        mat = firstMaterial;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">else</span> <span class="keyword">if</span> (child.material <span class="keyword">instanceof</span> THREE.MeshPhongMaterial) &#123;</span><br><span class="line">                                    mat = child.material;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 从几何数据中取出顶点索引</span></span><br><span class="line">                                <span class="keyword">var</span> indices = <span class="built_in">Array</span>.from(</span><br><span class="line">                                    &#123; <span class="attr">length</span>: geo.attributes.position.count &#125;,</span><br><span class="line">                                    (v, k) =&gt; k</span><br><span class="line">                                );</span><br><span class="line">                                <span class="comment">// 如果存在顶点坐标、法线或纹理坐标数据，则一并取出</span></span><br><span class="line">                                <span class="comment">// 同时创建一个 Mesh 实例保存这些数据</span></span><br><span class="line">                                <span class="keyword">let</span> mesh = <span class="keyword">new</span> Mesh(</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        name: <span class="string">&quot;aVertexPosition&quot;</span>,</span><br><span class="line">                                        array: <span class="keyword">new</span> <span class="built_in">Float32Array</span>(geo.attributes.position <span class="keyword">instanceof</span> BufferAttribute ? geo.attributes.position.array : []),</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        name: <span class="string">&quot;aNormalPosition&quot;</span>,</span><br><span class="line">                                        array: <span class="keyword">new</span> <span class="built_in">Float32Array</span>(geo.attributes.normal <span class="keyword">instanceof</span> BufferAttribute ? geo.attributes.normal.array : []),</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        name: <span class="string">&quot;aTextureCoord&quot;</span>,</span><br><span class="line">                                        array: <span class="keyword">new</span> <span class="built_in">Float32Array</span>(geo.attributes.uv <span class="keyword">instanceof</span> BufferAttribute ? geo.attributes.uv.array : []),</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    indices</span><br><span class="line">                                );</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 如果模型材质中包含纹理数据，则创建一个 Texture 实例</span></span><br><span class="line">                                <span class="keyword">let</span> colorMap: Texture | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line">                                <span class="keyword">if</span> (mat.map != <span class="literal">null</span>)</span><br><span class="line">                                    colorMap = <span class="keyword">new</span> Texture(</span><br><span class="line">                                        renderer.gl,</span><br><span class="line">                                        mat.map.image</span><br><span class="line">                                    );</span><br><span class="line">                                <span class="comment">// MARK: You can change the myMaterial object to your own Material instance</span></span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 若存在纹理数据，在新创建的 Material 实例中添加该纹理数据</span></span><br><span class="line">                                <span class="comment">// 否则不添加任何纹理参数</span></span><br><span class="line">                                <span class="keyword">let</span> textureSample = <span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">let</span> myMaterial;</span><br><span class="line">                                <span class="keyword">if</span> (colorMap != <span class="literal">null</span>) &#123;</span><br><span class="line">                                    textureSample = <span class="number">1</span>;</span><br><span class="line">                                    myMaterial = <span class="keyword">new</span> Material(</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="comment">// 名为 uSampler 的材质参数</span></span><br><span class="line">                                            <span class="comment">// 类型为 texture，值为 colorMap</span></span><br><span class="line">                                            uSampler: &#123;</span><br><span class="line">                                                <span class="keyword">type</span>: <span class="string">&quot;texture&quot;</span>,</span><br><span class="line">                                                value: colorMap,</span><br><span class="line">                                            &#125;,</span><br><span class="line">                                            uTextureSample: &#123;</span><br><span class="line">                                                <span class="keyword">type</span>: <span class="string">&quot;1i&quot;</span>,</span><br><span class="line">                                                value: textureSample,</span><br><span class="line">                                            &#125;,</span><br><span class="line">                                            uKd: &#123;</span><br><span class="line">                                                <span class="keyword">type</span>: <span class="string">&quot;3fv&quot;</span>,</span><br><span class="line">                                                value: <span class="keyword">new</span> <span class="built_in">Float32Array</span>(mat.color.toArray() || []),</span><br><span class="line">                                            &#125;,</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        [],</span><br><span class="line">                                        VertexShader,</span><br><span class="line">                                        FragmentShader</span><br><span class="line">                                    );</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    myMaterial = <span class="keyword">new</span> Material(</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            uTextureSample: &#123;</span><br><span class="line">                                                <span class="keyword">type</span>: <span class="string">&quot;1i&quot;</span>,</span><br><span class="line">                                                value: textureSample,</span><br><span class="line">                                            &#125;,</span><br><span class="line">                                            uKd: &#123;</span><br><span class="line">                                                <span class="keyword">type</span>: <span class="string">&quot;3fv&quot;</span>,</span><br><span class="line">                                                value: <span class="keyword">new</span> <span class="built_in">Float32Array</span>(mat.color.toArray() || []),</span><br><span class="line">                                            &#125;,</span><br><span class="line">                                        &#125;,</span><br><span class="line">                                        [],</span><br><span class="line">                                        VertexShader,</span><br><span class="line">                                        FragmentShader</span><br><span class="line">                                    );</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 从模型资源中取出的各类数据准备好之后</span></span><br><span class="line">                                <span class="comment">// 用这些数据创建一个 MeshRender 实例</span></span><br><span class="line">                                <span class="keyword">let</span> meshRender = <span class="keyword">new</span> MeshRender(</span><br><span class="line">                                    renderer.gl,</span><br><span class="line">                                    mesh,</span><br><span class="line">                                    myMaterial</span><br><span class="line">                                );</span><br><span class="line">                                <span class="comment">// 并将该 MeshRenderer 添加到 WebGLRenderer 中</span></span><br><span class="line">                                renderer.addMesh(meshRender);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    onProgress,</span><br><span class="line">                    onError</span><br><span class="line">                );</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="loadShader-ts-代码注释"><code>loadShader.ts</code> 代码注释</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> THREE <span class="keyword">from</span> <span class="string">&#x27;three&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">loadShaderFile</span>(<span class="params">filename: <span class="built_in">string</span></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用一个将由 Three.js 提供的加载操作放在一个 Promise 中进行，</span></span><br><span class="line">    <span class="comment">// 当加载完成后调用 resovle 表示加载完成</span></span><br><span class="line">    <span class="comment">// 外部使用时可以在 async 函数中使用 await 等待 resolve 执行完成</span></span><br><span class="line">    <span class="comment">// 也可以直接对 Promise 调用 then 方法获取该 Promise 中调用 resolve 所传入的参数</span></span><br><span class="line">    <span class="comment">// 实现异步加载 Shader 源码文件</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> loader = <span class="keyword">new</span> THREE.FileLoader();</span><br><span class="line">        loader.load(filename, <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">            resolve(data);</span><br><span class="line">            <span class="comment">//console.log(data);</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="Lights">Lights</h3>
<p>光源是代码框架中结构较为简单的类型。逻辑上光源只表示场景空间中的某处存在一个发光的物体，它具有一定的发光强度，可以照亮场景中的其他物体；表现上在渲染出的场景中具有具体的形态，可能是一个灯泡模型，也可能是其他，带有自己的 Mesh 和相应的材质。</p>
<h4 id="总体功能-8">总体功能</h4>
<p>代码框架在光源部分提供了两个类型：<code>EmissiveMaterial</code> 和 <code>PointLight</code>。前者定义了一种特殊的材质，用来表现发光实体本身的视觉效果；后者定义了光源的具体数据，包括发光强度，使用什么样的 Mesh 表现它的形状等，同时保存了发光材质的引用。</p>
<h4 id="Light-ts-代码注释"><code>Light.ts</code> 代码注释</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Material &#125; <span class="keyword">from</span> <span class="string">&#x27;../materials/Material&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> LightCubeVertexShader <span class="keyword">from</span> <span class="string">&quot;../shaders/InternalShader/LightCubeVertexShader.glsl?raw&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> LightCubeFragmentShader <span class="keyword">from</span> <span class="string">&quot;../shaders/InternalShader/LightCubeFragmentShader.glsl?raw&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; vec3 &#125; <span class="keyword">from</span> <span class="string">&#x27;gl-matrix&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">EmissiveMaterial</span> <span class="keyword">extends</span> <span class="title">Material</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义光源的发光强度</span></span><br><span class="line">    intensity: <span class="built_in">number</span>;</span><br><span class="line">    <span class="comment">// 定义发光的颜色</span></span><br><span class="line">    color: vec3;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">lightIntensity: <span class="built_in">number</span>, lightColor: vec3</span>)</span> &#123;    </span><br><span class="line">        <span class="comment">// 构造材质实例，传入着色器源码和发光强度、颜色等参数</span></span><br><span class="line">        <span class="built_in">super</span>(&#123;</span><br><span class="line">            <span class="string">&#x27;uLigIntensity&#x27;</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;1f&#x27;</span>, <span class="attr">value</span>: lightIntensity &#125;,</span><br><span class="line">            <span class="string">&#x27;uLightColor&#x27;</span>: &#123; <span class="attr">type</span>: <span class="string">&#x27;3fv&#x27;</span>, <span class="attr">value</span>: lightColor &#125;</span><br><span class="line">        &#125;, [], LightCubeVertexShader, LightCubeFragmentShader);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.intensity = lightIntensity;</span><br><span class="line">        <span class="built_in">this</span>.color = lightColor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="PointLight-ts-代码注释"><code>PointLight.ts</code> 代码注释</h4>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Mesh &#125; <span class="keyword">from</span> <span class="string">&#x27;../objects/Mesh&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; EmissiveMaterial &#125; <span class="keyword">from</span> <span class="string">&#x27;./Light&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; vec3 &#125; <span class="keyword">from</span> <span class="string">&#x27;gl-matrix&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">PointLight</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates an instance of PointLight.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;float&#125;</span> </span>lightIntensity  The intensity of the PointLight.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;vec3f&#125;</span> </span>lightColor The color of the PointLight.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@memberof <span class="variable">PointLight</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义发光实体的网格体</span></span><br><span class="line">    mesh: Mesh;</span><br><span class="line">    <span class="comment">// 保存渲染该实体所需的材质</span></span><br><span class="line">    mat: EmissiveMaterial;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">lightIntensity: <span class="built_in">number</span>, lightColor: vec3</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 光源的形状默认是一个立方体</span></span><br><span class="line">        <span class="built_in">this</span>.mesh = Mesh.cube();</span><br><span class="line">        <span class="built_in">this</span>.mat = <span class="keyword">new</span> EmissiveMaterial(lightIntensity, lightColor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://vonbrank.github.io">Von Brank</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://vonbrank.github.io/archives/games-202-assignment-framework-analysis/">https://vonbrank.github.io/archives/games-202-assignment-framework-analysis/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://vonbrank.github.io" target="_blank">Von Brank</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%99%E7%A8%8B/">教程</a><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6/">计算机图形学</a></div><div class="post_share"><div class="social-share" data-image="https://cdn2.unrealengine.com/Unreal+Engine%2Fblog%2Fporsche-nvidia-and-epic-games-reveal-the-speed-of-light-for-porsche-911-speedster-concept%2FSpeed_of_Light_Hero_1_1920-1920x873-0006adad2a4df33615d426901e38ae89a7a5d25a.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/archives/unity-configurable-cursors-and-raycastable-ui/" title="Unity 可配置鼠标指针与 UI 射线检测"><img class="cover" src="https://gamedevbeginner.com/wp-content/uploads/MouseWorldPosition.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Unity 可配置鼠标指针与 UI 射线检测</div></div></a></div><div class="next-post pull-right"><a href="/archives/using-ts-checker-in-react-redux-js-project/" title="使用 TS-Check 针对 React/Redux 项目的渐进式静态检查指南"><img class="cover" src="https://res.cloudinary.com/practicaldev/image/fetch/s--Sr-QUSUn--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1jf8itjh1lracaaola8c.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">使用 TS-Check 针对 React/Redux 项目的渐进式静态检查指南</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/archives/cs231n-assignment1-knn/" title="CS231n | 课程作业 Assignment1 | K近邻算法 KNN"><img class="cover" src="https://z3.ax1x.com/2021/03/21/64GeH0.md.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-22</div><div class="title">CS231n | 课程作业 Assignment1 | K近邻算法 KNN</div></div></a></div><div><a href="/archives/cs231n-preparation/" title="CS231n | 先决条件 Preparation"><img class="cover" src="https://z3.ax1x.com/2021/03/21/64GeH0.md.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-21</div><div class="title">CS231n | 先决条件 Preparation</div></div></a></div><div><a href="/archives/deploy-anaconda-on-windows/" title="Anaconda部署与使用指南（Windows）"><img class="cover" src="https://s3.ax1x.com/2021/03/13/6w8xDP.md.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-13</div><div class="title">Anaconda部署与使用指南（Windows）</div></div></a></div><div><a href="/archives/hit-cs31106-explanation-01/" title="C语言答疑-01"><img class="cover" src="https://s2.loli.net/2022/01/08/aHnR1gNZI75hTd2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-28</div><div class="title">C语言答疑-01</div></div></a></div><div><a href="/archives/hit-cs31106-explanation-02/" title="C语言答疑-02"><img class="cover" src="https://s2.loli.net/2022/01/08/aHnR1gNZI75hTd2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-07</div><div class="title">C语言答疑-02</div></div></a></div><div><a href="/archives/hit-cs31106-explanation-03/" title="C语言答疑-03"><img class="cover" src="https://s2.loli.net/2022/01/08/aHnR1gNZI75hTd2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-12</div><div class="title">C语言答疑-03</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://vonbrank-images.oss-cn-hangzhou.aliyuncs.com/20230826-Blog-Image/system/vonbrank-profile.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Von Brank</div><div class="author-info__description">Von Brank, a student from Harbin Institute of Technology, who likes coding, video editing, designing, gaming, and more.</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">53</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">27</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">22</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/vonbrank"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/vonbrank" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:vonbrank@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="https://twitter.com/Von_Brank" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a><a class="social-icon" href="https://steamcommunity.com/id/vonbrank/" target="_blank" title="Steam"><i class="fab fa-steam"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#WebGL-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%E5%9B%9E%E9%A1%BE"><span class="toc-number">1.</span> <span class="toc-text">WebGL 使用方法回顾</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E5%AE%98%E6%96%B9%E4%BB%A3%E7%A0%81%E6%A1%86%E6%9E%B6%E5%BC%95%E5%85%A5%E7%8E%B0%E4%BB%A3%E5%89%8D%E7%AB%AF%E5%BC%80%E5%8F%91%E6%B5%81%E7%9A%84%E8%AF%B4%E6%98%8E"><span class="toc-number">2.</span> <span class="toc-text">将官方代码框架引入现代前端开发流的说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A-0-%E4%BB%A3%E7%A0%81%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3"><span class="toc-number">3.</span> <span class="toc-text">作业 0 代码框架详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GAMES-202-%E4%BD%9C%E4%B8%9A%E4%BB%A3%E7%A0%81%E6%A1%86%E6%9E%B6%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.</span> <span class="toc-text">GAMES 202 作业代码框架体系结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GAMES-202-Engine"><span class="toc-number">3.2.</span> <span class="toc-text">GAMES 202 Engine</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E5%8A%9F%E8%83%BD"><span class="toc-number">3.2.1.</span> <span class="toc-text">总体功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#engine-ts-%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-number">3.2.2.</span> <span class="toc-text">engine.ts 代码注释</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Renderer"><span class="toc-number">3.3.</span> <span class="toc-text">Renderer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E5%8A%9F%E8%83%BD-2"><span class="toc-number">3.3.1.</span> <span class="toc-text">总体功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#WebGLRenderer-ts-%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-number">3.3.2.</span> <span class="toc-text">WebGLRenderer.ts 代码注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MeshRender-ts-%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-number">3.3.3.</span> <span class="toc-text">MeshRender.ts 代码注释</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mesh"><span class="toc-number">3.4.</span> <span class="toc-text">Mesh</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E5%8A%9F%E8%83%BD-3"><span class="toc-number">3.4.1.</span> <span class="toc-text">总体功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mesh-ts-%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-number">3.4.2.</span> <span class="toc-text">Mesh.ts 代码注释</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Material"><span class="toc-number">3.5.</span> <span class="toc-text">Material</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E5%8A%9F%E8%83%BD-4"><span class="toc-number">3.5.1.</span> <span class="toc-text">总体功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Material-ts-%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-number">3.5.2.</span> <span class="toc-text">Material.ts 代码注释</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shader"><span class="toc-number">3.6.</span> <span class="toc-text">Shader</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E5%8A%9F%E8%83%BD-5"><span class="toc-number">3.6.1.</span> <span class="toc-text">总体功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Shader-ts-%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-number">3.6.2.</span> <span class="toc-text">Shader.ts 代码注释</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Texture"><span class="toc-number">3.7.</span> <span class="toc-text">Texture</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E5%8A%9F%E8%83%BD-6"><span class="toc-number">3.7.1.</span> <span class="toc-text">总体功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Texture-ts-%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-number">3.7.2.</span> <span class="toc-text">Texture.ts 代码注释</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Loader"><span class="toc-number">3.8.</span> <span class="toc-text">Loader</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E5%8A%9F%E8%83%BD-7"><span class="toc-number">3.8.1.</span> <span class="toc-text">总体功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loadOBJ-ts"><span class="toc-number">3.8.2.</span> <span class="toc-text">loadOBJ.ts</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#loadShader-ts-%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-number">3.8.3.</span> <span class="toc-text">loadShader.ts 代码注释</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lights"><span class="toc-number">3.9.</span> <span class="toc-text">Lights</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E5%8A%9F%E8%83%BD-8"><span class="toc-number">3.9.1.</span> <span class="toc-text">总体功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Light-ts-%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-number">3.9.2.</span> <span class="toc-text">Light.ts 代码注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PointLight-ts-%E4%BB%A3%E7%A0%81%E6%B3%A8%E9%87%8A"><span class="toc-number">3.9.3.</span> <span class="toc-text">PointLight.ts 代码注释</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/archives/unity-configurable-cursors-and-raycastable-ui/" title="Unity 可配置鼠标指针与 UI 射线检测"><img src="https://gamedevbeginner.com/wp-content/uploads/MouseWorldPosition.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Unity 可配置鼠标指针与 UI 射线检测"/></a><div class="content"><a class="title" href="/archives/unity-configurable-cursors-and-raycastable-ui/" title="Unity 可配置鼠标指针与 UI 射线检测">Unity 可配置鼠标指针与 UI 射线检测</a><time datetime="2023-08-25T11:48:19.000Z" title="发表于 2023-08-25 19:48:19">2023-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/games-202-assignment-framework-analysis/" title="GAMES 202 作业代码框架剖析"><img src="https://cdn2.unrealengine.com/Unreal+Engine%2Fblog%2Fporsche-nvidia-and-epic-games-reveal-the-speed-of-light-for-porsche-911-speedster-concept%2FSpeed_of_Light_Hero_1_1920-1920x873-0006adad2a4df33615d426901e38ae89a7a5d25a.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GAMES 202 作业代码框架剖析"/></a><div class="content"><a class="title" href="/archives/games-202-assignment-framework-analysis/" title="GAMES 202 作业代码框架剖析">GAMES 202 作业代码框架剖析</a><time datetime="2023-08-23T07:30:36.000Z" title="发表于 2023-08-23 15:30:36">2023-08-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/using-ts-checker-in-react-redux-js-project/" title="使用 TS-Check 针对 React/Redux 项目的渐进式静态检查指南"><img src="https://res.cloudinary.com/practicaldev/image/fetch/s--Sr-QUSUn--/c_imagga_scale,f_auto,fl_progressive,h_420,q_auto,w_1000/https://dev-to-uploads.s3.amazonaws.com/uploads/articles/1jf8itjh1lracaaola8c.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用 TS-Check 针对 React/Redux 项目的渐进式静态检查指南"/></a><div class="content"><a class="title" href="/archives/using-ts-checker-in-react-redux-js-project/" title="使用 TS-Check 针对 React/Redux 项目的渐进式静态检查指南">使用 TS-Check 针对 React/Redux 项目的渐进式静态检查指南</a><time datetime="2022-12-17T07:25:08.000Z" title="发表于 2022-12-17 15:25:08">2022-12-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/hit-software-construction-review-lecture-03/" title="HIT-软件构造 | 考前讲座 Lecture 03"><img src="https://s2.loli.net/2022/05/01/pZiMB5ED7aHY3G4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HIT-软件构造 | 考前讲座 Lecture 03"/></a><div class="content"><a class="title" href="/archives/hit-software-construction-review-lecture-03/" title="HIT-软件构造 | 考前讲座 Lecture 03">HIT-软件构造 | 考前讲座 Lecture 03</a><time datetime="2022-06-08T09:35:48.000Z" title="发表于 2022-06-08 17:35:48">2022-06-08</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/hit-software-construction-java-functional-programming/" title="HIT-软件构造 | Java 函数式编程"><img src="https://s2.loli.net/2022/05/01/pZiMB5ED7aHY3G4.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="HIT-软件构造 | Java 函数式编程"/></a><div class="content"><a class="title" href="/archives/hit-software-construction-java-functional-programming/" title="HIT-软件构造 | Java 函数式编程">HIT-软件构造 | Java 函数式编程</a><time datetime="2022-06-01T13:38:57.000Z" title="发表于 2022-06-01 21:38:57">2022-06-01</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn2.unrealengine.com/Unreal+Engine%2Fblog%2Fporsche-nvidia-and-epic-games-reveal-the-speed-of-light-for-porsche-911-speedster-concept%2FSpeed_of_Light_Hero_1_1920-1920x873-0006adad2a4df33615d426901e38ae89a7a5d25a.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Von Brank</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>